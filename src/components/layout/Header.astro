---
import MobileMenu from './MobileMenu.astro';
import LegislativeDayTracker from './LegislativeDayTracker.astro';

const navLinks = [
  { href: '/bills', label: 'Bills' },
  { href: '/not-bills', label: 'Not Bills' },
  { href: '/omnibus', label: 'Omnibus' },
  { href: '/rules', label: 'Rules' },
  { href: '/today', label: 'Today' },
  { href: '/votechain', label: 'VoteChain' },
  { href: '/about', label: 'About' },
];

const toolsDropdown = [
  { href: '/swipe', label: 'Would You Pass It?' },
  { href: '/bracket', label: 'Absurdity Madness' },
  { href: '/quiz', label: 'Vocab Quiz' },
  { href: '/bingo', label: 'Bingo Cards' },
  { href: '/generator', label: 'Bill Generator' },
  { href: '/filibuster', label: 'Filibuster Simulator' },
  { href: '/marathon', label: 'Reading Marathon' },
  { href: '/pork-index', label: 'Pork Index' },
  { href: '/asmr', label: 'Legislation ASMR' },
  { href: '/cost-calculator', label: 'Cost Calculator' },
  { href: '/diff', label: 'Diff Tool' },
  { href: '/history', label: 'Hall of Infamy' },
  { href: '/lobbyists', label: 'K Street' },
  { href: '/calendar', label: 'Session Calendar' },
];

const currentPath = Astro.url.pathname;

function isActivePath(href: string) {
  if (href === '/') return currentPath === '/';
  return currentPath === href || currentPath.startsWith(`${href}/`);
}
---

<header class="sticky top-0 z-50 bg-navy-900" data-theme-fixed>
  <!-- Legislative Day Tracker -->
  <div class="text-center py-1.5 bg-navy-800 border-b border-navy-700">
    <LegislativeDayTracker />
  </div>

  <!-- Main nav -->
  <nav
    class="mx-auto flex h-14 max-w-7xl items-center justify-between px-3 min-[375px]:px-4 sm:h-16"
  >
    <!-- Logo / site name -->
    <a href="/" class="group flex items-center gap-2 min-[375px]:gap-3">
      <!-- Inline official seal SVG -->
      <svg
        class="h-7 w-7 shrink-0 text-gold-500 min-[375px]:h-8 min-[375px]:w-8"
        viewBox="0 0 64 64"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <circle cx="32" cy="32" r="30" stroke="currentColor" stroke-width="2"></circle>
        <circle cx="32" cy="32" r="24" stroke="currentColor" stroke-width="1.5"></circle>
        <circle cx="32" cy="32" r="18" stroke="currentColor" stroke-width="1" stroke-dasharray="3 2"
        ></circle>
	        <text
	          x="32"
	          y="30"
	          text-anchor="middle"
	          font-size="8"
	          font-weight="700"
	          fill="currentColor"
	          font-family="serif">ABSURDITY</text
	        >
	        <text
	          x="32"
	          y="42"
	          text-anchor="middle"
	          font-size="8"
	          fill="currentColor"
	          font-family="serif"
	          letter-spacing="2">INDEX</text
	        >
        <!-- Stars at cardinal points -->
        <circle cx="32" cy="4" r="1.5" fill="currentColor"></circle>
        <circle cx="32" cy="60" r="1.5" fill="currentColor"></circle>
        <circle cx="4" cy="32" r="1.5" fill="currentColor"></circle>
        <circle cx="60" cy="32" r="1.5" fill="currentColor"></circle>
      </svg>
      <span
        class="font-serif font-bold text-sm text-gold-400 transition-colors group-hover:text-gold-300 min-[375px]:text-base sm:text-xl"
      >
        ABSURDITY INDEXâ„¢
      </span>
    </a>

    <!-- Desktop nav links -->
    <ul class="hidden md:flex items-center gap-6">
      {
        navLinks.map(({ href, label }) => (
          <li>
            <a
              href={href}
              aria-current={isActivePath(href) ? 'page' : undefined}
              class:list={[
                'font-sans text-sm tracking-wide uppercase transition-colors',
                isActivePath(href) ? 'text-gold-200' : 'text-gold-400 hover:text-gold-300',
              ]}
            >
              {label}
            </a>
          </li>
        ))
      }
      <!-- Tools dropdown -->
      <li id="tools-menu-container" class="relative">
        <button
          id="tools-menu-button"
          class:list={[
            'inline-flex items-center gap-1.5 rounded-md border px-2.5 py-1.5 font-sans text-sm font-semibold tracking-wide uppercase transition-all focus:outline-none focus:ring-2 focus:ring-gold-400',
            toolsDropdown.some((item) => isActivePath(item.href))
              ? 'border-gold-500/60 bg-navy-800 text-gold-200'
              : 'border-transparent text-gold-400 hover:border-gold-500/40 hover:bg-navy-800 hover:text-gold-300',
          ]}
          aria-haspopup="true"
          aria-expanded="false"
          aria-controls="tools-menu"
        >
          Tools
          <svg
            id="tools-menu-chevron"
            class="w-3 h-3 transition-transform"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <ul
          id="tools-menu"
          class="absolute top-full right-0 mt-0 z-50 hidden w-64 overflow-hidden rounded-xl border border-gold-500/30 bg-navy-900/95 p-2 shadow-2xl backdrop-blur-sm"
          role="menu"
          aria-labelledby="tools-menu-button"
        >
          <li
            role="presentation"
            class="px-3 pb-2 pt-1 text-[10px] font-sans font-semibold uppercase tracking-[0.18em] text-gold-500/80"
          >
            Tools
          </li>
          {
            toolsDropdown.map(({ href, label }) => (
              <li>
                <a
                  href={href}
                  role="menuitem"
                  aria-current={isActivePath(href) ? 'page' : undefined}
                  class:list={[
                    'group flex items-center justify-between rounded-lg px-3 py-2.5 text-sm font-sans transition-colors',
                    isActivePath(href)
                      ? 'border border-gold-500/40 bg-gold-500/20 text-gold-200'
                      : 'border border-transparent text-gold-300 hover:border-gold-500/30 hover:bg-navy-800 hover:text-gold-200',
                  ]}
                >
                  <span>{label}</span>
                  <svg
                    class="h-3.5 w-3.5 text-gold-500/60 transition-transform group-hover:translate-x-0.5"
                    viewBox="0 0 20 20"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    aria-hidden="true"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 5l5 5-5 5" />
                  </svg>
                </a>
              </li>
            ))
          }
        </ul>
      </li>
    </ul>

    <!-- Utility icons -->
    <div class="flex items-center gap-1.5 min-[375px]:gap-2 sm:gap-3">
      <!-- Founding Documents -->
      <button
        id="founding-docs-trigger"
        class="hidden rounded-md p-2 text-gold-400 transition-colors hover:bg-navy-800 hover:text-gold-300 focus:outline-none focus:ring-2 focus:ring-gold-400 sm:inline-flex"
        aria-label="Founding Documents"
        title="Constitution & Bill of Rights"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"></path>
          <path d="M19 17V5a2 2 0 0 0-2-2H4"></path>
          <path d="M15 8h-5"></path>
          <path d="M15 12h-5"></path>
        </svg>
      </button>

      <!-- Search icon -->
      <a
        href="/search"
        class:list={[
          'hidden rounded-md p-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-gold-400 min-[320px]:inline-flex min-[375px]:p-2',
          isActivePath('/search')
            ? 'bg-navy-800 text-gold-200'
            : 'text-gold-400 hover:bg-navy-800 hover:text-gold-300',
        ]}
        aria-label="Search"
        title="Search bills"
      >
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35" stroke-linecap="round"></path>
        </svg>
      </a>

      <!-- Mobile hamburger -->
      <button
        id="mobile-menu-toggle"
        class="inline-flex items-center gap-1.5 rounded-md border border-navy-700 px-2 py-1.5 text-gold-300 transition-colors hover:border-gold-500 hover:text-gold-200 focus:outline-none focus:ring-2 focus:ring-gold-400 min-[375px]:px-2.5 min-[375px]:py-2 md:hidden"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
        <span class="hidden font-sans text-xs uppercase tracking-wider min-[375px]:inline"
          >Menu</span
        >
      </button>
    </div>
  </nav>

  <hr class="gold-rule !my-0" />
</header>

<MobileMenu navLinks={navLinks} toolsLinks={toolsDropdown} currentPath={currentPath} />

<script>
  const toolsMenuContainer = document.getElementById('tools-menu-container');
  const toolsMenuButton = document.getElementById('tools-menu-button');
  const toolsMenu = document.getElementById('tools-menu');
  const toolsMenuChevron = document.getElementById('tools-menu-chevron');
  const toolsMenuItems = toolsMenu
    ? Array.from(toolsMenu.querySelectorAll<HTMLElement>('a[role=\"menuitem\"]'))
    : [];
  let toolsCloseTimeoutId: number | null = null;

  function clearToolsCloseTimeout() {
    if (toolsCloseTimeoutId !== null) {
      window.clearTimeout(toolsCloseTimeoutId);
      toolsCloseTimeoutId = null;
    }
  }

  function scheduleToolsMenuClose(delay = 140) {
    clearToolsCloseTimeout();
    toolsCloseTimeoutId = window.setTimeout(() => closeToolsMenu(), delay);
  }

  function isToolsMenuOpen() {
    return !!toolsMenu && !toolsMenu.classList.contains('hidden');
  }

  function openToolsMenu(focusFirstItem = false) {
    if (!toolsMenu || !toolsMenuButton) return;
    clearToolsCloseTimeout();
    toolsMenu.classList.remove('hidden');
    toolsMenuButton.setAttribute('aria-expanded', 'true');
    toolsMenuChevron?.classList.add('rotate-180');
    if (focusFirstItem && toolsMenuItems.length > 0) {
      toolsMenuItems[0].focus();
    }
  }

  function closeToolsMenu(focusButton = false) {
    if (!toolsMenu || !toolsMenuButton) return;
    clearToolsCloseTimeout();
    toolsMenu.classList.add('hidden');
    toolsMenuButton.setAttribute('aria-expanded', 'false');
    toolsMenuChevron?.classList.remove('rotate-180');
    if (focusButton) {
      toolsMenuButton.focus();
    }
  }

  function toggleToolsMenu() {
    if (isToolsMenuOpen()) {
      closeToolsMenu();
    } else {
      openToolsMenu();
    }
  }

  toolsMenuButton?.addEventListener('click', (event: MouseEvent) => {
    event.preventDefault();
    toggleToolsMenu();
  });

  toolsMenuButton?.addEventListener('keydown', (event: KeyboardEvent) => {
    if (event.key === 'ArrowDown' || event.key === 'Enter' || event.key === ' ') {
      event.preventDefault();
      openToolsMenu(true);
    }
    if (event.key === 'Escape') {
      closeToolsMenu();
    }
  });

  toolsMenu?.addEventListener('keydown', (event: KeyboardEvent) => {
    if (toolsMenuItems.length === 0) return;

    const currentIndex = toolsMenuItems.findIndex((item) => item === document.activeElement);
    if (event.key === 'Escape') {
      event.preventDefault();
      closeToolsMenu(true);
      return;
    }

    if (event.key === 'ArrowDown') {
      event.preventDefault();
      const nextIndex = currentIndex < 0 ? 0 : (currentIndex + 1) % toolsMenuItems.length;
      toolsMenuItems[nextIndex].focus();
    }

    if (event.key === 'ArrowUp') {
      event.preventDefault();
      const prevIndex = currentIndex <= 0 ? toolsMenuItems.length - 1 : currentIndex - 1;
      toolsMenuItems[prevIndex].focus();
    }

    if (event.key === 'Home') {
      event.preventDefault();
      toolsMenuItems[0].focus();
    }

    if (event.key === 'End') {
      event.preventDefault();
      toolsMenuItems[toolsMenuItems.length - 1].focus();
    }
  });

  toolsMenuItems.forEach((item) => {
    item.addEventListener('click', () => closeToolsMenu());
  });

  document.addEventListener('click', (event: MouseEvent) => {
    if (!toolsMenuContainer) return;
    const targetNode = event.target instanceof Node ? event.target : null;
    if (targetNode && !toolsMenuContainer.contains(targetNode)) {
      closeToolsMenu();
    }
  });

  if (window.matchMedia('(hover: hover)').matches) {
    toolsMenuContainer?.addEventListener('mouseenter', () => {
      clearToolsCloseTimeout();
      openToolsMenu();
    });
    toolsMenuContainer?.addEventListener('mouseleave', () => {
      scheduleToolsMenuClose(160);
    });
  }

  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileMenuPanel = document.getElementById('mobile-menu-panel');
  const mobileMenuClose = document.getElementById('mobile-menu-close');
  const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
  const mobileMenuLinks = Array.from(document.querySelectorAll('[data-mobile-link]'));
  const mobileSectionToggles = Array.from(
    document.querySelectorAll('[data-mobile-section-toggle]'),
  );

  let isMobileMenuOpen = false;
  let mobileCloseTimeoutId: number | null = null;
  let previousFocusedElement: HTMLElement | null = null;

  function clearMobileCloseTimeout() {
    if (mobileCloseTimeoutId !== null) {
      window.clearTimeout(mobileCloseTimeoutId);
      mobileCloseTimeoutId = null;
    }
  }

  function lockDocumentScroll() {
    document.documentElement.classList.add('overflow-hidden');
    document.body.classList.add('overflow-hidden');
  }

  function unlockDocumentScroll() {
    document.documentElement.classList.remove('overflow-hidden');
    document.body.classList.remove('overflow-hidden');
  }

  function getMobileFocusableElements(): HTMLElement[] {
    if (!mobileMenuPanel) return [];

    const selector = 'a[href], button:not([disabled]), [tabindex]:not([tabindex=\"-1\"])';
    return Array.from(mobileMenuPanel.querySelectorAll(selector)).filter(
      (element): element is HTMLElement => {
        if (!(element instanceof HTMLElement)) return false;
        if (element.hidden || element.closest('[hidden]')) return false;
        const style = window.getComputedStyle(element);
        return style.display !== 'none' && style.visibility !== 'hidden';
      },
    );
  }

  function setMobileSectionState(sectionName: string, expanded: boolean) {
    const sectionToggle = document.querySelector(`[data-mobile-section-toggle=\"${sectionName}\"]`);
    const section = document.querySelector(`[data-mobile-section=\"${sectionName}\"]`);
    const icon = document.querySelector(`[data-mobile-section-icon=\"${sectionName}\"]`);

    if (!sectionToggle || !section) return;

    sectionToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    section.classList.toggle('hidden', !expanded);
    icon?.classList.toggle('rotate-180', expanded);
  }

  function initializeMobileSections() {
    const sectionNames = mobileSectionToggles
      .map((sectionToggle) => sectionToggle.getAttribute('data-mobile-section-toggle'))
      .filter((sectionName): sectionName is string => Boolean(sectionName));

    const expandedSections = sectionNames.filter((sectionName) => {
      const sectionToggle = document.querySelector(
        `[data-mobile-section-toggle=\"${sectionName}\"]`,
      );
      return sectionToggle?.getAttribute('aria-expanded') === 'true';
    });

    if (expandedSections.length > 1) {
      expandedSections.slice(1).forEach((sectionName) => setMobileSectionState(sectionName, false));
    }

    mobileSectionToggles.forEach((sectionToggle) => {
      const sectionName = sectionToggle.getAttribute('data-mobile-section-toggle');
      if (!sectionName) return;

      const expanded = sectionToggle.getAttribute('aria-expanded') === 'true';
      setMobileSectionState(sectionName, expanded);

      sectionToggle.addEventListener('click', () => {
        const isExpanded = sectionToggle.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          setMobileSectionState(sectionName, false);
          return;
        }

        sectionNames.forEach((name) => {
          if (name !== sectionName) {
            setMobileSectionState(name, false);
          }
        });
        setMobileSectionState(sectionName, true);
      });
    });
  }

  function finishMobileMenuClose(restoreFocus = true) {
    if (!mobileMenu || !mobileMenuPanel) return;

    mobileMenu.classList.add('hidden');
    mobileMenu.setAttribute('aria-hidden', 'true');
    mobileMenuToggle?.setAttribute('aria-expanded', 'false');
    mobileMenuToggle?.setAttribute('aria-label', 'Open menu');
    unlockDocumentScroll();

    if (
      restoreFocus &&
      previousFocusedElement &&
      previousFocusedElement instanceof HTMLElement &&
      previousFocusedElement.isConnected
    ) {
      previousFocusedElement.focus();
    }

    previousFocusedElement = null;
    clearMobileCloseTimeout();
  }

  function closeMobileMenu(options: { restoreFocus?: boolean } = {}) {
    if (!mobileMenu || !mobileMenuPanel || !isMobileMenuOpen) return;

    const { restoreFocus = true } = options;
    isMobileMenuOpen = false;
    document.removeEventListener('keydown', handleMobileMenuKeydown);
    mobileMenuPanel.classList.add('translate-x-full');

    const onTransitionEnd = (event: TransitionEvent) => {
      if (event.target !== mobileMenuPanel) return;
      finishMobileMenuClose(restoreFocus);
    };

    mobileMenuPanel.addEventListener('transitionend', onTransitionEnd, { once: true });
    clearMobileCloseTimeout();
    mobileCloseTimeoutId = window.setTimeout(() => finishMobileMenuClose(restoreFocus), 360);
  }

  function openMobileMenu() {
    if (!mobileMenu || !mobileMenuPanel || isMobileMenuOpen) return;

    clearMobileCloseTimeout();
    isMobileMenuOpen = true;
    closeToolsMenu();
    previousFocusedElement =
      document.activeElement instanceof HTMLElement ? document.activeElement : null;

    mobileMenu.classList.remove('hidden');
    mobileMenu.setAttribute('aria-hidden', 'false');
    mobileMenuToggle?.setAttribute('aria-expanded', 'true');
    mobileMenuToggle?.setAttribute('aria-label', 'Close menu');
    lockDocumentScroll();
    document.addEventListener('keydown', handleMobileMenuKeydown);

    requestAnimationFrame(() => {
      mobileMenuPanel.classList.remove('translate-x-full');
      const [firstFocusable] = getMobileFocusableElements();
      (mobileMenuClose || firstFocusable)?.focus();
    });
  }

  function handleMobileMenuKeydown(event: KeyboardEvent) {
    if (!isMobileMenuOpen) return;

    if (event.key === 'Escape') {
      event.preventDefault();
      closeMobileMenu();
      return;
    }

    if (event.key !== 'Tab') return;

    const focusableElements = getMobileFocusableElements();
    if (focusableElements.length === 0) return;

    const first = focusableElements[0];
    const last = focusableElements[focusableElements.length - 1];

    if (event.shiftKey && document.activeElement === first) {
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last) {
      event.preventDefault();
      first.focus();
    }
  }

  mobileMenuToggle?.addEventListener('click', openMobileMenu);
  mobileMenuClose?.addEventListener('click', () => closeMobileMenu());
  mobileMenuBackdrop?.addEventListener('click', () => closeMobileMenu());

  mobileMenuLinks.forEach((link) => {
    link.addEventListener('click', () => closeMobileMenu({ restoreFocus: false }));
  });

  const desktopMediaQuery = window.matchMedia('(min-width: 768px)');
  const handleDesktopMediaChange = (event: MediaQueryListEvent) => {
    if (event.matches) {
      closeMobileMenu({ restoreFocus: false });
    }
  };

  if (typeof desktopMediaQuery.addEventListener === 'function') {
    desktopMediaQuery.addEventListener('change', handleDesktopMediaChange);
  } else {
    // Older Safari: `addListener` / `removeListener`.
    const legacyMq = desktopMediaQuery as unknown as {
      addListener?: (cb: (event: MediaQueryListEvent) => void) => void;
    };
    legacyMq.addListener?.(handleDesktopMediaChange);
  }

  initializeMobileSections();

  // Founding Documents trigger
  const foundingDocsTrigger = document.getElementById('founding-docs-trigger');
  foundingDocsTrigger?.addEventListener('click', () => {
    document.dispatchEvent(new CustomEvent('open-founding-docs'));
  });

  document.addEventListener('keydown', (event: KeyboardEvent) => {
    if (event.key === 'Escape' && isToolsMenuOpen()) {
      closeToolsMenu(true);
    }
  });
</script>
