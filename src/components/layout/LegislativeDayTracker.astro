---
/**
 * LegislativeDayTracker - Shows the absurdity of legislative days vs calendar days
 *
 * Displays current legislative day status for House/Senate, highlighting
 * how a single "legislative day" can span multiple calendar days.
 */

import sessionData from '../../data/session-status.json';

// Calculate days elapsed since a date
function daysSince(dateStr: string): number {
  const start = new Date(dateStr);
  const now = new Date();
  const diffTime = now.getTime() - start.getTime();
  return Math.floor(diffTime / (1000 * 60 * 60 * 24));
}

const house = sessionData.house;
const senate = sessionData.senate;

// Calculate current calendar days for this legislative day
const houseCalendarDays = daysSince(house.currentLegislativeDay.startDate);
const senateCalendarDays = daysSince(senate.currentLegislativeDay.startDate);

// Pick the more dramatic example to feature
const featured =
  houseCalendarDays >= senateCalendarDays
    ? { chamber: 'House', data: house, calendarDays: houseCalendarDays }
    : { chamber: 'Senate', data: senate, calendarDays: senateCalendarDays };

const statusMeta =
  featured.data.status === 'session'
    ? {
        badgeClasses: 'bg-green-900/50 text-green-300',
        dotClass: 'bg-green-400',
        label: 'In Session',
      }
    : featured.data.status === 'recess'
      ? {
          badgeClasses: 'bg-yellow-900/50 text-yellow-300',
          dotClass: 'bg-yellow-400',
          label: 'Recess',
        }
      : {
          badgeClasses: 'bg-red-900/50 text-red-300',
          dotClass: 'bg-red-400',
          label: 'Adjourned',
        };

// The "day of week" that's been going on
const legislativeDayOfWeek = featured.data.currentLegislativeDay.startDayOfWeek;
---

<div class="legislative-day-tracker">
  <!-- Visual calendar comparison -->
  <div
    class="tracker-compact flex flex-wrap items-center justify-center gap-x-2 gap-y-1 text-[10px] font-mono min-[375px]:text-xs"
  >
    <!-- Your calendar -->
    <span class="hidden text-gold-300/80 min-[375px]:inline">
      Your week: <span class="text-gold-200">Mon → Tue → Wed</span>
    </span>

    <span class="hidden text-gold-600 min-[375px]:inline">•</span>

    <span class="text-gold-300/80 min-[375px]:hidden">
      Leg day: <span class="text-gold-400"
        >{legislativeDayOfWeek.slice(0, 3)} → {legislativeDayOfWeek.slice(0, 3)}</span
      >
      <span class="font-bold text-gold-500"> ({featured.calendarDays}d)</span>
    </span>

    <!-- Congress calendar - show both chambers briefly -->
    <span class="hidden text-gold-300/80 min-[375px]:inline">
      <span style="color: #60A5FA;">House</span>/<span style="color: #A78BFA;">Senate</span>:
      <span class="text-gold-400"
        >{legislativeDayOfWeek.slice(0, 3)} → {legislativeDayOfWeek.slice(0, 3)} → {
          legislativeDayOfWeek.slice(0, 3)
        }</span
      >
      <span class="text-gold-500 font-bold">({featured.calendarDays}d)</span>
    </span>

    <!-- Status badge -->
    <span
      class:list={[
        'inline-flex items-center gap-1 rounded px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wide',
        statusMeta.badgeClasses,
      ]}
    >
      <span class:list={['h-1.5 w-1.5 rounded-full', statusMeta.dotClass]} aria-hidden="true"
      ></span>
      {statusMeta.label}
    </span>

    <!-- Info button -->
    <button
      class="tracker-info-btn text-gold-400/70 hover:text-gold-300 transition-colors"
      aria-label="What is a legislative day?"
      title="What is a legislative day?"
    >
      <svg
        class="w-3.5 h-3.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v-4M12 8h.01" stroke-linecap="round"></path>
      </svg>
    </button>
  </div>
</div>

<!-- Popover for explanation -->
<div
  id="legislative-day-popover"
  class="hidden fixed z-[100] bg-navy-800 border border-navy-600 rounded-lg shadow-2xl p-4 max-w-sm text-sm"
  role="tooltip"
>
  <div class="flex items-start justify-between gap-2 mb-3">
    <h3 class="font-serif font-bold text-gold-400">What is a "Legislative Day"?</h3>
    <button id="close-leg-day-popover" class="text-cream-500 hover:text-gold-400">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <div class="space-y-2 text-cream-300">
    <p>
      A <strong class="text-gold-300">legislative day</strong> only ends when a chamber formally
      <em>adjourns</em>. If they <em>recess</em> instead, it's still the same "day" — even if weeks pass.
    </p>

    <p class="text-xs text-cream-400">
      <span style="color: #60A5FA;">House</span> and <span style="color: #A78BFA;">Senate</span>
      each track their own legislative days independently, though both use similar rules.
    </p>

    <div class="bg-navy-900/50 rounded p-2 mt-2">
      <p class="text-xs text-cream-400 mb-1">Record holder:</p>
      <p class="text-gold-400 font-mono text-sm">162 calendar days</p>
      <p class="text-cream-500 text-xs">Senate "Monday" • Jan 3 – Jun 12, 1980</p>
    </div>

    <p class="text-xs text-cream-500 mt-2">
      This matters because many statutory deadlines use "days" without specifying calendar or
      legislative — letting Congress stretch them indefinitely.
    </p>
  </div>

  <a
    href="/bills/real-hres-5-119"
    class="inline-flex items-center gap-1 text-xs text-gold-400 hover:text-gold-300 mt-3"
  >
    Learn more about H.Res. 5
    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" d="M5 12h14M12 5l7 7-7 7"></path>
    </svg>
  </a>

  <!-- Arrow pointer -->
  <div
    class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-navy-800 border-l border-t border-navy-600 rotate-45"
  >
  </div>
</div>

<script>
  // Popover functionality
  const infoBtn = document.querySelector('.tracker-info-btn');
  const popover = document.getElementById('legislative-day-popover');
  const closeBtn = document.getElementById('close-leg-day-popover');

  function showPopover() {
    if (!infoBtn || !popover) return;

    const rect = infoBtn.getBoundingClientRect();
    const popoverWidth = 320;

    // Position below the button, centered
    let left = rect.left + rect.width / 2 - popoverWidth / 2;

    // Keep within viewport
    left = Math.max(16, Math.min(left, window.innerWidth - popoverWidth - 16));

    popover.style.top = `${rect.bottom + 12}px`;
    popover.style.left = `${left}px`;
    popover.style.width = `${popoverWidth}px`;

    // Adjust arrow position
    const arrow = popover.querySelector('.absolute.-top-2') as HTMLElement;
    if (arrow) {
      const arrowOffset = rect.left + rect.width / 2 - left;
      arrow.style.left = `${arrowOffset}px`;
      arrow.style.transform = 'translateX(-50%) rotate(45deg)';
    }

    popover.classList.remove('hidden');
  }

  function hidePopover() {
    popover?.classList.add('hidden');
  }

  infoBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (popover?.classList.contains('hidden')) {
      showPopover();
    } else {
      hidePopover();
    }
  });

  closeBtn?.addEventListener('click', hidePopover);

  // Close on click outside
  document.addEventListener('click', (e) => {
    if (!popover?.contains(e.target as Node) && e.target !== infoBtn) {
      hidePopover();
    }
  });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hidePopover();
  });
</script>

<style>
  .legislative-day-tracker {
    font-family: var(--font-sans);
  }
</style>
