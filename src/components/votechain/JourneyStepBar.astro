---
/**
 * JourneyStepBar — compact journey progress indicator for POC sub-pages.
 * Shows the 3-step VoteChain journey flow with the current step highlighted.
 * Reads localStorage state client-side to show completion status.
 *
 * Props:
 *   currentStep: 1 | 2 | 3  — which step this page represents
 */
interface Props {
  currentStep: 1 | 2 | 3;
}

import Icon from '../ui/Icon.astro';

const { currentStep } = Astro.props;

const steps = [
  { num: 1, label: 'Cast', href: '/votechain/poc/vote', icon: 'vote' },
  { num: 2, label: 'Verify', href: '/votechain/poc/verify', icon: 'shield' },
  { num: 3, label: 'Watch', href: '/votechain/poc/dashboard', icon: 'bar-chart' },
];
---

<div class="journey-bar bg-gradient-to-r from-navy-50 to-cream-50 border-b border-navy-200">
  <div class="max-w-5xl mx-auto px-4 py-2.5">
    <div class="flex items-center gap-1.5">
      <!-- Back to journey hub -->
      <a
        href="/votechain/poc"
        class="flex items-center gap-1 text-navy-500 hover:text-gold-600 transition-colors mr-2 shrink-0"
        title="Back to POC Journey"
      >
        <Icon name="arrow-left" class="text-current" size={14} />
        <span class="text-[10px] font-mono uppercase tracking-wider hidden sm:inline">Journey</span>
      </a>

      <div class="flex items-center gap-0 flex-1 justify-center">
        {steps.map((step, i) => (
          <>
            {/* Step pill */}
            <a
              href={step.href}
              class:list={[
                'journey-step flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold transition-all',
                step.num === currentStep
                  ? 'bg-navy-800 text-gold-300 shadow-sm'
                  : 'text-navy-500 hover:bg-navy-100 hover:text-navy-700',
              ]}
              data-journey-step={step.num}
            >
              <span
                class:list={[
                  'journey-dot w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold transition-all shrink-0',
                  step.num === currentStep
                    ? 'bg-gold-500 text-navy-900'
                    : 'bg-navy-200 text-navy-500',
                ]}
                data-journey-dot={step.num}
              >
                {step.num}
              </span>
              <span class="hidden sm:inline">{step.label}</span>
            </a>

            {/* Connector line */}
            {i < steps.length - 1 && (
              <div
                class="journey-connector w-6 sm:w-10 h-px bg-navy-200 mx-0.5 transition-colors"
                data-journey-connector={i + 1}
              />
            )}
          </>
        ))}
      </div>

      <!-- Completion badge (hidden, shown via JS) -->
      <div id="journey-bar-badge" class="hidden ml-2 shrink-0">
        <span class="inline-flex items-center gap-1 rounded-full bg-green-600/15 px-2.5 py-1 text-[10px] font-semibold text-green-700">
          <Icon name="check-circle" class="text-green-600" size={12} />
          <span class="hidden sm:inline">Complete</span>
        </span>
      </div>
    </div>
  </div>
</div>

<script>
  // Read POC state and update journey bar styling
  function updateJourneyBar() {
    const STORAGE_KEY = 'votechain_poc_state_v2';
    const RECEIPT_KEY = 'votechain_poc_last_receipt';

    let hasVoted = false;
    let hasReceipt = false;
    let hasTally = false;

    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const state = JSON.parse(raw);
        hasVoted = state.bb?.leaves?.length > 0;
        hasTally = !!state.tally;
      }
      hasReceipt = !!localStorage.getItem(RECEIPT_KEY);
    } catch { /* ignore */ }

    // Step completion: step 1 = voted, step 2 = has receipt (verified at least once), step 3 = tally
    const stepComplete = [hasVoted, hasReceipt, hasTally];

    // Update dots — completed steps get green check marks
    for (let i = 0; i < 3; i++) {
      const dot = document.querySelector(`[data-journey-dot="${i + 1}"]`);
      if (!dot) continue;

      if (stepComplete[i]) {
        dot.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;
        dot.classList.remove('bg-navy-200', 'text-navy-500', 'bg-gold-500', 'text-navy-900');
        dot.classList.add('bg-green-600', 'text-white');
      }
    }

    // Update connector lines — completed connectors go green
    for (let i = 0; i < 2; i++) {
      const conn = document.querySelector(`[data-journey-connector="${i + 1}"]`);
      if (!conn) continue;
      if (stepComplete[i]) {
        conn.classList.remove('bg-navy-200');
        conn.classList.add('bg-green-500');
      }
    }

    // Update step pills — completed non-current steps get subtle green
    for (let i = 0; i < 3; i++) {
      const pill = document.querySelector(`[data-journey-step="${i + 1}"]`) as HTMLElement;
      if (!pill) continue;
      const isCurrent = pill.classList.contains('bg-navy-800');
      if (stepComplete[i] && !isCurrent) {
        pill.classList.remove('text-navy-500');
        pill.classList.add('text-green-700');
      }
    }

    // Show completion badge if all 3 done
    if (stepComplete.every(Boolean)) {
      document.getElementById('journey-bar-badge')?.classList.remove('hidden');
    }
  }

  // Run on page load
  updateJourneyBar();
  // Re-run when state changes (e.g. tally published on dashboard)
  window.addEventListener('votechain:state-changed', updateJourneyBar);
</script>
