---
/**
 * AI Document Summarizer modal — shows pre-baked summaries at three
 * knowledge levels (ELI5, Plain Language, Technical). Scanning animation
 * on first open, knowledge-level slider.
 *
 * Props:
 *   triggerText  — button label (default "Too long? Summarize with AI")
 *   triggerSub   — subtext below button (default "1,525 lines → 60 seconds")
 *   scanLines    — 5 scanning-animation lines
 *
 * Named slots: eli5, plain, technical
 */
interface Props {
  triggerText?: string;
  triggerSub?: string;
  scanLines?: string[];
}

const {
  triggerText = 'Too long? Summarize with AI',
  triggerSub = '1,525 lines \u2192 60 seconds',
  scanLines = [
    'Reading document...',
    'Analyzing key concepts...',
    'Cross-referencing sections...',
    'Evaluating structure...',
    'Compiling summary...',
  ],
} = Astro.props;
---

<!-- AI Summarizer trigger (inline) -->
<div class="text-center my-6">
  <button id="ai-modal-trigger" class="ai-trigger">
    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/></svg>
    {triggerText}
  </button>
  <p class="font-serif text-navy-500 text-sm italic mt-2" set:html={triggerSub} />
</div>

<!-- AI Summarizer Modal -->
<div id="ai-modal-backdrop" class="ai-modal-backdrop" aria-hidden="true"></div>
<div id="ai-modal" class="ai-modal" role="dialog" aria-modal="true" aria-label="AI Document Summary" aria-hidden="true">
  <div class="ai-modal-panel">
    <div class="ai-modal-header">
      <div class="flex items-center gap-3">
        <div class="ai-icon-wrap">
          <svg class="w-5 h-5 text-gold-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/><path d="M20 3v4"/><path d="M22 5h-4"/></svg>
        </div>
        <p class="font-mono text-xs uppercase tracking-widest text-gold-400">AI Document Summarizer</p>
      </div>
      <button id="ai-modal-close" class="ai-modal-close" aria-label="Close summary">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>

    <div class="ai-modal-body">
      <!-- Scanning state -->
      <div id="ai-scanning" class="ai-scanning">
        <div class="ai-scan-lines font-mono text-sm text-navy-500 space-y-2 py-8">
          {scanLines.map((line, i) => (
            <p id={`scan-${i + 1}`} class="ai-scan-line opacity-0"><span class="ai-cursor">&#9608;</span> {line}</p>
          ))}
        </div>
      </div>

      <!-- Summary result -->
      <div id="ai-result" class="ai-result hidden">
        <div class="ai-slider-wrap mb-5">
          <div class="flex items-center justify-between mb-2">
            <span class="font-mono text-xs text-navy-500 uppercase tracking-wide">ELI5</span>
            <span id="ai-level-label" class="font-mono text-xs text-gold-600 font-bold uppercase tracking-wide">Plain Language</span>
            <span class="font-mono text-xs text-navy-500 uppercase tracking-wide">Technical</span>
          </div>
          <input id="ai-slider" type="range" min="0" max="2" step="1" value="1" class="ai-range-slider" aria-label="Summary complexity level" />
        </div>

        <div id="ai-level-0" class="ai-level hidden">
          <div class="ai-summary font-serif text-navy-800 text-[0.95rem] leading-relaxed">
            <slot name="eli5" />
          </div>
        </div>
        <div id="ai-level-1" class="ai-level">
          <div class="ai-summary font-serif text-navy-800 text-[0.95rem] leading-relaxed">
            <slot name="plain" />
          </div>
        </div>
        <div id="ai-level-2" class="ai-level hidden">
          <div class="ai-summary font-serif text-navy-800 text-[0.95rem] leading-relaxed">
            <slot name="technical" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style is:global>
  .ai-trigger {
    display: inline-flex; align-items: center; gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: var(--color-navy-900); color: var(--color-gold-400);
    font-family: var(--font-mono); font-size: 0.8125rem; font-weight: 600;
    letter-spacing: 0.05em;
    border: 2px solid var(--color-gold-500); border-radius: 0.5rem;
    cursor: pointer; transition: all 0.2s ease;
  }
  .ai-trigger:hover {
    background: var(--color-navy-800); border-color: var(--color-gold-400);
    box-shadow: 0 0 16px rgba(197, 165, 114, 0.2);
  }
  .ai-modal-backdrop {
    position: fixed; inset: 0; z-index: 60;
    background: rgba(10, 22, 40, 0.7); backdrop-filter: blur(4px);
    opacity: 0; visibility: hidden; transition: all 0.3s ease;
  }
  .ai-modal-backdrop.open { opacity: 1; visibility: visible; }
  .ai-modal {
    position: fixed; inset: 0; z-index: 61;
    display: flex; align-items: center; justify-content: center;
    padding: 1rem; pointer-events: none;
    opacity: 0; visibility: hidden; transition: all 0.3s ease;
  }
  .ai-modal.open { opacity: 1; visibility: visible; pointer-events: auto; }
  .ai-modal-panel {
    width: 100%; max-width: 720px; max-height: 85vh;
    display: flex; flex-direction: column;
    background: var(--color-parchment);
    border: 2px solid var(--color-gold-500); border-radius: 0.75rem;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.4);
    transform: translateY(20px) scale(0.97);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .ai-modal.open .ai-modal-panel { transform: translateY(0) scale(1); }
  .ai-modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.875rem 1.25rem; background: var(--color-navy-900);
    border-bottom: 2px solid var(--color-gold-500);
    border-radius: 0.625rem 0.625rem 0 0;
  }
  .ai-icon-wrap {
    display: flex; align-items: center; justify-content: center;
    width: 2rem; height: 2rem;
    background: rgba(197, 165, 114, 0.15); border-radius: 0.5rem; flex-shrink: 0;
  }
  .ai-modal-close {
    display: flex; align-items: center; justify-content: center;
    width: 2rem; height: 2rem; background: transparent;
    border: 1px solid rgba(197, 165, 114, 0.3); border-radius: 0.25rem;
    color: var(--color-gold-400); cursor: pointer; transition: all 0.2s ease;
  }
  .ai-modal-close:hover {
    background: rgba(197, 165, 114, 0.1);
    border-color: var(--color-gold-500); color: var(--color-gold-300);
  }
  .ai-modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
  .ai-scan-line { transition: opacity 0.3s ease; }
  .ai-cursor { color: var(--color-gold-500); animation: blink 0.8s step-end infinite; }
  @keyframes blink { 50% { opacity: 0; } }
  .ai-result { opacity: 0; transition: opacity 0.5s ease; }
  .ai-result.visible { opacity: 1; }
  .ai-summary ul { list-style-type: disc; }
  .ai-slider-wrap { padding: 0 0.25rem; }
  .ai-range-slider {
    -webkit-appearance: none; appearance: none;
    width: 100%; height: 6px; border-radius: 3px;
    background: linear-gradient(to right, var(--color-gold-300), var(--color-navy-600));
    outline: none; cursor: pointer;
  }
  .ai-range-slider::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none;
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--color-gold-500); border: 3px solid var(--color-navy-900);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25); cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .ai-range-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
  }
  .ai-range-slider::-moz-range-thumb {
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--color-gold-500); border: 3px solid var(--color-navy-900);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25); cursor: pointer;
  }
  .ai-level { transition: opacity 0.3s ease; }
  @media (max-width: 640px) {
    .ai-modal { padding: 0.5rem; }
    .ai-modal-panel { max-height: 90vh; }
    .ai-modal-body { padding: 1rem; }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    var trigger = document.getElementById('ai-modal-trigger');
    var backdrop = document.getElementById('ai-modal-backdrop');
    var modal = document.getElementById('ai-modal');
    var closeBtn = document.getElementById('ai-modal-close');
    var scanning = document.getElementById('ai-scanning');
    var result = document.getElementById('ai-result');
    var slider = document.getElementById('ai-slider');
    var levelLabel = document.getElementById('ai-level-label');
    var levelNames = ['ELI5', 'Plain Language', 'Technical'];
    var hasPlayed = false;

    if (!trigger || !modal || !backdrop || !scanning || !result) return;

    function showLevel(level) {
      for (var i = 0; i <= 2; i++) {
        var el = document.getElementById('ai-level-' + i);
        if (el) { i === level ? el.classList.remove('hidden') : el.classList.add('hidden'); }
      }
      if (levelLabel) levelLabel.textContent = levelNames[level];
    }

    if (slider) { slider.addEventListener('input', function() { showLevel(parseInt(this.value, 10)); }); }

    var isOpen = false;

    function setModalVisible(show) {
      var v = show ? 'visible' : 'hidden';
      var o = show ? '1' : '0';
      var pe = show ? 'auto' : 'none';
      modal.style.opacity = o; modal.style.visibility = v; modal.style.pointerEvents = pe;
      backdrop.style.opacity = o; backdrop.style.visibility = v;
      if (show) modal.querySelector('.ai-modal-panel').style.transform = 'translateY(0) scale(1)';
      else modal.querySelector('.ai-modal-panel').style.transform = '';
      backdrop.setAttribute('aria-hidden', show ? 'false' : 'true');
      modal.setAttribute('aria-hidden', show ? 'false' : 'true');
      document.body.style.overflow = show ? 'hidden' : '';
      isOpen = show;
    }

    function openModal() {
      setModalVisible(true);
      if (hasPlayed) { scanning.classList.add('hidden'); result.classList.remove('hidden'); result.style.opacity = '1'; return; }
      scanning.classList.remove('hidden'); result.classList.add('hidden'); result.style.opacity = '0';
      var delays = [0, 500, 1100, 1800, 2400];
      for (var i = 1; i <= 5; i++) { var el = document.getElementById('scan-' + i); if (el) el.style.opacity = '0'; }
      for (var j = 1; j <= 5; j++) { (function(id, d) { setTimeout(function() { var el = document.getElementById(id); if (el) el.style.opacity = '1'; }, d); })('scan-' + j, delays[j - 1]); }
      setTimeout(function() {
        scanning.classList.add('hidden'); result.classList.remove('hidden');
        showLevel(1); if (slider) slider.value = '1';
        requestAnimationFrame(function() { result.style.opacity = '1'; });
        hasPlayed = true;
      }, 3200);
    }

    function closeModal() {
      setModalVisible(false);
    }

    trigger.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && isOpen) closeModal(); });
  });
</script>
