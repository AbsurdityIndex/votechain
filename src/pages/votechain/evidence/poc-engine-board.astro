---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import MermaidClient from '../../../components/votechain/MermaidClient.astro';

---

<BaseLayout
  title="VoteChain POC Engine Architecture Board"
  description="Visual evidence board for the browser-based POC engine: module architecture, state schema, initialization, and voter journey."
  ogType="article"
  article={{
    publishedTime: '2026-02-12',
    modifiedTime: '2026-02-12',
    author: 'Absurdity Index',
    section: 'Engineering',
    tags: ['votechain', 'evidence', 'poc', 'diagram board'],
  }}
>
  <article class="board-canvas">
    <div class="page">
      <nav class="board-breadcrumb" aria-label="Breadcrumb">
        <a href="/votechain">VoteChain</a>
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        <span>Evidence Boards</span>
      </nav>
      <section class="hero">
        <div class="hero-top">
          <div class="hero-text">
            <p class="hero-kicker">VoteChain Evidence Board</p>
            <h1>POC Engine Architecture<br/>Diagram Board</h1>
            <p class="hero-subtitle">
              The browser-based proof-of-concept engine: 22 modules, a versioned state machine,
              and a complete voter journey from credential to tally — all running client-side.
            </p>
          </div>
          <div class="hero-verdict">
            <div class="verdict-ring">
              <svg viewBox="0 0 48 48" class="verdict-check"><path d="M14 24l8 8 12-14" fill="none" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="verdict-label">Engine Operational</div>
          </div>
        </div>
        <div class="top-metrics">
          <div class="metric">
            <div class="metric-label">Modules</div>
            <div class="metric-value">22</div>
          </div>
          <div class="metric">
            <div class="metric-label">State Version</div>
            <div class="metric-value">V2</div>
          </div>
          <div class="metric">
            <div class="metric-label">ECDSA Keys</div>
            <div class="metric-value">4</div>
          </div>
          <div class="metric">
            <div class="metric-label">Voter Roll</div>
            <div class="metric-value">50,000</div>
          </div>
          <div class="metric metric-pass">
            <div class="metric-label">Persistence</div>
            <div class="metric-value">localStorage</div>
          </div>
        </div>
      </section>

      <section class="panel-grid">

        <!-- Panel 1: Module Dependency Graph (span 12) -->
        <article class="panel panel-modules" data-panel="module-graph">
          <header class="panel-header">
            <p class="panel-kicker">Architecture</p>
            <h2>Module Dependency Graph</h2>
            <p>22 TypeScript modules organized in three layers: crypto primitives, core engine, and UI controllers.</p>
          </header>
          <pre data-language="mermaid">{`%% diagram-id: poc-module-graph
flowchart TB
  classDef hw fill:#e8d5b0,stroke:#a88b4a,stroke-width:1.5px
  classDef net fill:#dce7f5,stroke:#3a6fa0,stroke-width:1.5px
  classDef db fill:#f0ebe0,stroke:#8a6e36,stroke-width:1.5px
  classDef sec fill:#d9eee2,stroke:#2d8a5e,stroke-width:1.5px

  subgraph BROWSER["Boundary: Browser Runtime Layer"]
    direction TB
    BMETA["<img src='/votechain/evidence/icons/device-desktop.svg' width='24' height='24'/><b>Browser Boundary</b><br/><span style='font-size:0.8em;opacity:0.65'>Local voter browser runtime · Outbound HTTPS 443</span>"]:::net
    UI["<img src='/votechain/evidence/icons/device-desktop.svg' width='24' height='24'/><b>UI Controller Group</b><br/><span style='font-size:0.8em;opacity:0.65'>Dashboard, verify, lookup, trust, fraud, tally, manifest views · Drives operator and voter workflows</span>"]:::net
    JOURNEY["<img src='/votechain/evidence/icons/transfer.svg' width='24' height='24'/><b>Voter Journey Orchestrator</b><br/><span style='font-size:0.8em;opacity:0.65'>Session flow coordinator · Sequences credential, cast, challenge, and tally actions</span>"]:::net
    STATE["<img src='/votechain/evidence/icons/database.svg' width='24' height='24'/><b>State Store</b><br/><span style='font-size:0.8em;opacity:0.65'>PocStateV2 persistence adapter · Reads and writes election state to localStorage</span>"]:::db
    AUDIT["<img src='/votechain/evidence/icons/shield-check.svg' width='24' height='24'/><b>Audit Surface</b><br/><span style='font-size:0.8em;opacity:0.65'>Browser audit and verification views · Renders proofs, logs, and reconciliation outcomes</span>"]:::sec
  end

  subgraph CORE["Boundary: Core Engine Layer"]
    direction TB
    CMETA["<img src='/votechain/evidence/icons/server.svg' width='24' height='24'/><b>Core Boundary</b><br/><span style='font-size:0.8em;opacity:0.65'>In-browser domain service layer · Runs election logic in-process with no listening ports</span>"]:::net
    ENGINE["<img src='/votechain/evidence/icons/server.svg' width='24' height='24'/><b>Engine Core</b><br/><span style='font-size:0.8em;opacity:0.65'>State types, encoding, and orchestration modules · Applies deterministic election state transitions</span>"]:::net
    CRED["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>Credential Service</b><br/><span style='font-size:0.8em;opacity:0.65'>Credential issuance and verification · Validates blind signatures and enrollment records</span>"]:::sec
    CAST["<img src='/votechain/evidence/icons/transfer.svg' width='24' height='24'/><b>Ballot Cast Service</b><br/><span style='font-size:0.8em;opacity:0.65'>Cast and ballot envelope modules · Builds encrypted ballots and cast events</span>"]:::net
    BB["<img src='/votechain/evidence/icons/database.svg' width='24' height='24'/><b>Bulletin Board Service</b><br/><span style='font-size:0.8em;opacity:0.65'>Merkle and proof handling modules · Appends leaves and verifies inclusion proofs</span>"]:::db
    VCL["<img src='/votechain/evidence/icons/transfer.svg' width='24' height='24'/><b>Replication Client</b><br/><span style='font-size:0.8em;opacity:0.65'>VCL client and transport modules · Posts signed events to edge on HTTPS 443</span>"]:::net
  end

  subgraph CRYPTO["Boundary: Cryptography Primitive Layer"]
    direction TB
    XMETA["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>Crypto Boundary</b><br/><span style='font-size:0.8em;opacity:0.65'>Deterministic primitive function layer · Executes cryptographic math in-process</span>"]:::sec
    P1["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>Blind Schnorr Primitive</b><br/><span style='font-size:0.8em;opacity:0.65'>Credential blinding and signing · Generates unlinkable credential signatures</span>"]:::sec
    P2["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>ECIES Primitive</b><br/><span style='font-size:0.8em;opacity:0.65'>Ballot key wrapping · Encrypts ballot keys using ECDH and AES-GCM</span>"]:::sec
    P3["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>Shamir Primitive</b><br/><span style='font-size:0.8em;opacity:0.65'>Threshold share primitive · Splits and recombines election secrets</span>"]:::sec
    P4["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>ECDSA Primitive</b><br/><span style='font-size:0.8em;opacity:0.65'>Signing and verification · Signs manifests, STH, and VCL acknowledgements</span>"]:::sec
    P5["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>BigInt Arithmetic Primitive</b><br/><span style='font-size:0.8em;opacity:0.65'>secp256k1 scalar math helper · Performs modular arithmetic for all primitives</span>"]:::sec
  end

  subgraph EDGE["Boundary: Edge Replication Layer"]
    direction TB
    EMETA["<img src='/votechain/evidence/icons/cloudflare.svg' width='24' height='24'/><b>Edge Boundary</b><br/><span style='font-size:0.8em;opacity:0.65'>Cloudflare Pages and Worker ingress · Accepts browser replication on HTTPS 443</span>"]:::net
    EDGEAPI["<img src='/votechain/evidence/icons/cloudflare.svg' width='24' height='24'/><b>Replication Endpoint</b><br/><span style='font-size:0.8em;opacity:0.65'>/api/votechain/poc/replicate route · Validates request and routes by event type</span>"]:::net
  end

  UI --> JOURNEY
  JOURNEY --> ENGINE
  UI --> AUDIT
  UI --> STATE
  ENGINE --> CRED
  ENGINE --> CAST
  ENGINE --> BB
  ENGINE --> VCL
  CRED --> P1
  CAST --> P2
  CAST --> P3
  BB --> P4
  ENGINE --> P5
  VCL -->|HTTPS 443 signed replicate| EDGEAPI
`}</pre>
        </article>

        <!-- Panel 2: PocStateV2 Schema (span 7) -->
        <article class="panel panel-state" data-panel="state-schema">
          <header class="panel-header">
            <p class="panel-kicker">State Machine</p>
            <h2>PocStateV2 Schema</h2>
            <p>Complete state tree persisted in localStorage. All election data lives in a single versioned object.</p>
          </header>
          <div class="state-tree">
            <div class="state-root">PocStateV2 <span class="state-version">version: 2</span></div>
            <div class="state-branches">
              <div class="state-branch">
                <div class="branch-label branch-label-key">keys</div>
                <div class="branch-children">
                  <div class="state-leaf">manifest <span>StoredKeyPair</span></div>
                  <div class="state-leaf">ewg <span>StoredKeyPair</span></div>
                  <div class="state-leaf">bb <span>StoredKeyPair</span></div>
                  <div class="state-leaf">vcl <span>StoredKeyPair</span></div>
                </div>
              </div>
              <div class="state-branch">
                <div class="branch-label branch-label-election">election</div>
                <div class="branch-children">
                  <div class="state-leaf">election_id <span>string</span></div>
                  <div class="state-leaf">jurisdiction_id <span>string</span></div>
                  <div class="state-leaf">contests <span>PocContest[]</span></div>
                </div>
              </div>
              <div class="state-branch">
                <div class="branch-label branch-label-trust">trustees + issuers</div>
                <div class="branch-children">
                  <div class="state-leaf">threshold <span>&#123; t: 2, n: 3 &#125;</span></div>
                  <div class="state-leaf">shares <span>PocTrusteeShareRecord[]</span></div>
                  <div class="state-leaf">issuers <span>Array&lt;&#123; sk, pk &#125;&gt;</span></div>
                  <div class="state-leaf">issuer_threshold <span>&#123; t, n &#125;</span></div>
                </div>
              </div>
              <div class="state-branch">
                <div class="branch-label branch-label-data">credential + voting</div>
                <div class="branch-children">
                  <div class="state-leaf">credential <span>PocCredential?</span></div>
                  <div class="state-leaf">challenges <span>Record&lt;id, ChallengeRecord&gt;</span></div>
                  <div class="state-leaf">spoiled_ballots <span>PocSpoiledBallotRecord[]</span></div>
                  <div class="state-leaf">tally <span>PocTally?</span></div>
                </div>
              </div>
              <div class="state-branch">
                <div class="branch-label branch-label-audit">audit trail</div>
                <div class="branch-children">
                  <div class="state-leaf">bb.leaves <span>PocBbLeaf[]</span></div>
                  <div class="state-leaf">bb.sth_history <span>PocSignedTreeHead[]</span></div>
                  <div class="state-leaf">vcl.events <span>PocVclEvent[]</span></div>
                </div>
              </div>
            </div>
          </div>
        </article>

        <!-- Panel 3: Initialization Sequence (span 5) -->
        <article class="panel panel-init" data-panel="init-sequence">
          <header class="panel-header">
            <p class="panel-kicker">Bootstrap</p>
            <h2>Initialization Sequence</h2>
            <p>Steps executed when a new POC election is created.</p>
          </header>
          <div class="init-steps">
            <div class="init-step" data-stage="1">
              <div class="step-badge">1</div>
              <div class="step-content">
                <strong>Generate 4 ECDSA Keypairs</strong>
                <code>manifest, ewg, bb, vcl</code>
                <p>Each key serves a distinct signing role</p>
              </div>
            </div>
            <div class="init-step" data-stage="2">
              <div class="step-badge">2</div>
              <div class="step-content">
                <strong>Create Issuers (3)</strong>
                <code>secp256k1 keypairs for blind Schnorr</code>
                <p>Threshold t=2, n=3</p>
              </div>
            </div>
            <div class="init-step" data-stage="3">
              <div class="step-badge">3</div>
              <div class="step-content">
                <strong>Split Election Secret</strong>
                <code>shamirSplit(secret, 2, 3)</code>
                <p>Distribute shares to trustees</p>
              </div>
            </div>
            <div class="init-step" data-stage="4">
              <div class="step-badge">4</div>
              <div class="step-content">
                <strong>Build Manifest</strong>
                <code>contests, candidates, voter_roll_size</code>
                <p>Signed with manifest key</p>
              </div>
            </div>
            <div class="init-step" data-stage="1">
              <div class="step-badge">5</div>
              <div class="step-content">
                <strong>Sign + Publish</strong>
                <code>ECDSA sign manifest payload</code>
                <p>Create VCL event: election_manifest_published</p>
              </div>
            </div>
            <div class="init-step" data-stage="2">
              <div class="step-badge">6</div>
              <div class="step-content">
                <strong>Persist to localStorage</strong>
                <code>PocStateV2 → JSON → localStorage</code>
                <p>State ready for voter operations</p>
              </div>
            </div>
          </div>
        </article>

        <!-- Panel 4: Voter Journey Flow (span 12) -->
        <article class="panel panel-journey" data-panel="voter-journey">
          <header class="panel-header">
            <p class="panel-kicker">End-To-End Flow</p>
            <h2>Voter Journey: Credential To Tally</h2>
            <p>The complete lifecycle of a vote through the POC engine, from credential registration to final tally.</p>
          </header>
          <div class="journey-pipeline">
            <div class="journey-step" data-stage="1">
              <div class="journey-badge">1</div>
              <div class="journey-title">Register Credential</div>
              <div class="journey-desc">Generate voter keypair, blind Schnorr issuance from t-of-n issuers</div>
              <div class="journey-module">credential.ts</div>
            </div>
            <div class="journey-arrow"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="journey-step" data-stage="2">
              <div class="journey-badge">2</div>
              <div class="journey-title">Issue Challenge</div>
              <div class="journey-desc">Server signs a Benaloh challenge with the ewg key</div>
              <div class="journey-module">cast.ts</div>
            </div>
            <div class="journey-arrow"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="journey-step" data-stage="3">
              <div class="journey-badge">3</div>
              <div class="journey-title">Encrypt Ballot</div>
              <div class="journey-desc">AES-GCM encrypt selections, ECIES wrap key under election PK</div>
              <div class="journey-module">ballot.ts + ecies.ts</div>
            </div>
            <div class="journey-arrow"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="journey-step journey-step-branch" data-stage="3">
              <div class="journey-badge">4</div>
              <div class="journey-title">Challenge / Spoil <span class="journey-or">OR</span> Cast</div>
              <div class="journey-desc">Benaloh: open to verify, then re-encrypt. Or commit to cast.</div>
              <div class="journey-module">cast.ts</div>
            </div>
            <div class="journey-arrow"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="journey-step" data-stage="4">
              <div class="journey-badge">5</div>
              <div class="journey-title">Verify Receipt</div>
              <div class="journey-desc">Check BB inclusion proof, STH signature, VCL anchor event</div>
              <div class="journey-module">verify.ts</div>
            </div>
            <div class="journey-arrow"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="journey-step" data-stage="4">
              <div class="journey-badge">6</div>
              <div class="journey-title">Tally</div>
              <div class="journey-desc">Shamir combine shares, ECIES unwrap all ballots, aggregate, sign</div>
              <div class="journey-module">tally.ts</div>
            </div>
          </div>
        </article>

      </section>
    </div>
  </article>

  <style>
    .board-canvas {
      --ink: #0f223b;
      --ink-soft: #35506f;
      --line: #c5d1de;
      --line-strong: #a0b3c8;
      --card: #ffffff;
      --bg-a: #faf7f0;
      --bg-b: #f0ebe0;
      --accent: #b8892e;
      --accent-soft: #f4ead1;
      --ok-bg: #e6f7ee;
      --ok-ink: #1a6b3a;
      --ok-border: #b5e2c6;
      --warn-bg: #fff5e6;
      --warn-ink: #8e5b10;
      --stage-1: #3a6fa0;
      --stage-2: #2d8a5e;
      --stage-3: #b8892e;
      --stage-4: #1a6b3a;
      --mono: "JetBrains Mono", "SF Mono", Menlo, Consolas, monospace;
      --serif: "Libre Caslon Text", "Book Antiqua", "Palatino Linotype", serif;
      --sans: "Inter", "Avenir Next", "Segoe UI", Tahoma, sans-serif;
    }

    * { box-sizing: border-box; }

    .board-canvas {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(ellipse 80% 50% at 15% 10%, rgba(255,255,255,0.7) 0, transparent 60%),
        linear-gradient(155deg, var(--bg-a) 0%, var(--bg-b) 100%);
      font-family: var(--sans);
    }

    .page {
      width: min(1480px, calc(100% - 32px));
      max-width: 1480px;
      margin: 40px auto 80px;
    }

    .board-breadcrumb { display: flex; align-items: center; gap: 6px; margin-bottom: 20px; font-family: var(--mono); font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; }
    .board-breadcrumb a { color: var(--accent); text-decoration: none; }
    .board-breadcrumb a:hover { text-decoration: underline; }
    .board-breadcrumb svg { color: var(--line-strong); flex-shrink: 0; }
    .board-breadcrumb span { color: var(--ink-soft); }

    .hero {
      padding: 32px 36px 28px;
      border: 1px solid var(--line);
      border-radius: 20px;
      background: linear-gradient(135deg, #ffffff 0%, #f5f0e1 100%);
      box-shadow: 0 1px 0 rgba(255,255,255,0.9) inset, 0 20px 50px -12px rgba(15,34,59,0.10);
    }

    .hero-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 32px; }
    .hero-text { flex: 1; }

    .hero-kicker {
      margin: 0 0 10px;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--accent);
    }

    .hero h1 { margin: 0; font-family: var(--serif); font-size: clamp(28px, 3vw, 42px); line-height: 1.12; color: var(--ink); }
    .hero-subtitle { margin: 14px 0 0; color: var(--ink-soft); font-size: 16px; line-height: 1.5; max-width: 640px; }

    .hero-verdict { display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; padding-top: 4px; }

    .verdict-ring {
      width: 64px; height: 64px; border-radius: 50%;
      background: linear-gradient(135deg, #e6f7ee, #d0f0dd);
      border: 2.5px solid var(--ok-border);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 14px rgba(26,107,58,0.12);
    }

    .verdict-check { width: 32px; height: 32px; color: var(--ok-ink); }

    .verdict-label {
      font-family: var(--mono); font-size: 10px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em; color: var(--ok-ink);
    }

    .top-metrics { margin-top: 24px; display: grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap: 12px; }

    .metric { border: 1px solid var(--line); border-radius: 12px; padding: 14px 16px; background: #fff; }
    .metric-label { font-family: var(--mono); font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; color: var(--ink-soft); }
    .metric-value { margin-top: 6px; font-size: 24px; line-height: 1; font-weight: 700; font-family: var(--serif); overflow-wrap: break-word; word-break: break-word; }
    .metric-pass { border-color: var(--ok-border); background: linear-gradient(180deg, #f0faf4, #e6f7ee); }
    .metric-pass .metric-value { color: var(--ok-ink); }

    .panel-grid { margin-top: 24px; display: grid; grid-template-columns: repeat(12, 1fr); gap: 18px; }

    .panel {
      border: 1px solid var(--line); border-radius: 16px;
      background: var(--card); padding: 24px;
      box-shadow: 0 8px 24px -4px rgba(15,34,59,0.06);
    }

    .panel h2 { margin: 0 0 6px; font-family: var(--serif); font-size: 24px; line-height: 1.2; }
    .panel p { margin: 0; color: var(--ink-soft); font-size: 14px; line-height: 1.5; }
    .panel-header { margin-bottom: 18px; }

    .panel-kicker {
      margin: 0 0 5px; font-family: var(--mono); font-size: 10px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.14em; color: var(--accent);
    }

    .caps { text-transform: uppercase; letter-spacing: 0.06em; font-family: var(--mono); }

    /* ── Module Graph ────────────────────── */

    .panel-modules { grid-column: span 12; }

    .panel-modules svg {
      width: 100%; height: auto; display: block;
      border: 1px solid #d2deec; border-radius: 10px; background: #f9fcff;
    }

    /* ── State Schema ────────────────────── */

    .panel-state { grid-column: span 7; }

    .state-tree { font-family: var(--mono); font-size: 13px; }

    .state-root {
      padding: 12px 16px; border: 2px solid var(--stage-1);
      border-radius: 10px; background: #eef4fb;
      font-weight: 700; font-size: 15px; margin-bottom: 12px;
    }

    .state-version {
      font-weight: 400; font-size: 12px; color: var(--ink-soft);
      margin-left: 8px;
    }

    .state-branches { display: grid; gap: 10px; }

    .state-branch {
      border: 1px solid var(--line); border-radius: 10px;
      padding: 10px 14px; background: #fafbfd;
    }

    .branch-label {
      font-weight: 600; font-size: 12px; text-transform: uppercase;
      letter-spacing: 0.08em; margin-bottom: 8px;
      padding: 3px 10px; border-radius: 6px; display: inline-block;
    }

    .branch-label-key { background: #eef4fb; color: var(--stage-1); }
    .branch-label-election { background: #f0faf4; color: var(--stage-2); }
    .branch-label-trust { background: #fff5e6; color: var(--stage-3); }
    .branch-label-data { background: #e6f7ee; color: var(--stage-4); }
    .branch-label-audit { background: #f3eef9; color: #6b4fa0; }

    .branch-children { display: grid; gap: 4px; }

    .state-leaf {
      padding: 6px 10px; border: 1px solid #e2e9f2;
      border-radius: 6px; background: #fff; font-size: 12px;
    }

    .state-leaf span {
      float: right; color: var(--ink-soft); font-size: 11px;
    }

    /* ── Init Sequence ───────────────────── */

    .panel-init { grid-column: span 5; }

    .init-steps { display: grid; gap: 10px; }

    .init-step {
      display: flex; align-items: flex-start; gap: 12px;
      border: 1px solid var(--line); border-radius: 10px;
      padding: 12px 14px; background: #fff;
      border-left: 3px solid var(--line);
    }

    .init-step[data-stage="1"] { border-left-color: var(--stage-1); }
    .init-step[data-stage="2"] { border-left-color: var(--stage-2); }
    .init-step[data-stage="3"] { border-left-color: var(--stage-3); }
    .init-step[data-stage="4"] { border-left-color: var(--stage-4); }

    .step-badge {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--mono); font-size: 13px; font-weight: 700;
      color: #fff; background: var(--line-strong); flex-shrink: 0;
    }

    .init-step[data-stage="1"] .step-badge { background: var(--stage-1); }
    .init-step[data-stage="2"] .step-badge { background: var(--stage-2); }
    .init-step[data-stage="3"] .step-badge { background: var(--stage-3); }
    .init-step[data-stage="4"] .step-badge { background: var(--stage-4); }

    .step-content { flex: 1; }
    .step-content strong { display: block; font-size: 14px; margin-bottom: 2px; }
    .step-content code { display: block; font-family: var(--mono); font-size: 11px; color: var(--ink-soft); }
    .step-content p { font-size: 12px; margin-top: 2px; }

    /* ── Voter Journey ───────────────────── */

    .panel-journey { grid-column: span 12; min-width: 0; overflow: hidden; }

    .journey-pipeline {
      display: flex; align-items: stretch; gap: 0;
      overflow-x: auto; padding-bottom: 8px;
    }

    .journey-step {
      flex: 1; min-width: 0;
      border: 1px solid var(--line); border-radius: 12px;
      padding: 16px 14px; background: linear-gradient(180deg, #fff, #fafbfd);
      border-top: 3px solid var(--line); position: relative;
    }

    .journey-step[data-stage="1"] { border-top-color: var(--stage-1); }
    .journey-step[data-stage="2"] { border-top-color: var(--stage-2); }
    .journey-step[data-stage="3"] { border-top-color: var(--stage-3); }
    .journey-step[data-stage="4"] { border-top-color: var(--stage-4); }

    .journey-badge {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--mono); font-size: 13px; font-weight: 700;
      color: #fff; background: var(--line-strong); margin-bottom: 8px;
    }

    .journey-step[data-stage="1"] .journey-badge { background: var(--stage-1); }
    .journey-step[data-stage="2"] .journey-badge { background: var(--stage-2); }
    .journey-step[data-stage="3"] .journey-badge { background: var(--stage-3); }
    .journey-step[data-stage="4"] .journey-badge { background: var(--stage-4); }

    .journey-title { font-family: var(--serif); font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .journey-desc { font-size: 12px; color: var(--ink-soft); line-height: 1.45; }
    .journey-module {
      margin-top: 8px; font-family: var(--mono); font-size: 10px;
      color: var(--stage-1); background: #eef4fb;
      padding: 3px 8px; border-radius: 6px; display: inline-block;
    }

    .journey-or {
      display: inline-block; font-family: var(--mono); font-size: 10px;
      font-weight: 600; color: var(--accent); margin-left: 4px;
    }

    .journey-arrow {
      display: flex; align-items: center; justify-content: center;
      width: 28px; flex-shrink: 0; color: var(--accent);
    }

    .journey-arrow svg { width: 22px; height: 22px; }

    /* ── Responsive ──────────────────────── */

    @media (max-width: 1100px) {
      .top-metrics { grid-template-columns: repeat(3, 1fr); }

      .panel-modules, .panel-state, .panel-init, .panel-journey {
        grid-column: span 12;
      }

      .journey-pipeline { flex-direction: column; }
      .journey-arrow { transform: rotate(90deg); width: auto; padding: 4px 0; }
    }

    @media (max-width: 640px) {
      .page { margin: 20px auto 40px; }
      .hero { padding: 20px; }
      .hero-top { flex-direction: column; gap: 16px; }
      .hero-verdict { flex-direction: row; align-self: flex-start; }
      .verdict-ring { width: 44px; height: 44px; }
      .verdict-check { width: 22px; height: 22px; }
      .hero h1 { font-size: 26px; }
      .top-metrics { grid-template-columns: repeat(2, 1fr); }
      .panel-grid { gap: 12px; }
    }
  </style>
  <MermaidClient />
</BaseLayout>
