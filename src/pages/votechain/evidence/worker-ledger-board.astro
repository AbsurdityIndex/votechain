---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import MermaidClient from '../../../components/votechain/MermaidClient.astro';

---

<BaseLayout
  title="VoteChain Worker Ledger Architecture Board"
  description="Visual evidence board for the 3-node Worker architecture: Durable Object ledger, event routing, replication flow, and authentication layers."
  ogType="article"
  article={{
    publishedTime: '2026-02-12',
    modifiedTime: '2026-02-12',
    author: 'Absurdity Index',
    section: 'Engineering',
    tags: ['votechain', 'evidence', 'workers', 'diagram board'],
  }}
>
  <article class="board-canvas">
    <div class="page">
      <nav class="board-breadcrumb" aria-label="Breadcrumb">
        <a href="/votechain">VoteChain</a>
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        <span>Evidence Boards</span>
      </nav>
      <section class="hero">
        <div class="hero-top">
          <div class="hero-text">
            <p class="hero-kicker">VoteChain Evidence Board</p>
            <h1>Worker Ledger Architecture<br/>Diagram Board</h1>
            <p class="hero-subtitle">
              Three Cloudflare Workers with Durable Object ledgers, role-based event routing,
              hash-chain tamper evidence, and three-gate authentication.
            </p>
          </div>
          <div class="hero-verdict">
            <div class="verdict-ring">
              <svg viewBox="0 0 48 48" class="verdict-check"><path d="M14 24l8 8 12-14" fill="none" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="verdict-label">Nodes Synchronized</div>
          </div>
        </div>
        <div class="top-metrics">
          <div class="metric">
            <div class="metric-label">Node Roles</div>
            <div class="metric-value">3</div>
          </div>
          <div class="metric">
            <div class="metric-label">Event Types</div>
            <div class="metric-value">7</div>
          </div>
          <div class="metric">
            <div class="metric-label">ACK Signatures</div>
            <div class="metric-value">ECDSA</div>
          </div>
          <div class="metric">
            <div class="metric-label">Hash Chain</div>
            <div class="metric-value">SHA-256</div>
          </div>
          <div class="metric metric-pass">
            <div class="metric-label">Storage</div>
            <div class="metric-value">Durable Objects</div>
          </div>
        </div>
      </section>

      <section class="panel-grid">

        <!-- Panel 1: Three-Node Topology (span 12) -->
        <article class="panel panel-topology" data-panel="worker-topology">
          <header class="panel-header">
            <p class="panel-kicker">Infrastructure</p>
            <h2>Three-Node Worker Topology</h2>
            <p>Browser events flow through a Pages Function router to the appropriate Worker based on event type. Each node only accepts its assigned event types.</p>
          </header>
          <pre data-language="mermaid">{`%% diagram-id: worker-topology
flowchart LR
  classDef hw fill:#e8d5b0,stroke:#a88b4a,stroke-width:1.5px
  classDef net fill:#dce7f5,stroke:#3a6fa0,stroke-width:1.5px
  classDef db fill:#f0ebe0,stroke:#8a6e36,stroke-width:1.5px
  classDef sec fill:#d9eee2,stroke:#2d8a5e,stroke-width:1.5px
  subgraph EDGE["Boundary: Public Edge Entry"]
    direction TB
    EMETA["<img src='/votechain/evidence/icons/router.svg' width='24' height='24'/><b>Edge Boundary</b><br/><span style='font-size:0.8em;opacity:0.65'>Cloudflare edge ingress · Port 443</span>"]:::net
    BR["<img src='/votechain/evidence/icons/device-desktop.svg' width='24' height='24'/><b>Browser Client</b><br/><span style='font-size:0.8em;opacity:0.65'>Voter browser POC session · HTTPS 443</span>"]:::net
    PF["<img src='/votechain/evidence/icons/cloudflare.svg' width='24' height='24'/><b>Pages Function Router</b><br/><span style='font-size:0.8em;opacity:0.65'>replicate.ts edge routing · Cookie + event dispatch</span>"]:::net
    BR -->|HTTPS 443 replicate POST| PF
  end

  subgraph WK["Boundary: Worker Node Mesh"]
    direction TB
    WMETA["<img src='/votechain/evidence/icons/cloudflare.svg' width='24' height='24'/><b>Worker Boundary</b><br/><span style='font-size:0.8em;opacity:0.65'>Federal/state/oversight fleet · DO ledger writes · Port 443</span>"]:::net
    WFED["<img src='/votechain/evidence/icons/cloudflare.svg' width='24' height='24'/><b>Federal Worker</b><br/><span style='font-size:0.8em;opacity:0.65'>Manifest + tally authority · Hash-chain append</span>"]:::net
    WSTATE["<img src='/votechain/evidence/icons/cloudflare.svg' width='24' height='24'/><b>State Worker</b><br/><span style='font-size:0.8em;opacity:0.65'>Credential + ballot + STH authority · Hash-chain append</span>"]:::net
    WOBS["<img src='/votechain/evidence/icons/cloudflare.svg' width='24' height='24'/><b>Oversight Worker</b><br/><span style='font-size:0.8em;opacity:0.65'>Fraud review authority · Hash-chain append</span>"]:::net
  end

  ACK["<img src='/votechain/evidence/icons/key.svg' width='24' height='24'/><b>Signed ACK Packet</b><br/><span style='font-size:0.8em;opacity:0.65'>Replication receipt {index, hash, ack_sig} · HTTPS 443</span>"]:::sec

  PF -->|manifest and tally types HTTPS 443| WFED
  PF -->|credential ballot STH types HTTPS 443| WSTATE
  PF -->|fraud flag action types HTTPS 443| WOBS
  WFED -.->|index hash signature| ACK
  WSTATE -.->|index hash signature| ACK
  WOBS -.->|index hash signature| ACK
`}</pre>
        </article>

        <!-- Panel 2: Role-Based Event Routing (span 7) -->
        <article class="panel panel-routing" data-panel="event-routing">
          <header class="panel-header">
            <p class="panel-kicker">Routing Rules</p>
            <h2>Role-Based Event Routing</h2>
            <p>Each event type has a designated originating node. The ORIGINATING_TYPES_MAP determines routing.</p>
          </header>
          <table>
            <thead>
              <tr>
                <th>Event Type</th>
                <th>Target Node</th>
                <th>Purpose</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>election_manifest_published</code></td>
                <td><span class="node-badge node-federal">Federal</span></td>
                <td>Election configuration + contest definitions</td>
              </tr>
              <tr>
                <td><code>tally_published</code></td>
                <td><span class="node-badge node-federal">Federal</span></td>
                <td>Final election results after threshold decrypt</td>
              </tr>
              <tr>
                <td><code>credential_issued</code></td>
                <td><span class="node-badge node-state">State</span></td>
                <td>Voter credential issuance record</td>
              </tr>
              <tr>
                <td><code>ewp_ballot_cast</code></td>
                <td><span class="node-badge node-state">State</span></td>
                <td>Encrypted ballot cast with nullifier</td>
              </tr>
              <tr>
                <td><code>bb_sth_published</code></td>
                <td><span class="node-badge node-state">State</span></td>
                <td>Bulletin board signed tree head snapshot</td>
              </tr>
              <tr>
                <td><code>fraud_flag</code></td>
                <td><span class="node-badge node-oversight">Oversight</span></td>
                <td>Suspected fraud detection event</td>
              </tr>
              <tr>
                <td><code>fraud_flag_action</code></td>
                <td><span class="node-badge node-oversight">Oversight</span></td>
                <td>Fraud case status transition</td>
              </tr>
            </tbody>
          </table>
        </article>

        <!-- Panel 3: Durable Object Ledger (span 5) -->
        <article class="panel panel-ledger" data-panel="do-ledger">
          <header class="panel-header">
            <p class="panel-kicker">Tamper Evidence</p>
            <h2>Durable Object Hash Chain</h2>
            <p>Each ledger entry's hash depends on the previous entry, creating an append-only tamper-evident chain.</p>
          </header>
          <div class="chain">
            <div class="chain-entry">
              <div class="chain-index">Entry 0</div>
              <code>hash = SHA256("" + "\n" + canonical(event₀))</code>
              <span>Genesis entry (no predecessor)</span>
            </div>
            <div class="chain-arrow"><svg viewBox="0 0 24 12" fill="none"><path d="M12 0v10M6 6l6 5 6-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="chain-entry">
              <div class="chain-index">Entry 1</div>
              <code>hash = SHA256(entry[0].hash + "\n" + canonical(event₁))</code>
              <span>Depends on entry 0</span>
            </div>
            <div class="chain-arrow"><svg viewBox="0 0 24 12" fill="none"><path d="M12 0v10M6 6l6 5 6-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="chain-entry chain-entry-current">
              <div class="chain-index">Entry n</div>
              <code>hash = SHA256(entry[n-1].hash + "\n" + canonical(event_n))</code>
              <span>Each entry chains to its predecessor</span>
            </div>
          </div>
          <div class="chain-note">
            <strong>Tamper-evidence</strong>: Modifying any past entry changes its hash, which cascades through all subsequent entries.
            SQLite storage in Durable Objects ensures single-writer consistency.
          </div>
        </article>

        <!-- Panel 4: Replication Request Flow (span 7) -->
        <article class="panel panel-replication" data-panel="replication-flow">
          <header class="panel-header">
            <p class="panel-kicker">Data Flow</p>
            <h2>Replication Request Flow</h2>
            <p>Step-by-step sequence from browser POST to signed acknowledgement.</p>
          </header>
          <div class="repl-steps">
            <div class="repl-step">
              <div class="repl-badge">1</div>
              <div class="repl-content">
                <strong>Browser POST</strong>
                <code>VCL client sends event to /api/votechain/poc/replicate</code>
              </div>
            </div>
            <div class="repl-step">
              <div class="repl-badge">2</div>
              <div class="repl-content">
                <strong>Turnstile Cookie Check</strong>
                <code>Pages Function validates session cookie (HMAC-SHA256)</code>
              </div>
            </div>
            <div class="repl-step">
              <div class="repl-badge">3</div>
              <div class="repl-content">
                <strong>Route to Worker</strong>
                <code>ORIGINATING_TYPES_MAP[event.type] → target node URL</code>
              </div>
            </div>
            <div class="repl-step">
              <div class="repl-badge">4</div>
              <div class="repl-content">
                <strong>Bearer Auth</strong>
                <code>Worker validates write token in Authorization header</code>
              </div>
            </div>
            <div class="repl-step">
              <div class="repl-badge">5</div>
              <div class="repl-content">
                <strong>DO Append</strong>
                <code>LedgerNode Durable Object appends event, computes hash chain</code>
              </div>
            </div>
            <div class="repl-step repl-step-ok">
              <div class="repl-badge repl-badge-ok">6</div>
              <div class="repl-content">
                <strong>Sign ACK + Return</strong>
                <code>ECDSA sign &#123; index, hash &#125; → return entry + ack to browser</code>
              </div>
            </div>
          </div>
        </article>

        <!-- Panel 5: Authentication Layers (span 5) -->
        <article class="panel panel-auth" data-panel="auth-layers">
          <header class="panel-header">
            <p class="panel-kicker">Security</p>
            <h2>Three-Gate Authentication</h2>
            <p>Every replication request must pass through three independent authentication layers.</p>
          </header>
          <div class="auth-gates">
            <div class="auth-gate auth-gate-1">
              <div class="gate-number">Gate 1</div>
              <div class="gate-title">Turnstile</div>
              <div class="gate-desc">Cloudflare human verification challenge. Sets a session cookie on success.</div>
              <div class="gate-detail">
                <code>TURNSTILE_SECRET_KEY</code>
              </div>
            </div>
            <div class="auth-gate auth-gate-2">
              <div class="gate-number">Gate 2</div>
              <div class="gate-title">Session Cookie</div>
              <div class="gate-desc">HMAC-SHA256 signed cookie with expiry. Validated on every request by the Pages Function.</div>
              <div class="gate-detail">
                <code>POC_ACCESS_COOKIE_SECRET</code>
              </div>
            </div>
            <div class="auth-gate auth-gate-3">
              <div class="gate-number">Gate 3</div>
              <div class="gate-title">Bearer Write Token</div>
              <div class="gate-desc">Per-node secret token in Authorization header. Worker rejects requests without a valid token.</div>
              <div class="gate-detail">
                <code>VOTECHAIN_*_WRITE_TOKEN</code>
              </div>
            </div>
          </div>
        </article>

      </section>
    </div>
  </article>

  <style>
    .board-canvas {
      --ink: #0f223b;
      --ink-soft: #35506f;
      --line: #c5d1de;
      --line-strong: #a0b3c8;
      --card: #ffffff;
      --bg-a: #faf7f0;
      --bg-b: #f0ebe0;
      --accent: #b8892e;
      --accent-soft: #f4ead1;
      --ok-bg: #e6f7ee;
      --ok-ink: #1a6b3a;
      --ok-border: #b5e2c6;
      --warn-bg: #fff5e6;
      --warn-ink: #8e5b10;
      --stage-1: #3a6fa0;
      --stage-2: #2d8a5e;
      --stage-3: #b8892e;
      --stage-4: #1a6b3a;
      --mono: "JetBrains Mono", "SF Mono", Menlo, Consolas, monospace;
      --serif: "Libre Caslon Text", "Book Antiqua", "Palatino Linotype", serif;
      --sans: "Inter", "Avenir Next", "Segoe UI", Tahoma, sans-serif;
    }

    * { box-sizing: border-box; }

    .board-canvas {
      margin: 0; color: var(--ink);
      background: radial-gradient(ellipse 80% 50% at 15% 10%, rgba(255,255,255,0.7) 0, transparent 60%), linear-gradient(155deg, var(--bg-a) 0%, var(--bg-b) 100%);
      font-family: var(--sans);
    }

    .page { width: min(1480px, calc(100% - 32px)); max-width: 1480px; margin: 40px auto 80px; }

    .board-breadcrumb { display: flex; align-items: center; gap: 6px; margin-bottom: 20px; font-family: var(--mono); font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; }
    .board-breadcrumb a { color: var(--accent); text-decoration: none; }
    .board-breadcrumb a:hover { text-decoration: underline; }
    .board-breadcrumb svg { color: var(--line-strong); flex-shrink: 0; }
    .board-breadcrumb span { color: var(--ink-soft); }

    .hero {
      padding: 32px 36px 28px; border: 1px solid var(--line); border-radius: 20px;
      background: linear-gradient(135deg, #ffffff 0%, #f5f0e1 100%);
      box-shadow: 0 1px 0 rgba(255,255,255,0.9) inset, 0 20px 50px -12px rgba(15,34,59,0.10);
    }

    .hero-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 32px; }
    .hero-text { flex: 1; }
    .hero-kicker { margin: 0 0 10px; font-family: var(--mono); font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.18em; color: var(--accent); }
    .hero h1 { margin: 0; font-family: var(--serif); font-size: clamp(28px, 3vw, 42px); line-height: 1.12; color: var(--ink); }
    .hero-subtitle { margin: 14px 0 0; color: var(--ink-soft); font-size: 16px; line-height: 1.5; max-width: 640px; }
    .hero-verdict { display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; padding-top: 4px; }
    .verdict-ring { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #e6f7ee, #d0f0dd); border: 2.5px solid var(--ok-border); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px rgba(26,107,58,0.12); }
    .verdict-check { width: 32px; height: 32px; color: var(--ok-ink); }
    .verdict-label { font-family: var(--mono); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--ok-ink); }
    .top-metrics { margin-top: 24px; display: grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap: 12px; }
    .metric { border: 1px solid var(--line); border-radius: 12px; padding: 14px 16px; background: #fff; }
    .metric-label { font-family: var(--mono); font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; color: var(--ink-soft); }
    .metric-value { margin-top: 6px; font-size: 24px; line-height: 1; font-weight: 700; font-family: var(--serif); }
    .metric-pass { border-color: var(--ok-border); background: linear-gradient(180deg, #f0faf4, #e6f7ee); }
    .metric-pass .metric-value { color: var(--ok-ink); }

    .panel-grid { margin-top: 24px; display: grid; grid-template-columns: repeat(12, 1fr); gap: 18px; }
    .panel { border: 1px solid var(--line); border-radius: 16px; background: var(--card); padding: 24px; box-shadow: 0 8px 24px -4px rgba(15,34,59,0.06); }
    .panel h2 { margin: 0 0 6px; font-family: var(--serif); font-size: 24px; line-height: 1.2; }
    .panel p { margin: 0; color: var(--ink-soft); font-size: 14px; line-height: 1.5; }
    .panel-header { margin-bottom: 18px; }
    .panel-kicker { margin: 0 0 5px; font-family: var(--mono); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.14em; color: var(--accent); }

    /* ── Topology ────────────────────────── */

    .panel-topology { grid-column: span 12; }
    .panel-topology :global(svg) { width: 100%; height: auto; display: block; border: 1px solid #d2deec; border-radius: 10px; background: #f9fcff; }

    /* ── Event Routing ───────────────────── */

    .panel-routing { grid-column: span 7; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #e2e9f2; padding: 10px; text-align: left; font-size: 13px; }
    th { font-family: var(--mono); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--ink-soft); padding-bottom: 8px; }
    tbody tr:hover { background: #f8fafd; }
    tr:last-child td { border-bottom: 0; }
    td code { font-family: var(--mono); font-size: 12px; }

    .node-badge {
      display: inline-block; padding: 3px 10px; border-radius: 999px;
      font-family: var(--mono); font-size: 11px; font-weight: 600;
    }

    .node-federal { background: #eef4fb; color: var(--stage-1); border: 1px solid #aac3df; }
    .node-state { background: #f0faf4; color: var(--stage-2); border: 1px solid #a8d8b8; }
    .node-oversight { background: #f3eef9; color: #6b4fa0; border: 1px solid #c8b5e6; }

    /* ── DO Ledger ───────────────────────── */

    .panel-ledger { grid-column: span 5; }

    .chain { display: grid; gap: 0; margin-bottom: 14px; }

    .chain-entry {
      border: 1px solid var(--line); border-radius: 10px; padding: 12px 14px; background: #fff;
    }

    .chain-entry-current { border-color: var(--ok-border); background: var(--ok-bg); }

    .chain-index { font-family: var(--mono); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--ink-soft); margin-bottom: 4px; }
    .chain-entry-current .chain-index { color: var(--ok-ink); }
    .chain-entry code { display: block; font-family: var(--mono); font-size: 11px; color: var(--ink); word-break: break-all; }
    .chain-entry-current code { color: var(--ok-ink); }
    .chain-entry span { display: block; font-size: 11px; color: var(--ink-soft); margin-top: 2px; }
    .chain-entry-current span { color: var(--ok-ink); }

    .chain-arrow { display: flex; justify-content: center; padding: 3px 0; color: var(--line-strong); }
    .chain-arrow svg { width: 20px; height: 10px; }

    .chain-note {
      border: 1px dashed var(--line); border-radius: 10px; padding: 12px 14px; background: #f8fbff;
      font-size: 13px; color: var(--ink-soft); line-height: 1.5;
    }

    .chain-note strong { color: var(--ink); }

    /* ── Replication Flow ────────────────── */

    .panel-replication { grid-column: span 7; }

    .repl-steps { display: grid; gap: 8px; }

    .repl-step {
      display: flex; align-items: flex-start; gap: 12px;
      border: 1px solid var(--line); border-radius: 10px; padding: 12px 14px; background: #fff;
    }

    .repl-step-ok { border-color: var(--ok-border); background: var(--ok-bg); }

    .repl-badge {
      width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-family: var(--mono); font-size: 13px; font-weight: 700; color: #fff; background: var(--stage-1); flex-shrink: 0;
    }

    .repl-badge-ok { background: var(--ok-ink); }

    .repl-content { flex: 1; }
    .repl-content strong { display: block; font-size: 14px; margin-bottom: 2px; }
    .repl-content code { display: block; font-family: var(--mono); font-size: 11px; color: var(--ink-soft); }
    .repl-step-ok .repl-content code { color: var(--ok-ink); }

    /* ── Auth Layers ─────────────────────── */

    .panel-auth { grid-column: span 5; }

    .auth-gates { display: grid; gap: 10px; }

    .auth-gate {
      border: 1px solid var(--line); border-radius: 12px; padding: 14px 16px; background: #fff;
      border-left: 4px solid var(--line);
    }

    .auth-gate-1 { border-left-color: var(--stage-1); }
    .auth-gate-2 { border-left-color: var(--stage-3); }
    .auth-gate-3 { border-left-color: var(--stage-4); }

    .gate-number {
      font-family: var(--mono); font-size: 10px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--ink-soft); margin-bottom: 4px;
    }

    .gate-title { font-family: var(--serif); font-size: 17px; font-weight: 600; margin-bottom: 4px; }
    .gate-desc { font-size: 13px; color: var(--ink-soft); line-height: 1.4; }

    .gate-detail {
      margin-top: 8px; padding: 6px 10px; border-radius: 6px; background: #f4f7fb; display: inline-block;
    }

    .gate-detail code { font-family: var(--mono); font-size: 11px; color: var(--ink-soft); }

    /* ── Responsive ──────────────────────── */

    @media (max-width: 1100px) {
      .top-metrics { grid-template-columns: repeat(3, 1fr); }
      .panel-topology, .panel-routing, .panel-ledger, .panel-replication, .panel-auth { grid-column: span 12; }
    }

    @media (max-width: 640px) {
      .page { margin: 20px auto 40px; }
      .hero { padding: 20px; }
      .hero-top { flex-direction: column; gap: 16px; }
      .hero-verdict { flex-direction: row; align-self: flex-start; }
      .verdict-ring { width: 44px; height: 44px; }
      .verdict-check { width: 22px; height: 22px; }
      .hero h1 { font-size: 26px; }
      .top-metrics { grid-template-columns: repeat(2, 1fr); }
      .panel-grid { gap: 12px; }
    }
  </style>
  <MermaidClient />
</BaseLayout>
