---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import OfficialSeal from '../../../components/ui/OfficialSeal.astro';
import Icon from '../../../components/ui/Icon.astro';
import JourneyStepBar from '../../../components/votechain/JourneyStepBar.astro';
---

<BaseLayout
  title="VoteChain POC Oversight Dashboard"
  description="POC oversight dashboard: simulated VoteChain ledger events, bulletin board STHs, fraud flags, and tally publishing."
  ogType="article"
  article={{
    publishedTime: '2026-02-08',
    author: 'Absurdity Index',
    section: 'Policy',
    tags: ['votechain', 'ewp', 'poc', 'dashboard'],
  }}
>
  <JourneyStepBar currentStep={3} />
  <main class="bg-parchment min-h-screen">
    <!-- Compact hero bar (matching vote/verify page style) -->
    <section class="bg-navy-900 py-3">
      <div class="max-w-5xl mx-auto px-4 flex items-center gap-3">
        <OfficialSeal size="32" />
        <div>
          <p class="text-[10px] text-gold-500 font-mono uppercase tracking-widest leading-none">EWP POC &mdash; Step 3 of 3</p>
          <h1 class="font-serif text-lg sm:text-xl text-gold-400 font-bold leading-tight">Oversight Dashboard</h1>
        </div>
        <p class="hidden sm:block ml-auto text-gold-300/70 text-xs max-w-xs text-right">
          The public observer view. Publish the tally, review fraud flags, and watch the full ledger in real time.
        </p>
      </div>
    </section>

    <div class="max-w-5xl mx-auto px-4 py-10 sm:py-12 space-y-8">
      <section class="grid grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">Verified</p>
          <p class="font-serif text-3xl text-navy-900 font-bold" id="m-verified">0</p>
        </div>
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">
            Crypto-Conflict
          </p>
          <p class="font-serif text-3xl text-red-600 font-bold" id="m-conflict">0</p>
        </div>
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">Spoiled</p>
          <p class="font-serif text-3xl text-gold-600 font-bold" id="m-spoiled">0</p>
        </div>
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">
            BB Leaves
          </p>
          <p class="font-serif text-3xl text-navy-900 font-bold" id="m-leaves">0</p>
        </div>
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">Ledger Events</p>
          <p class="font-serif text-3xl text-navy-900 font-bold" id="m-events">0</p>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="clipboard-list" class="text-gold-600" />
            Controls
          </h2>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <button
            id="refresh"
            class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-4 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
            type="button"
          >
            <Icon name="repeat" class="text-gold-300" size={18} />
            Refresh
          </button>
          <button
            id="publish-tally"
            class="inline-flex items-center gap-2 rounded-md bg-gold-500 px-4 py-2 text-navy-900 font-sans text-sm font-semibold hover:bg-gold-400 transition-colors"
            type="button"
          >
            <Icon name="check" class="text-navy-900" size={18} />
            Publish POC Tally
          </button>
          <button
            id="export"
            class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-4 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            type="button"
          >
            <Icon name="archive" class="text-navy-700" size={18} />
            Export Snapshot
          </button>
          <button
            id="new-voter"
            class="inline-flex items-center gap-2 rounded-md bg-navy-700 px-4 py-2 text-white font-sans text-sm font-semibold hover:bg-navy-800 transition-colors"
            type="button"
            title="Clear credential and vote â€” election stays intact"
          >
            <Icon name="user-plus" class="text-white" size={18} />
            New Voter
          </button>
          <button
            id="reset"
            class="inline-flex items-center gap-2 rounded-md border border-red-300 px-4 py-2 text-red-600 font-sans text-sm font-semibold hover:bg-red-50 transition-colors"
            type="button"
            title="Destroy election and regenerate all keys"
          >
            <Icon name="x" class="text-red-500" size={18} />
            Reset Election
          </button>
        </div>

        <p id="controls-status" class="mt-3 text-sm text-navy-600"></p>

        <div class="mt-5 rounded-lg border border-navy-200 bg-cream-50 p-4" id="trustees-panel">
          <div class="flex items-start justify-between flex-wrap gap-2">
            <div>
              <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500">
                Trustee Shares (POC)
              </p>
              <p class="text-navy-600 text-sm mt-1">
                Select at least <span class="font-mono">t</span> shares to simulate threshold
                decryption at tally time.
              </p>
            </div>
            <p id="trustees-threshold" class="text-xs font-mono text-navy-500"></p>
          </div>
          <div class="mt-3 space-y-2" id="trustee-share-list"></div>
          <p class="text-navy-500 text-xs mt-3 italic">
            Note: in production, trustee shares are held by independent people/organizations and
            are never stored together in one place.
          </p>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="bb">
        <div class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="git-commit" class="text-gold-600" />
            Latest BB STH
          </h2>
          <p class="text-navy-600 text-sm mt-2">
            Every time a ballot is added, the bulletin board publishes a new <strong>Signed Tree
            Head</strong> &mdash; a cryptographic snapshot of all ballots received so far. If
            anyone deletes or alters a ballot later, the snapshot won't match, making tampering
            detectable.
          </p>
          <p class="text-navy-500 text-xs mt-1.5 italic">
            STH snapshots are recorded on the state node's distributed ledger as
            <code>bb_sth_published</code> events. In a real election, they would also be published
            to a public append-only log &mdash; independent monitors, media, and political parties
            could all download and compare tree heads to detect any inconsistency.
          </p>
          <pre
            class="mt-4 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="latest-sth">Loading...</code></pre>
        </div>
        <div class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="file-check" class="text-gold-600" />
            Published Tally (POC)
          </h2>
          <p class="text-navy-600 text-sm mt-2">
            Click <em>Publish POC Tally</em> above to decrypt all ballots and count the results.
          </p>
          <p class="text-navy-500 text-xs mt-1.5 italic">
            In this POC, each ballot is encrypted with a fresh per-ballot key and that key is
            wrapped to an election public key whose secret is split across trustees (t-of-n).
            Publishing the tally reconstructs the election secret from trustee shares and decrypts
            locally. In a real election, trustees would decrypt during a public ceremony and
            publish decryption proofs.
          </p>
          <pre
            class="mt-4 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="tally-json">Not published.</code></pre>

          <!-- ===== JOURNEY COMPLETION CTA (hidden until tally published) ===== -->
          <div id="tally-journey-prompt" class="hidden mt-6 rounded-xl border-2 border-green-400 bg-gradient-to-br from-green-50 to-cream-50 p-5 text-center">
            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-green-600 mb-3">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <p class="text-[10px] font-mono uppercase tracking-widest text-green-700 mb-1">Journey Complete</p>
            <p class="font-serif text-lg text-navy-900 font-bold">You've seen the full cycle.</p>
            <p class="text-navy-600 text-sm mt-1 max-w-sm mx-auto">
              Cast &rarr; Verify &rarr; Count. That's VoteChain end-to-end:
              cryptographic receipts, distributed ledger, public tally.
            </p>
            <div class="mt-4 flex flex-wrap justify-center gap-3">
              <a
                href="/votechain/poc"
                class="inline-flex items-center gap-2 rounded-lg bg-navy-800 px-5 py-2.5 text-gold-300 font-sans text-sm font-bold hover:bg-navy-700 transition-all shadow-md"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                Back to Overview
              </a>
              <a
                href="/votechain/faq"
                class="inline-flex items-center gap-2 rounded-lg border border-navy-200 bg-white px-5 py-2.5 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 transition-all"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                Read the FAQ
              </a>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md" id="fraud">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="alert-triangle" class="text-gold-600" />
            Fraud Flag Review Queue (POC)
          </h2>
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">cases only</p>
        </div>
        <p class="text-navy-600 text-sm mt-2">
          This queue simulates the reviewer workflow from the VoteChain PRD: triage, investigation,
          escalation, and resolution. Every reviewer action is recorded as an immutable ledger event
          on the distributed oversight node.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          Note: this is a demo. In a production system, reviewer actions would be role-gated,
          dual-controlled where required, and signed with reviewer credentials.
        </p>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-navy-800 text-cream-100">
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Flag Type</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Status</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Updated</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Case</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Nullifier</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Assigned</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Action</th
                >
              </tr>
            </thead>
            <tbody id="fraud-body" class="bg-white"></tbody>
          </table>
        </div>

        <div
          id="fraud-detail"
          class="mt-6 hidden rounded-xl border border-navy-200 bg-parchment p-5"
        >
          <div class="flex items-start justify-between flex-wrap gap-3">
            <div>
              <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">Selected case</p>
              <h3 id="fraud-case-title" class="font-serif text-lg text-navy-900 font-bold">
                -
              </h3>
            </div>
            <button
              id="fraud-close"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
              type="button"
            >
              <Icon name="x" class="text-navy-700" size={18} />
              Close
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
            <div class="bg-white rounded-lg border border-navy-200 p-4 shadow-sm">
              <div class="flex flex-wrap items-end gap-3">
                <div class="flex-1 min-w-[220px]">
                  <label
                    for="fraud-reviewer-id"
                    class="block text-xs font-mono text-navy-500 uppercase tracking-widest"
                    >Reviewer ID</label
                  >
                  <input
                    id="fraud-reviewer-id"
                    type="text"
                    class="mt-1 w-full rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-900 font-mono text-sm"
                    placeholder="reviewer_poc_1"
                    autocomplete="off"
                  />
                </div>
                <div class="flex-1 min-w-[220px]">
                  <label
                    for="fraud-reason"
                    class="block text-xs font-mono text-navy-500 uppercase tracking-widest"
                    >Reason Code (Optional)</label
                  >
                  <input
                    id="fraud-reason"
                    type="text"
                    class="mt-1 w-full rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-900 font-mono text-sm"
                    placeholder="e.g., EVIDENCE_CONFIRMED"
                    autocomplete="off"
                  />
                </div>
              </div>

              <div class="mt-3">
                <label
                  for="fraud-note"
                  class="block text-xs font-mono text-navy-500 uppercase tracking-widest"
                  >Note (Optional)</label
                >
                <textarea
                  id="fraud-note"
                  rows="3"
                  class="mt-1 w-full rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-900 font-sans text-sm"
                  placeholder="What did you check? What evidence did you rely on?"
                ></textarea>
              </div>

              <div class="mt-4 flex flex-wrap gap-2">
                <button
                  id="fraud-take"
                  class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-3 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
                  type="button"
                >
                  <Icon name="user" class="text-gold-300" size={18} />
                  Take / Triage
                </button>
                <button
                  id="fraud-investigate"
                  class="inline-flex items-center gap-2 rounded-md bg-gold-500 px-3 py-2 text-navy-900 font-sans text-sm font-semibold hover:bg-gold-400 transition-colors"
                  type="button"
                >
                  <Icon name="search" class="text-navy-900" size={18} />
                  Investigate
                </button>
                <button
                  id="fraud-escalate"
                  class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
                  type="button"
                >
                  <Icon name="git-pull-request" class="text-navy-700" size={18} />
                  Escalate
                </button>
                <button
                  id="fraud-clear"
                  class="inline-flex items-center gap-2 rounded-md bg-green-600 px-3 py-2 text-white font-sans text-sm font-semibold hover:bg-green-700 transition-colors"
                  type="button"
                >
                  <Icon name="check-circle" class="text-white" size={18} />
                  Clear
                </button>
                <button
                  id="fraud-confirm"
                  class="inline-flex items-center gap-2 rounded-md bg-red-600 px-3 py-2 text-white font-sans text-sm font-semibold hover:bg-red-700 transition-colors"
                  type="button"
                >
                  <Icon name="alert-triangle" class="text-white" size={18} />
                  Confirm Fraud
                </button>
                <button
                  id="fraud-system-error"
                  class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
                  type="button"
                >
                  <Icon name="cpu" class="text-navy-700" size={18} />
                  System Error
                </button>
                <button
                  id="fraud-note-btn"
                  class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
                  type="button"
                >
                  <Icon name="message-square" class="text-navy-700" size={18} />
                  Add Note
                </button>
              </div>

              <p id="fraud-status" class="mt-3 text-sm text-navy-700"></p>
            </div>

            <div class="bg-white rounded-lg border border-navy-200 p-4 shadow-sm">
              <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">Flag Payload</p>
              <pre
                class="mt-2 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="fraud-flag-json">-</code></pre>

              <p class="text-xs font-mono text-navy-500 uppercase tracking-widest mt-4"
                >Action History</p
              >
              <pre
                class="mt-2 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="fraud-actions-json">-</code></pre>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="list" class="text-gold-600" />
            VoteChain Ledger Events
          </h2>
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">newest first</p>
        </div>
        <p class="text-navy-600 text-sm mt-2">
          Every significant action &mdash; publishing the manifest, casting a ballot, issuing a
          tree head, publishing the tally, or flagging fraud &mdash; is recorded as a signed,
          immutable event on the VoteChain ledger. This is the public audit trail.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          Ledger events are recorded on 3 distributed Cloudflare Workers nodes (federal, state,
          oversight) with Durable Object append-only storage. In a real election, VoteChain would
          span many more independent nodes &mdash; election authorities, civil society organizations,
          and international observers &mdash; so that no single party could rewrite history without
          detection.
        </p>
        <div class="mt-4 overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-navy-800 text-cream-100">
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider">Type</th>
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Recorded</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider">Tx</th>
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Payload</th
                >
              </tr>
            </thead>
            <tbody id="events-body" class="bg-white"></tbody>
          </table>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="inbox" class="text-gold-600" />
            Bulletin Board Leaves
          </h2>
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">newest first</p>
        </div>
        <p class="text-navy-600 text-sm mt-2">
          Each encrypted ballot gets its own "leaf" on the bulletin board &mdash; an append-only
          list that anyone can inspect. You can see the encrypted ballot hashes here, but not the
          votes themselves. The leaf hash is the identifier voters use to verify their ballot is
          included.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          In this POC, BB leaves are stored locally in your browser. Each ballot cast is also
          anchored on the distributed ledger via an <code>ewp_ballot_cast</code> event.
          In a real election, the bulletin board would be a publicly accessible, append-only
          server &mdash; anyone could download the full list of leaves and independently verify
          the Merkle tree, ensuring no ballot was added, removed, or modified after acceptance.
        </p>
        <div class="mt-4 overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-navy-800 text-cream-100">
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Leaf Hash</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Received</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Ballot Hash</th
                >
              </tr>
            </thead>
            <tbody id="leaves-body" class="bg-white"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script>
    import {
      getDashboardSnapshot,
      getTrusteeShares,
      publishTally,
      resetPocState,
      invalidateCredential,
      reviewFraudFlag,
    } from '../../../votechain-poc';
    import type { PocFraudFlagAction, PocTrusteeShareRecord } from '../../../votechain-poc';

    type Hex0x = `0x${string}`;

    const mVerified = document.getElementById('m-verified') as HTMLElement;
    const mConflict = document.getElementById('m-conflict') as HTMLElement;
    const mSpoiled = document.getElementById('m-spoiled') as HTMLElement;
    const mLeaves = document.getElementById('m-leaves') as HTMLElement;
    const mEvents = document.getElementById('m-events') as HTMLElement;

    const latestSthEl = document.getElementById('latest-sth') as HTMLElement;
    const tallyEl = document.getElementById('tally-json') as HTMLElement;

    const eventsBody = document.getElementById('events-body') as HTMLElement;
    const leavesBody = document.getElementById('leaves-body') as HTMLElement;

    const fraudBody = document.getElementById('fraud-body') as HTMLElement;
    const fraudDetail = document.getElementById('fraud-detail') as HTMLElement;
    const fraudClose = document.getElementById('fraud-close') as HTMLButtonElement;
    const fraudCaseTitle = document.getElementById('fraud-case-title') as HTMLElement;
    const fraudFlagJson = document.getElementById('fraud-flag-json') as HTMLElement;
    const fraudActionsJson = document.getElementById('fraud-actions-json') as HTMLElement;
    const fraudReviewerId = document.getElementById('fraud-reviewer-id') as HTMLInputElement;
    const fraudReason = document.getElementById('fraud-reason') as HTMLInputElement;
    const fraudNote = document.getElementById('fraud-note') as HTMLTextAreaElement;
    const fraudStatus = document.getElementById('fraud-status') as HTMLElement;
    const fraudTake = document.getElementById('fraud-take') as HTMLButtonElement;
    const fraudInvestigate = document.getElementById('fraud-investigate') as HTMLButtonElement;
    const fraudEscalate = document.getElementById('fraud-escalate') as HTMLButtonElement;
    const fraudClear = document.getElementById('fraud-clear') as HTMLButtonElement;
    const fraudConfirm = document.getElementById('fraud-confirm') as HTMLButtonElement;
    const fraudSystemError = document.getElementById('fraud-system-error') as HTMLButtonElement;
    const fraudNoteBtn = document.getElementById('fraud-note-btn') as HTMLButtonElement;

    const refreshBtn = document.getElementById('refresh') as HTMLButtonElement;
    const publishBtn = document.getElementById('publish-tally') as HTMLButtonElement;
    const exportBtn = document.getElementById('export') as HTMLButtonElement;
    const newVoterBtn = document.getElementById('new-voter') as HTMLButtonElement;
    const resetBtn = document.getElementById('reset') as HTMLButtonElement;
    const statusEl = document.getElementById('controls-status') as HTMLElement;

    const trusteesThresholdEl = document.getElementById('trustees-threshold') as HTMLElement;
    const trusteeShareList = document.getElementById('trustee-share-list') as HTMLElement;

    let selectedFraudCaseId: Hex0x | null = null;
    let trusteeBundle: { threshold: { t: number; n: number }; shares: PocTrusteeShareRecord[] } | null =
      null;
    const selectedTrusteeIds = new Set<string>();

    function short(value: unknown, n: number = 10) {
      if (!value || typeof value !== 'string') return '';
      if (value.length <= n * 2 + 3) return value;
      return `${value.slice(0, n)}...${value.slice(-n)}`;
    }

    function td(text: string, className?: string) {
      const cell = document.createElement('td');
      cell.className = className || 'px-3 py-2 border-b border-navy-100 align-top';
      cell.textContent = text;
      return cell;
    }

    function tdCode(text: string) {
      const cell = document.createElement('td');
      cell.className =
        'px-3 py-2 border-b border-navy-100 align-top font-mono text-xs text-navy-800';
      cell.textContent = text;
      return cell;
    }

    function renderTrusteeShares(bundle: {
      threshold: { t: number; n: number };
      shares: PocTrusteeShareRecord[];
    }) {
      trusteeBundle = bundle;
      trusteesThresholdEl.textContent = `t=${bundle.threshold.t} of n=${bundle.threshold.n}`;

      if (selectedTrusteeIds.size === 0) {
        for (const s of bundle.shares.slice(0, bundle.threshold.t)) selectedTrusteeIds.add(s.id);
      }

      trusteeShareList.replaceChildren();
      for (const s of bundle.shares) {
        const row = document.createElement('div');
        row.className =
          'flex items-center gap-3 rounded-md border border-navy-200 bg-white px-3 py-2';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'h-4 w-4 accent-gold-500';
        cb.checked = selectedTrusteeIds.has(s.id);
        cb.addEventListener('change', () => {
          if (cb.checked) selectedTrusteeIds.add(s.id);
          else selectedTrusteeIds.delete(s.id);
        });

        const id = document.createElement('span');
        id.className = 'font-mono text-xs text-navy-900';
        id.textContent = s.id;

        const x = document.createElement('span');
        x.className = 'font-mono text-[11px] text-navy-500';
        x.textContent = `x=${s.x}`;

        const share = document.createElement('span');
        share.className = 'font-mono text-xs text-navy-700 break-all';
        share.textContent = short(s.share, 12);

        row.appendChild(cb);
        row.appendChild(id);
        row.appendChild(x);
        row.appendChild(share);
        trusteeShareList.appendChild(row);
      }
    }

    function getSelectedShares(): PocTrusteeShareRecord[] {
      if (!trusteeBundle) return [];
      return trusteeBundle.shares.filter((s) => selectedTrusteeIds.has(s.id));
    }

    function statusBadge(status: string) {
      const badge = document.createElement('span');
      const s = status || 'unknown';
      const resolved = s.startsWith('resolved_');
      const cls = resolved
        ? 'bg-green-100 text-green-800 border-green-200'
        : s === 'escalated'
          ? 'bg-red-100 text-red-800 border-red-200'
          : s === 'investigating'
            ? 'bg-gold-100 text-navy-900 border-gold-200'
            : s === 'triaged'
              ? 'bg-navy-100 text-navy-900 border-navy-200'
              : 'bg-cream-100 text-navy-900 border-navy-200';
      badge.className = `inline-flex items-center rounded-full border px-2 py-0.5 font-mono text-[11px] ${cls}`;
      badge.textContent = s;
      return badge;
    }

    function showFraudDetail(caseData: any) {
      if (!caseData) {
        selectedFraudCaseId = null;
        fraudDetail?.classList.add('hidden');
        return;
      }

      selectedFraudCaseId = String(caseData.case_id || '') as Hex0x;
      fraudDetail?.classList.remove('hidden');

      fraudCaseTitle.textContent = `${caseData.flag_type || 'unknown'} (${caseData.status || 'unknown'})`;
      fraudFlagJson.textContent = JSON.stringify(caseData.flag_payload || {}, null, 2);
      fraudActionsJson.textContent = JSON.stringify(caseData.actions || [], null, 2);
    }

    function renderFraudQueue(cases: any[]) {
      fraudBody.replaceChildren();

      if (!cases || cases.length === 0) {
        const tr = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.className = 'px-3 py-4 border-b border-navy-100 text-sm text-navy-600';
        cell.textContent = 'No fraud flags recorded yet. Trigger one by attempting a duplicate cast.';
        tr.appendChild(cell);
        fraudBody.appendChild(tr);
        showFraudDetail(null);
        return;
      }

      for (const c of cases) {
        const tr = document.createElement('tr');

        tr.appendChild(
          td(String(c.flag_type || 'unknown'), 'px-3 py-2 border-b border-navy-100 align-top'),
        );

        const statusCell = document.createElement('td');
        statusCell.className = 'px-3 py-2 border-b border-navy-100 align-top';
        statusCell.appendChild(statusBadge(String(c.status || 'unknown')));
        tr.appendChild(statusCell);

        tr.appendChild(
          td(String(c.updated_at || ''), 'px-3 py-2 border-b border-navy-100 align-top text-xs text-navy-700'),
        );
        tr.appendChild(tdCode(short(String(c.case_id || ''), 8)));
        tr.appendChild(tdCode(short(String(c.nullifier || ''), 8)));
        tr.appendChild(
          td(String(c.assigned_to || ''), 'px-3 py-2 border-b border-navy-100 align-top text-xs text-navy-700'),
        );

        const actionCell = document.createElement('td');
        actionCell.className = 'px-3 py-2 border-b border-navy-100 align-top';
        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className =
          'inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-xs font-semibold hover:border-gold-500 hover:shadow-sm transition-all';
        openBtn.textContent = 'Open';
        openBtn.addEventListener('click', () => showFraudDetail(c));
        actionCell.appendChild(openBtn);
        tr.appendChild(actionCell);

        fraudBody.appendChild(tr);
      }

      if (selectedFraudCaseId) {
        const selected =
          cases.find((c) => String(c.case_id) === String(selectedFraudCaseId)) ?? null;
        if (selected) showFraudDetail(selected);
        else showFraudDetail(null);
      }
    }

    async function runFraudAction(action: PocFraudFlagAction) {
      if (!selectedFraudCaseId) return;

      const reviewer_id = (fraudReviewerId?.value || '').trim();
      const reason_code = (fraudReason?.value || '').trim();
      const note = (fraudNote?.value || '').trim();

      if (!reviewer_id) {
        fraudStatus.textContent = 'Reviewer ID is required.';
        return;
      }

      localStorage.setItem('votechain_poc_reviewer_id', reviewer_id);
      fraudStatus.textContent = 'Recording reviewer action on ledger...';

      const res = await reviewFraudFlag({
        case_id: selectedFraudCaseId,
        reviewer_id,
        action,
        ...(reason_code ? { reason_code } : {}),
        ...(note ? { note } : {}),
      });

      if ('error' in res) {
        fraudStatus.textContent = res.error;
        return;
      }

      fraudStatus.textContent = 'Action recorded.';
      fraudReason.value = '';
      fraudNote.value = '';
      await refresh();
    }

    function render(snapshot: any) {
      mVerified.textContent = String(snapshot.metrics.verified);
      mConflict.textContent = String(snapshot.metrics.crypto_conflict);
      mSpoiled.textContent = String(snapshot.metrics.spoiled);
      mLeaves.textContent = String(snapshot.bb.leaf_count);
      mEvents.textContent = String(snapshot.vcl.event_count);

      latestSthEl.textContent = snapshot.bb.latest_sth
        ? JSON.stringify(snapshot.bb.latest_sth, null, 2)
        : 'None';
      tallyEl.textContent = snapshot.tally
        ? JSON.stringify(snapshot.tally, null, 2)
        : 'Not published.';

      // Show/hide journey completion prompt based on tally state
      const tallyPrompt = document.getElementById('tally-journey-prompt');
      if (tallyPrompt) {
        if (snapshot.tally) {
          tallyPrompt.classList.remove('hidden');
        } else {
          tallyPrompt.classList.add('hidden');
        }
      }

      eventsBody.replaceChildren();
      for (const evt of snapshot.events) {
        const tr = document.createElement('tr');
        tr.appendChild(
          td(evt.type, 'px-3 py-2 border-b border-navy-100 align-top font-mono text-xs'),
        );
        tr.appendChild(
          td(evt.recorded_at, 'px-3 py-2 border-b border-navy-100 align-top text-xs text-navy-700'),
        );
        tr.appendChild(tdCode(short(evt.tx_id, 8)));
        tr.appendChild(tdCode(short(JSON.stringify(evt.payload), 24)));
        eventsBody.appendChild(tr);
      }

      leavesBody.replaceChildren();
      for (const leaf of snapshot.leaves) {
        const tr = document.createElement('tr');
        const received = leaf.payload?.received_at ? String(leaf.payload.received_at) : '';
        const ballotHash = leaf.payload?.encrypted_ballot?.ballot_hash
          ? String(leaf.payload.encrypted_ballot.ballot_hash)
          : '';
        tr.appendChild(tdCode(short(leaf.leaf_hash, 12)));
        tr.appendChild(
          td(received, 'px-3 py-2 border-b border-navy-100 align-top text-xs text-navy-700'),
        );
        tr.appendChild(tdCode(short(ballotHash, 12)));
        leavesBody.appendChild(tr);
      }

      renderFraudQueue(snapshot.fraud_cases || []);
    }

    async function refresh() {
      const [snapshot, trustees] = await Promise.all([getDashboardSnapshot(), getTrusteeShares()]);
      render(snapshot);
      renderTrusteeShares(trustees);
      statusEl.textContent = `Updated: ${new Date().toLocaleString()}`;
    }

    // Reviewer identity persistence for the demo UI
    if (fraudReviewerId) {
      fraudReviewerId.value = localStorage.getItem('votechain_poc_reviewer_id') || 'reviewer_poc_1';
      fraudReviewerId.addEventListener('change', () => {
        localStorage.setItem('votechain_poc_reviewer_id', fraudReviewerId.value);
      });
    }

    fraudClose?.addEventListener('click', () => {
      selectedFraudCaseId = null;
      fraudDetail?.classList.add('hidden');
      fraudStatus.textContent = '';
    });

    fraudTake?.addEventListener('click', () => runFraudAction('take_case'));
    fraudInvestigate?.addEventListener('click', () => runFraudAction('start_investigation'));
    fraudEscalate?.addEventListener('click', () => runFraudAction('escalate'));
    fraudClear?.addEventListener('click', () => runFraudAction('resolve_cleared'));
    fraudConfirm?.addEventListener('click', () => runFraudAction('resolve_confirmed_fraud'));
    fraudSystemError?.addEventListener('click', () => runFraudAction('resolve_system_error'));
    fraudNoteBtn?.addEventListener('click', () => runFraudAction('note'));

    refreshBtn?.addEventListener('click', () => refresh());

    publishBtn?.addEventListener('click', async () => {
      publishBtn.disabled = true;
      statusEl.textContent = 'Publishing tally...';
      try {
        const shares = getSelectedShares();
        if (trusteeBundle && shares.length < trusteeBundle.threshold.t) {
          statusEl.textContent = `Select at least ${trusteeBundle.threshold.t} trustee shares.`;
          return;
        }

        const res = trusteeBundle ? await publishTally({ shares }) : await publishTally();
        if ('error' in res) {
          statusEl.textContent = res.error;
        } else {
          statusEl.textContent = 'Tally published and anchored.';
          window.dispatchEvent(new CustomEvent('votechain:state-changed'));
        }
      } finally {
        publishBtn.disabled = false;
        await refresh();
      }
    });

    exportBtn?.addEventListener('click', async () => {
      const snapshot = await getDashboardSnapshot();
      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `votechain-poc-snapshot-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    newVoterBtn?.addEventListener('click', () => {
      invalidateCredential();
      window.location.reload();
    });

    resetBtn?.addEventListener('click', () => {
      resetPocState();
      window.location.reload();
    });

    refresh();
  </script>
</BaseLayout>
