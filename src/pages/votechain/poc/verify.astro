---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Divider from '../../../components/ui/Divider.astro';
import Icon from '../../../components/ui/Icon.astro';
import PocHarnessShell from '../../../components/votechain/poc/PocHarnessShell.astro';
import PocVotingClientModal from '../../../components/votechain/poc/PocVotingClientModal.astro';
---

<BaseLayout
  title="VoteChain POC Receipt Verification"
  description="Verify a VoteChain EWP cast receipt: signatures, bulletin board inclusion, and VoteChain anchor."
  ogType="article"
  article={{
    publishedTime: '2026-02-08',
    author: 'Absurdity Index',
    section: 'Policy',
    tags: ['votechain', 'ewp', 'poc', 'verification'],
  }}
>
  <main
    id="poc-verify-main"
    class="bg-parchment min-h-screen"
    role="main"
    aria-labelledby="poc-verify-title"
  >
    <PocHarnessShell
      current="verify"
      title="Receipt Verification"
      subtitle="Run signature, Merkle proof, and ledger anchor checks"
    />

    <header class="max-w-5xl mx-auto px-4 pt-6">
      <p class="text-xs text-gold-600 font-mono uppercase tracking-widest mb-1">Step 2 &middot; Receipt Verification</p>
      <h1 id="poc-verify-title" class="font-serif text-3xl text-navy-900 font-bold">
        Verify your cast receipt end-to-end
      </h1>
      <p class="text-navy-600 text-sm mt-2 max-w-3xl">
        Run the four independent checks &mdash; signature validity, bulletin-board inclusion, Merkle proof,
        and VoteChain ledger anchor &mdash; without leaving the harness. The status banner below announces every
        result via <span class="font-mono">aria-live</span> updates, so screen-reader users get the same confirmation.
      </p>
    </header>

    <div class="max-w-5xl mx-auto px-4 py-6 sm:py-8 space-y-8">
      <!-- Wizard Step 1: Load Receipt -->
      <section data-poc-step="1" data-poc-step-label="Load Receipt">
        <div class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
              <Icon name="receipt" class="text-gold-600" />
              Cast Receipt
            </h2>
          </div>

          <p class="text-navy-600 text-sm mt-2" data-poc-brief>
            Your receipt is auto-loaded below. Click <strong>Verify</strong> to run four
            independent cryptographic checks.
            <a href="#" data-poc-learn-more class="text-gold-600 hover:text-gold-700 text-xs font-semibold ml-1">Learn more</a>
          </p>
          <p class="text-navy-600 text-sm mt-2" data-poc-detail="verify-how" data-poc-detail-title="How Verification Works">
            <strong>What to do:</strong> Your most recent receipt has been auto-loaded from your
            browser's <span class="font-mono">localStorage</span> below. Click <em>Verify</em>
            to run the checks. Each check independently confirms a different layer of the system
            recorded your ballot correctly.
          </p>
          <p class="text-navy-600 text-sm mt-1.5" data-poc-detail="verify-checks" data-poc-detail-title="What the Checks Mean">
            <strong>What the checks mean:</strong> The verifier confirms that (1) the receipt's
            signature is authentic, (2) the bulletin board's tree head was properly signed,
            (3) your ballot is provably included in the Merkle tree, and (4) a matching anchor
            event exists on the VoteChain ledger. All checks must pass for full confidence.
          </p>
          <p class="text-navy-500 text-xs mt-1.5 italic" data-poc-detail="verify-poc-note" data-poc-detail-title="POC Note">
            Verification checks your receipt against local state and the distributed
            ledger nodes. Ledger ack verification queries Workers nodes directly (public reads).
          </p>
          <p class="text-navy-600 text-sm mt-2" data-poc-detail="verify-real" data-poc-detail-title="In a Real Election">
            <strong>In a real election:</strong> Verification would check your receipt against
            independently operated services &mdash; the bulletin board (run by the election
            authority), the VoteChain ledger (a distributed, append-only record), and the
            signed tree heads (published publicly for anyone to audit). Because these services
            are separate and monitored by multiple parties, a single compromised server could
            not forge a valid receipt or hide a missing ballot.
          </p>

          <div
            id="verify-state"
            class="mt-4 rounded-lg border border-navy-200 bg-white/90 p-4"
            role="status"
            aria-live="polite"
          >
            <p id="verify-state-title" class="font-sans text-sm font-semibold text-navy-900">
              Waiting for receipt.
            </p>
            <p id="verify-state-desc" class="text-xs text-navy-600 mt-0.5">
              Load the most recent receipt or paste JSON, then click Verify to run all tests.
            </p>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button
              id="load-last"
              class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-4 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
              type="button"
            >
              <Icon name="inbox" class="text-gold-300" size={18} />
              Load Last Receipt
            </button>
            <button
              id="verify-btn"
              class="inline-flex items-center gap-2 rounded-md bg-gold-500 px-4 py-2 text-navy-900 font-sans text-sm font-semibold hover:bg-gold-400 transition-colors"
              type="button"
            >
              <Icon name="shield" class="text-navy-900" size={18} />
              <span data-button-label>Verify</span>
            </button>
          </div>

          <textarea
            id="receipt-input"
            class="mt-4 w-full min-h-[220px] rounded-lg border border-navy-200 bg-cream-50 p-4 font-mono text-xs text-navy-900 focus:outline-none focus:ring-2 focus:ring-gold-400"
            placeholder="Paste cast_receipt JSON here..."></textarea>
        </div>
      </section>

      <!-- Wizard Step 2: Results -->
      <section data-poc-step="2" data-poc-step-label="Results" hidden>
        <div class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
          <Divider withSeal={false} />

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="min-w-0">
              <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-2">
                Verification Result
              </p>
              <div id="verify-summary" class="rounded-lg border border-navy-200 bg-white p-4">
                <p class="text-navy-600 text-sm">Waiting for receipt.</p>
              </div>
            </div>
            <div class="min-w-0">
              <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-2">
                Inclusion Proof
              </p>
              <pre
                class="rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="proof-json">Waiting...</code></pre>
            </div>
          </div>
        </div>

        <!-- ===== JOURNEY CONTINUATION CTA (hidden until verification passes) ===== -->
        <div id="verify-journey-prompt" class="hidden mt-4" data-poc-detail="verify-journey-cta" data-poc-detail-title="Next Steps">
          <div class="rounded-xl border-2 border-gold-400 bg-gradient-to-br from-gold-50 to-cream-50 p-6 text-center shadow-lg">
            <p class="text-[10px] font-mono uppercase tracking-widest text-gold-600 mb-1">Step 2 Complete</p>
            <p class="font-serif text-lg text-navy-900 font-bold">Your receipt checks out.</p>
            <p class="text-navy-600 text-sm mt-1 max-w-md mx-auto">
              Every cryptographic check passed. Your ballot is provably in the count.
              Now see the full picture &mdash; publish the tally and watch the results.
            </p>
            <button
              type="button"
              data-open-client-modal
              data-client-key="dashboard"
              data-client-title="Reveal & Tally"
              data-client-path="/votechain/poc/dashboard"
              class="mt-4 inline-flex items-center gap-2 rounded-lg bg-navy-800 px-6 py-3 text-gold-300 font-sans text-sm font-bold hover:bg-navy-700 transition-all shadow-md hover:shadow-lg group"
              aria-haspopup="dialog"
              aria-controls="poc-voting-client-modal"
            >
              Continue to Step 3: Watch the Count
              <Icon name="arrow-right" class="text-gold-400 transition-transform group-hover:translate-x-0.5" size={18} />
            </button>
            <p class="text-navy-400 text-xs mt-3 italic">
              Or explore the
            <a
              href="/votechain/poc/lookup"
              class="text-gold-600 hover:text-gold-700 underline"
              data-open-client-modal
              data-client-key="lookup"
              data-client-title="Board Audit"
              data-client-path="/votechain/poc/lookup"
              aria-haspopup="dialog"
              aria-controls="poc-voting-client-modal"
            >Board Audit</a> tool
            </p>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md" data-poc-detail="verify-notes" data-poc-detail-title="Verification Notes">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="info" class="text-gold-600" />
          Notes
        </h2>
        <div class="mt-3 text-navy-700 text-sm space-y-2">
          <p>
            <strong>Why this matters:</strong> In traditional elections, you trust officials to
            count your ballot correctly. With VoteChain, every voter gets a cryptographic receipt
            that lets them independently prove their vote was included &mdash; without revealing
            how they voted. This is called "recorded-as-cast" verification.
          </p>
          <p>
            <strong>POC note:</strong> The bulletin board is stored locally in your browser.
            The VCL ledger runs on distributed Cloudflare Workers nodes &mdash; verification
            checks your receipt's ledger acknowledgments against these nodes directly.
            In a production system, the bulletin board would also be an independent network
            service monitored by multiple parties.
          </p>
        </div>
      </section>
    </div>
    <PocVotingClientModal />
  </main>

  <script>
    import { verifyReceipt } from '../../../votechain-poc';

    const receiptInput = document.getElementById('receipt-input') as HTMLTextAreaElement;
    const loadLastBtn = document.getElementById('load-last') as HTMLButtonElement;
    const verifyBtn = document.getElementById('verify-btn') as HTMLButtonElement;
    const summaryEl = document.getElementById('verify-summary') as HTMLElement;
    const proofEl = document.getElementById('proof-json') as HTMLElement;
    const journeyPrompt = document.getElementById('verify-journey-prompt');
    const verifyState = document.getElementById('verify-state') as HTMLElement;
    const verifyStateTitle = document.getElementById('verify-state-title') as HTMLElement;
    const verifyStateDesc = document.getElementById('verify-state-desc') as HTMLElement;
    const verifyBtnLabel = verifyBtn?.querySelector<HTMLElement>('[data-button-label]') ?? null;
    type VerifyState = 'idle' | 'loading' | 'success' | 'error';
    let verifyBusy = false;

    function el(tag: keyof HTMLElementTagNameMap, className?: string, text?: string) {
      const node = document.createElement(tag);
      if (className) node.className = className;
      if (text !== undefined) node.textContent = text;
      return node;
    }

    function badge(status: 'ok' | 'fail') {
      const ok = status === 'ok';
      return el(
        'span',
        ok
          ? 'inline-flex items-center rounded-full bg-green-600/15 px-2.5 py-1 text-xs font-semibold text-green-700'
          : 'inline-flex items-center rounded-full bg-red-600/15 px-2.5 py-1 text-xs font-semibold text-red-700',
        ok ? 'OK' : 'FAIL',
      );
    }

    function setVerifyState(state: VerifyState, title: string, detail: string) {
      const palette: Record<VerifyState, { wrapper: string; title: string; desc: string }> = {
        idle: {
          wrapper: 'border border-navy-200 bg-white/90',
          title: 'text-navy-900',
          desc: 'text-navy-600',
        },
        loading: {
          wrapper: 'border border-gold-300 bg-gold-50',
          title: 'text-gold-900',
          desc: 'text-gold-700',
        },
        success: {
          wrapper: 'border border-green-300 bg-green-50',
          title: 'text-green-900',
          desc: 'text-green-700',
        },
        error: {
          wrapper: 'border border-red-300 bg-red-50',
          title: 'text-red-900',
          desc: 'text-red-700',
        },
      };
      const base = 'mt-4 rounded-lg p-4';
      verifyState.className = `${base} ${palette[state].wrapper}`;
      verifyStateTitle.className = `font-sans text-sm font-semibold ${palette[state].title}`;
      verifyStateDesc.className = `text-xs mt-0.5 ${palette[state].desc}`;
      verifyStateTitle.textContent = title;
      verifyStateDesc.textContent = detail;
    }

    function hideJourneyPrompt() {
      if (journeyPrompt) journeyPrompt.classList.add('hidden');
    }

    function renderResult(result: any) {
      summaryEl.replaceChildren();

      const header = el('div', 'flex items-center justify-between gap-3 flex-wrap');
      header.appendChild(el('p', 'font-sans text-sm font-semibold text-navy-900', 'Overall'));
      header.appendChild(badge(result.status));
      summaryEl.appendChild(header);

      const list = el('div', 'mt-3 space-y-2');
      for (const check of result.checks) {
        const row = el(
          'div',
          'flex items-start justify-between gap-3 border-t border-navy-100 pt-2',
        );
        const left = el('div', 'min-w-0');
        left.appendChild(el('p', 'font-mono text-xs text-navy-800', check.name));
        if (check.details) left.appendChild(el('p', 'text-xs text-navy-500 mt-0.5 break-all', check.details));
        row.appendChild(left);
        row.appendChild(badge(check.status));
        list.appendChild(row);
      }
      summaryEl.appendChild(list);

      proofEl.textContent = result.inclusion_proof
        ? JSON.stringify(result.inclusion_proof, null, 2)
        : 'N/A';

      // Advance wizard to Results step and show journey CTA if all passed
      window.dispatchEvent(new CustomEvent('poc-wizard:goto', { detail: { step: 1 } }));

      if (journeyPrompt) {
        if (result.status === 'ok') {
          journeyPrompt.classList.remove('hidden');
          setTimeout(() => {
            journeyPrompt.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 400);
        } else {
          journeyPrompt.classList.add('hidden');
        }
      }
    }

    async function runVerification() {
      if (verifyBusy) return;
      verifyBusy = true;
      verifyBtn.disabled = true;
      if (verifyBtnLabel) verifyBtnLabel.textContent = 'Verifying...';
      summaryEl.replaceChildren();
      proofEl.textContent = 'Working...';
      hideJourneyPrompt();
      setVerifyState(
        'loading',
        'Verifying receipt...',
        'Running signature, Merkle inclusion, and ledger anchor checks.',
      );

      const rawReceipt = receiptInput.value.trim();
      if (!rawReceipt) {
        summaryEl.appendChild(
          el('p', 'text-red-700 text-sm', 'Paste cast_receipt JSON before running verification.'),
        );
        proofEl.textContent = 'N/A';
        setVerifyState('error', 'Receipt required.', 'Paste the JSON receipt and try again.');
        verifyBtn.disabled = false;
        if (verifyBtnLabel) verifyBtnLabel.textContent = 'Verify';
        verifyBusy = false;
        return;
      }

      let receipt: unknown;
      try {
        receipt = JSON.parse(rawReceipt);
      } catch (err) {
        summaryEl.appendChild(el('p', 'text-red-700 text-sm', `Invalid JSON: ${String(err)}`));
        proofEl.textContent = 'N/A';
        setVerifyState(
          'error',
          'Invalid receipt JSON.',
          'Fix the JSON syntax (quotes, braces) and try again.',
        );
        verifyBtn.disabled = false;
        if (verifyBtnLabel) verifyBtnLabel.textContent = 'Verify';
        verifyBusy = false;
        return;
      }

      try {
        const result = await verifyReceipt(receipt as any);
        renderResult(result);
        if (result.status === 'ok') {
          setVerifyState(
            'success',
            'Receipt verified.',
            'All checks passed. Continue to Step 3 to watch the tally.',
          );
        } else {
          setVerifyState(
            'error',
            'Verification issues detected.',
            'Review the failing checks below and resolve before continuing.',
          );
        }
      } catch (err) {
        summaryEl.appendChild(
          el('p', 'text-red-700 text-sm', `Verification failed: ${String(err)}`),
        );
        proofEl.textContent = 'N/A';
        setVerifyState(
          'error',
          'Verification failed.',
          'Retry after reloading the receipt or resetting the demo session.',
        );
      } finally {
        verifyBtn.disabled = false;
        if (verifyBtnLabel) verifyBtnLabel.textContent = 'Verify';
        verifyBusy = false;
      }
    }

    // Auto-load last receipt on page load
    (function autoLoadReceipt() {
      const raw = localStorage.getItem('votechain_poc_last_receipt');
      if (raw) {
        receiptInput.value = raw;
        const notice = el('p', 'text-sm text-gold-700 font-sans mt-2', 'Loaded your last cast receipt automatically.');
        notice.id = 'auto-load-notice';
        receiptInput.parentElement?.insertBefore(notice, receiptInput.nextSibling);

        // Auto-verify if coming from the journey flow (receipt exists)
        setTimeout(() => runVerification(), 300);
      }
    })();

    loadLastBtn?.addEventListener('click', () => {
      const raw = localStorage.getItem('votechain_poc_last_receipt');
      if (!raw) return;
      receiptInput.value = raw;
      if (!document.getElementById('auto-load-notice')) {
        const notice = el('p', 'text-sm text-gold-700 font-sans mt-2', 'Receipt loaded.');
        notice.id = 'auto-load-notice';
        receiptInput.parentElement?.insertBefore(notice, receiptInput.nextSibling);
      }
    });

    verifyBtn?.addEventListener('click', () => runVerification());
    setVerifyState(
      'idle',
      'Waiting for receipt.',
      'Load the most recent receipt or paste JSON before verifying.',
    );
  </script>
</BaseLayout>
