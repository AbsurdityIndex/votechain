---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import OfficialSeal from '../../../components/ui/OfficialSeal.astro';
import Divider from '../../../components/ui/Divider.astro';
import Icon from '../../../components/ui/Icon.astro';
import JourneyStepBar from '../../../components/votechain/JourneyStepBar.astro';
---

<BaseLayout
  title="VoteChain POC Voting Client"
  description="POC voter client for the VoteChain Election Web Protocol (EWP): challenge + cast + receipt."
  ogType="article"
  article={{
    publishedTime: '2026-02-08',
    author: 'Absurdity Index',
    section: 'Policy',
    tags: ['votechain', 'ewp', 'poc', 'receipt verification'],
  }}
>
  <JourneyStepBar currentStep={1} />
  <main class="bg-parchment min-h-screen">
    <!-- Compact hero bar -->
    <section class="bg-navy-900 py-3">
      <div class="max-w-5xl mx-auto px-4 flex items-center gap-3">
        <OfficialSeal size="32" />
        <div>
          <p class="text-[10px] text-gold-500 font-mono uppercase tracking-widest leading-none">EWP POC</p>
          <h1 class="font-serif text-lg sm:text-xl text-gold-400 font-bold leading-tight">Voting Client</h1>
        </div>
      </div>
    </section>

    <!-- Step indicator (sticky below header + subnav via --sticky-offset) -->
    <div id="step-indicator-bar" class="bg-parchment border-b border-navy-200 py-3 sticky z-20 shadow-sm" style="top: var(--sticky-offset, 0px);">
      <div class="flex items-center justify-between max-w-3xl mx-auto px-4" id="step-indicator">
        <div class="flex flex-col items-center shrink-0" data-step="1">
          <div
            class="step-circle w-8 h-8 rounded-full flex items-center justify-center font-sans font-semibold text-sm bg-navy-200 text-navy-500 transition-all"
          >
            1
          </div>
          <p class="font-mono text-[10px] uppercase tracking-wider mt-1.5 text-navy-500">
            Credential
          </p>
        </div>
        <div class="step-connector flex-1 h-0.5 mx-2 bg-navy-200 transition-all"></div>
        <div class="flex flex-col items-center shrink-0" data-step="2">
          <div
            class="step-circle w-8 h-8 rounded-full flex items-center justify-center font-sans font-semibold text-sm bg-navy-200 text-navy-500 transition-all"
          >
            2
          </div>
          <p class="font-mono text-[10px] uppercase tracking-wider mt-1.5 text-navy-500">
            Challenge
          </p>
        </div>
        <div class="step-connector flex-1 h-0.5 mx-2 bg-navy-200 transition-all"></div>
        <div class="flex flex-col items-center shrink-0" data-step="3">
          <div
            class="step-circle w-8 h-8 rounded-full flex items-center justify-center font-sans font-semibold text-sm bg-navy-200 text-navy-500 transition-all"
          >
            3
          </div>
          <p
            class="font-mono text-[10px] uppercase tracking-wider mt-1.5 text-navy-500 hidden sm:block"
          >
            Encrypt & Review
          </p>
          <p class="font-mono text-[10px] uppercase tracking-wider mt-1.5 text-navy-500 sm:hidden">
            Encrypt
          </p>
        </div>
        <div class="step-connector flex-1 h-0.5 mx-2 bg-navy-200 transition-all"></div>
        <div class="flex flex-col items-center shrink-0" data-step="4">
          <div
            class="step-circle w-8 h-8 rounded-full flex items-center justify-center font-sans font-semibold text-sm bg-navy-200 text-navy-500 transition-all"
          >
            4
          </div>
          <p class="font-mono text-[10px] uppercase tracking-wider mt-1.5 text-navy-500">Cast</p>
        </div>
      </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 py-6 sm:py-8 space-y-6 pb-28">

      <!-- Wizard step container -->
      <div id="wizard-step-container" class="space-y-6">
      <!-- Step 1: Credential -->
      <section
        class="bg-white rounded-xl border border-navy-200 p-5 sm:p-6 shadow-md"
        id="credential"
      >
        <h2 class="font-serif text-lg text-navy-900 font-bold flex items-center gap-2">
          <Icon name="user" class="text-gold-600" />
          Voter Credential (POC)
        </h2>
        <details class="mt-2 text-sm text-navy-600">
          <summary class="cursor-pointer text-navy-500 hover:text-navy-700 font-sans text-xs font-semibold uppercase tracking-wider">How it works</summary>
          <div class="mt-2 space-y-1.5">
            <p>
              <strong>What:</strong> Click <strong>Generate Credential</strong> in the wizard controls
              below. This gives you a unique, anonymous ID and a cryptographic signing key &mdash;
              stored in your browser (keys stay local; the issuance event is recorded on the distributed ledger).
            </p>
            <p>
              <strong>Why:</strong> Your credential lets you prove you're eligible to vote without revealing
              who you are. The <em>nullifier</em> is a one-time-use fingerprint tied to this election
              &mdash; it prevents double-voting while keeping your identity private.
            </p>
            <p>
              <strong>In this POC:</strong> Your credential is certified by the registration authority
              using a <em>blind Schnorr signature</em> &mdash; the authority signs your public key
              without learning which key it signed. This breaks the link between registration and
              voting.
            </p>
          </div>
        </details>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-3">
            <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-1">DID</p>
            <p id="credential-did" class="font-mono text-xs text-navy-900 wrap-break-word">
              Not generated
            </p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-3">
            <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-1">
              Nullifier (This Election)
            </p>
            <p id="credential-nullifier" class="font-mono text-xs text-navy-900 wrap-break-word">
              Not generated
            </p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-3">
            <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-1">
              Blind Signature (Issuer)
            </p>
            <p id="credential-blind-sig" class="font-mono text-xs text-navy-900 wrap-break-word">
              Not generated
            </p>
          </div>
        </div>
      </section>

      <!-- Step 2: Challenge -->
      <section
        class="bg-white rounded-xl border border-navy-200 p-5 sm:p-6 shadow-md hidden"
        id="challenge"
      >
        <h2 class="font-serif text-lg text-navy-900 font-bold flex items-center gap-2">
          <Icon name="repeat" class="text-gold-600" />
          Challenge (Anti-Replay)
        </h2>
        <details class="mt-2 text-sm text-navy-600">
          <summary class="cursor-pointer text-navy-500 hover:text-navy-700 font-sans text-xs font-semibold uppercase tracking-wider">How it works</summary>
          <div class="mt-2 space-y-1.5">
            <p>
              <strong>What:</strong> Click <strong>Request Challenge</strong> below. This one-time code
              will be baked into your ballot to prove it was cast right now, not replayed from a previous session.
            </p>
            <p>
              <strong>Why:</strong> Without this step, an attacker could intercept your ballot and
              re-submit it later. The challenge expires after 10 minutes.
            </p>
            <p>
              <strong>In a real election:</strong> The challenge would be issued by the Election Web
              Gateway and signed with the gateway's private key.
            </p>
          </div>
        </details>
        <pre
          class="mt-3 rounded-lg bg-navy-800 text-cream-100 p-3 overflow-x-auto text-xs leading-relaxed font-mono"><code id="challenge-json">No challenge yet.</code></pre>
      </section>

      <!-- Step 3: Encrypt & Review (with Benaloh challenge) -->
      <section
        class="bg-white rounded-xl border border-navy-200 p-5 sm:p-6 shadow-md hidden"
        id="encrypt-review"
      >
        <h2 class="font-serif text-lg text-navy-900 font-bold flex items-center gap-2">
          <Icon name="vote" class="text-gold-600" />
          Encrypt & Review
        </h2>
        <details class="mt-2 text-sm text-navy-600">
          <summary class="cursor-pointer text-navy-500 hover:text-navy-700 font-sans text-xs font-semibold uppercase tracking-wider">How it works</summary>
          <div class="mt-2 space-y-1.5">
            <p>
              <strong>What:</strong> Make your selections below, then click <strong>Encrypt Ballot</strong>.
              Your choices will be encrypted so no one can see how you voted until the official tally.
            </p>
            <p>
              After encryption you can <strong>Cast</strong> (submit) or <strong>Challenge (Spoil)</strong>
              to verify the device encrypted your actual selections honestly.
            </p>
            <p>
              <strong>In a real election:</strong> Only a quorum of independent trustees holding
              separate key shares could decrypt the ballots together during the official tally.
            </p>
          </div>
        </details>

        <!-- Ballot options (multi-contest) -->
        <div class="mt-4 rounded-lg border border-navy-200 bg-cream-50 p-4" id="ballot-section">
          <div id="ballot-options" class="space-y-6"></div>
        </div>

        <!-- Review panel (hidden until encryption) -->
        <!-- Review panel (hidden until encryption) -->
        <div id="review-panel" class="hidden mt-4">
          <Divider withSeal={false} />

          <p class="text-navy-600 text-sm mt-3 mb-2">
            Ballot encrypted. <strong>Cast</strong> to submit, or <strong>Challenge (Spoil)</strong> to verify the device was honest.
          </p>

          <div class="rounded-lg border border-navy-200 bg-cream-50 p-3">
            <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-2">
              Encrypted Ballot
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <p class="text-[10px] font-mono text-navy-400 mb-0.5">Ballot Hash</p>
                <p id="review-ballot-hash" class="font-mono text-xs text-navy-900 break-all">-</p>
              </div>
              <div>
                <p class="text-[10px] font-mono text-navy-400 mb-0.5">Ballot ID</p>
                <p id="review-ballot-id" class="font-mono text-xs text-navy-900 break-all">-</p>
              </div>
            </div>
            <div class="mt-2">
              <p class="text-[10px] font-mono text-navy-400 mb-0.5">Your Selections</p>
              <div id="review-selections" class="space-y-1"></div>
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between flex-wrap gap-3">
            <p id="spoil-count" class="text-sm text-navy-500 font-sans">Challenges used: 0</p>
            <button
              id="spoil-btn"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-1.5 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
              type="button"
            >
              <Icon name="eye" class="text-navy-700" size={16} />
              Challenge (Spoil)
            </button>
          </div>

          <!-- Spoil verification result (hidden until spoil) -->
          <div id="spoil-result" class="hidden mt-3">
            <p class="text-navy-600 text-xs mb-2">
              The device revealed its encryption randomness. We re-encrypted your selections and
              compared the result. If they match, the device was honest. This ballot is now
              <strong>spoiled</strong> &mdash; click <em>Re-Encrypt</em> for a fresh one.
            </p>
            <div
              class="rounded-lg border-2 p-3"
              id="spoil-result-box"
            >
              <div class="flex items-start gap-3">
                <div id="spoil-result-icon" class="shrink-0 mt-0.5"></div>
                <div class="flex-1">
                  <p id="spoil-result-title" class="font-sans font-semibold text-sm"></p>
                  <p id="spoil-result-detail" class="text-xs mt-1"></p>
                </div>
              </div>
              <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div>
                  <p class="text-[10px] font-mono text-navy-400 mb-0.5">Revealed IV</p>
                  <p id="spoil-iv" class="font-mono text-xs text-navy-800 break-all">-</p>
                </div>
                <div>
                  <p class="text-[10px] font-mono text-navy-400 mb-0.5">Spoil Receipt ID</p>
                  <p id="spoil-receipt-id" class="font-mono text-xs text-navy-800 break-all">-</p>
                </div>
              </div>
            </div>
            <div class="mt-2 flex justify-end">
              <button
                id="re-encrypt-btn"
                class="inline-flex items-center gap-2 rounded-md bg-gold-500 px-3 py-1.5 text-navy-900 font-sans text-sm font-semibold hover:bg-gold-400 transition-colors"
                type="button"
              >
                <Icon name="repeat" class="text-navy-900" size={16} />
                Re-Encrypt & Continue
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Step 4: Cast -->
      <section
        class="bg-white rounded-xl border border-navy-200 p-5 sm:p-6 shadow-md hidden"
        id="cast-step"
      >
        <div class="flex items-center justify-between flex-wrap gap-2">
          <h2 class="font-serif text-lg text-navy-900 font-bold flex items-center gap-2">
            <Icon name="check-square" class="text-gold-600" />
            Cast Ballot
          </h2>
          <a
            href="/votechain/poc/dashboard"
            class="text-xs font-sans font-semibold text-navy-700 hover:text-gold-700 underline"
          >
            Dashboard
          </a>
        </div>
        <p class="text-navy-600 text-sm mt-2">
          Submit your encrypted ballot with the eligibility proof and challenge. Click
          <strong>Cast Ballot</strong> below.
        </p>

        <div class="mt-3 rounded-lg border border-navy-200 bg-cream-50 p-3">
          <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-2">
            Cast Summary
          </p>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <p class="text-[10px] font-mono text-navy-400 mb-0.5">Ballot Hash</p>
              <p id="cast-summary-ballot-hash" class="font-mono text-xs text-navy-900 break-all">-</p>
            </div>
            <div>
              <p class="text-[10px] font-mono text-navy-400 mb-0.5">Ballot ID</p>
              <p id="cast-summary-ballot-id" class="font-mono text-xs text-navy-900 break-all">-</p>
            </div>
            <div>
              <p class="text-[10px] font-mono text-navy-400 mb-0.5">Challenge ID</p>
              <p id="cast-summary-challenge-id" class="font-mono text-xs text-navy-900 break-all">-</p>
            </div>
            <div>
              <p class="text-[10px] font-mono text-navy-400 mb-0.5">Challenge Expires</p>
              <p id="cast-summary-challenge-exp" class="font-mono text-xs text-navy-900 break-all">-</p>
            </div>
          </div>
          <p class="text-navy-500 text-xs mt-1.5 italic" id="cast-summary-hint">-</p>
        </div>

        <!-- Cast request/response JSON (shown after you click Cast) -->
        <div id="cast-json-panel" class="hidden mt-4">
          <Divider withSeal={false} />
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-3">
            <div>
              <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-1">
                Cast Request
              </p>
              <pre
                class="rounded-lg bg-navy-800 text-cream-100 p-3 overflow-x-auto text-xs leading-relaxed font-mono"><code id="cast-request-json">Waiting...</code></pre>
            </div>
            <div>
              <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-1">
                Cast Response
              </p>
              <pre
                class="rounded-lg bg-navy-800 text-cream-100 p-3 overflow-x-auto text-xs leading-relaxed font-mono"><code id="cast-response-json">Waiting...</code></pre>
            </div>
          </div>
        </div>
      </section>
      </div><!-- /wizard-step-container -->

      <!-- Wizard Controls -->
      <section
        id="wizard-controls"
        class="sticky bottom-3 z-10 bg-white rounded-xl border border-navy-200 px-4 py-3 shadow-lg"
      >
        <div class="flex items-center justify-between gap-2">
          <button
            id="wizard-back"
            class="inline-flex items-center gap-1.5 rounded-md border border-navy-200 bg-white px-3 py-1.5 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 transition-all disabled:opacity-50 disabled:hover:border-navy-200"
            type="button"
          >
            <Icon name="arrow-right" class="text-navy-700 rotate-180" size={16} />
            Back
          </button>

          <div class="flex items-center gap-2">
            <button
              id="wizard-restart"
              class="inline-flex items-center gap-1.5 rounded-md border border-navy-200 bg-white px-3 py-1.5 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 transition-all"
              type="button"
            >
              <Icon name="repeat" class="text-navy-700" size={16} />
              Restart
            </button>

            <button
              id="wizard-next"
              class="inline-flex items-center gap-1.5 rounded-md bg-gold-500 px-4 py-1.5 text-navy-900 font-sans text-sm font-semibold hover:bg-gold-400 transition-colors disabled:opacity-50"
              type="button"
            >
              <span id="wizard-next-label">Next</span>
              <Icon name="arrow-right" class="text-navy-900" size={16} />
            </button>
          </div>
        </div>

        <p id="wizard-status" class="mt-2 text-sm text-navy-700 empty:hidden"></p>
      </section>

      <!-- Cast error section (hidden until error) -->
      <section
        class="bg-white rounded-xl border-2 border-red-300 p-6 sm:p-8 shadow-md hidden"
        id="cast-error"
      >
        <div class="flex items-start gap-4">
          <div class="shrink-0 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <div class="flex-1">
            <h2 class="font-serif text-xl text-red-800 font-bold">Ballot Not Cast</h2>
            <p id="cast-error-message" class="text-red-700 text-sm mt-2"></p>
            <p id="cast-error-hint" class="text-navy-600 text-sm mt-2"></p>
            <div class="mt-4 flex flex-wrap gap-2">
              <button
                id="cast-error-retry"
                class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-4 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
                type="button"
              >
                <Icon name="repeat" class="text-gold-300" size={18} />
                Start Over
              </button>
            </div>
            <details class="mt-4">
              <summary class="text-xs text-navy-500 cursor-pointer hover:text-navy-700">Show raw error</summary>
              <pre id="cast-error-raw" class="mt-2 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"></pre>
            </details>
          </div>
        </div>
      </section>

      <!-- Post-cast success section (hidden until success) -->
      <section
        class="bg-white rounded-xl border border-navy-200 p-5 sm:p-6 shadow-md hidden"
        id="cast-success"
      >
        <div class="text-center py-2">
          <div class="flex justify-center mb-3">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="36"
              height="36"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-green-600"
            >
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <h2 class="font-serif text-xl text-navy-900 font-bold">Ballot Cast Successfully</h2>
          <p class="text-navy-600 text-sm mt-2 max-w-lg mx-auto">
            Your encrypted ballot has been written to the bulletin board and anchored on the
            VoteChain ledger. A <strong>signed receipt</strong> has been saved to your browser.
          </p>

          <div
            id="success-details"
            class="mt-6 rounded-lg border border-navy-200 bg-cream-50 p-4 text-left max-w-md mx-auto space-y-2"
          >
          </div>

          <div class="mt-6 flex flex-wrap justify-center gap-3">
            <button
              id="copy-receipt-btn"
              class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-4 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
              type="button"
            >
              <Icon name="copy" class="text-gold-300" size={18} />
              <span id="copy-receipt-label">Copy Receipt</span>
            </button>
            <a
              href="/votechain/poc/lookup"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-4 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            >
              <Icon name="search" class="text-navy-700" size={18} />
              Public Ballot Lookup
            </a>
          </div>

          <!-- ===== JOURNEY CONTINUATION CTA ===== -->
          <div class="mt-8 mx-auto max-w-md">
            <div class="rounded-xl border-2 border-gold-400 bg-gradient-to-br from-gold-50 to-cream-50 p-5 text-center shadow-lg animate-fade-in-up">
              <p class="text-[10px] font-mono uppercase tracking-widest text-gold-600 mb-1">Step 1 Complete</p>
              <p class="font-serif text-lg text-navy-900 font-bold">Your ballot is recorded.</p>
              <p class="text-navy-600 text-sm mt-1">
                Next, verify your receipt to prove it was counted correctly.
              </p>
              <a
                href="/votechain/poc/verify"
                class="mt-4 inline-flex items-center gap-2 rounded-lg bg-navy-800 px-6 py-3 text-gold-300 font-sans text-sm font-bold hover:bg-navy-700 transition-all shadow-md hover:shadow-lg group"
              >
                Continue to Step 2: Verify Receipt
                <Icon name="arrow-right" class="text-gold-400 transition-transform group-hover:translate-x-0.5" size={18} />
              </a>
              <p class="text-navy-400 text-xs mt-3 italic">
                Or explore the <a href="/votechain/poc/dashboard" class="text-gold-600 hover:text-gold-700 underline">Dashboard</a> first
              </p>
            </div>
          </div>

          <button
            id="toggle-raw-json"
            class="mt-4 text-xs text-navy-500 underline hover:text-navy-700"
            type="button"
          >
            Show raw receipt JSON
          </button>
          <pre
            id="raw-receipt-json"
            class="mt-2 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono hidden max-w-2xl mx-auto text-left"
          ></pre>
        </div>
      </section>

      <!-- Election Manifest (reference, below wizard) -->
      <details class="bg-white rounded-xl border border-navy-200 p-5 sm:p-6 shadow-md">
        <summary class="flex items-center justify-between flex-wrap gap-3 cursor-pointer list-none">
          <div class="flex items-center gap-2">
            <Icon name="file-text" class="text-gold-600" />
            <span class="font-serif text-lg text-navy-900 font-bold">Election Manifest</span>
          </div>
          <span class="text-xs font-mono text-navy-500 uppercase tracking-widest">
            Toggle Details
          </span>
        </summary>
        <div class="mt-3">
          <p class="text-navy-600 text-xs">
            The election manifest defines contests, candidates, encryption keys, and rules &mdash;
            locked down with a cryptographic signature. It is anchored on the federal ledger node
            and cached locally.
          </p>
          <pre
            class="mt-3 rounded-lg bg-navy-800 text-cream-100 p-3 overflow-x-auto text-xs leading-relaxed font-mono"><code id="manifest-json">Loading manifest...</code></pre>
        </div>
      </details>
    </div>
  </main>

  <script>
    import {
      bytesToB64u,
      buildCastRequest,
      castBallot,
      computeNullifier,
      encryptBallotForReview,
      ensureCredential,
      getManifest,
      getPocState,
      hasAlreadyVoted,
      issueChallenge,
      spoilBallot,
      verifySpoiledBallot,
    } from '../../../votechain-poc';
    import type { PocContest, PocEncryptedBallot, PocBallotPlaintext } from '../../../votechain-poc';

    function formatJson(value: unknown) {
      return JSON.stringify(value, null, 2);
    }

    function randomB64u(n: number) {
      const b = new Uint8Array(n);
      crypto.getRandomValues(b);
      return bytesToB64u(b);
    }

    const SVG_NS = 'http://www.w3.org/2000/svg';

    function createLucideSvg(params: {
      size?: number;
      className?: string;
      nodes: Array<{ name: string; attrs: Record<string, string> }>;
    }) {
      const size = params.size ?? 24;
      const svg = document.createElementNS(SVG_NS, 'svg');
      svg.setAttribute('xmlns', SVG_NS);
      svg.setAttribute('width', String(size));
      svg.setAttribute('height', String(size));
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');
      svg.setAttribute('stroke', 'currentColor');
      svg.setAttribute('stroke-width', '2');
      svg.setAttribute('stroke-linecap', 'round');
      svg.setAttribute('stroke-linejoin', 'round');
      if (params.className) svg.setAttribute('class', params.className);

      for (const node of params.nodes) {
        const el = document.createElementNS(SVG_NS, node.name);
        for (const [k, v] of Object.entries(node.attrs)) el.setAttribute(k, v);
        svg.appendChild(el);
      }

      return svg;
    }

    // DOM refs
    const manifestEl = document.getElementById('manifest-json') as HTMLElement;
    const credDidEl = document.getElementById('credential-did') as HTMLElement;
    const credNullifierEl = document.getElementById('credential-nullifier') as HTMLElement;
    const credBlindSigEl = document.getElementById('credential-blind-sig') as HTMLElement;
    const challengeEl = document.getElementById('challenge-json') as HTMLElement;
    const ballotOptionsEl = document.getElementById('ballot-options') as HTMLElement;
    const reviewPanel = document.getElementById('review-panel') as HTMLElement;
    const reviewBallotHash = document.getElementById('review-ballot-hash') as HTMLElement;
    const reviewBallotId = document.getElementById('review-ballot-id') as HTMLElement;
    const reviewSelections = document.getElementById('review-selections') as HTMLElement;
    const spoilCountEl = document.getElementById('spoil-count') as HTMLElement;
    const spoilBtn = document.getElementById('spoil-btn') as HTMLButtonElement;
    const spoilResult = document.getElementById('spoil-result') as HTMLElement;
    const spoilResultBox = document.getElementById('spoil-result-box') as HTMLElement;
    const spoilResultIcon = document.getElementById('spoil-result-icon') as HTMLElement;
    const spoilResultTitle = document.getElementById('spoil-result-title') as HTMLElement;
    const spoilResultDetail = document.getElementById('spoil-result-detail') as HTMLElement;
    const spoilIvEl = document.getElementById('spoil-iv') as HTMLElement;
    const spoilReceiptIdEl = document.getElementById('spoil-receipt-id') as HTMLElement;
    const reEncryptBtn = document.getElementById('re-encrypt-btn') as HTMLButtonElement;
    const castJsonPanel = document.getElementById('cast-json-panel') as HTMLElement;
    const castReqEl = document.getElementById('cast-request-json') as HTMLElement;
    const castResEl = document.getElementById('cast-response-json') as HTMLElement;
    const castSuccess = document.getElementById('cast-success') as HTMLElement;
    const castError = document.getElementById('cast-error') as HTMLElement;
    const castErrorMessage = document.getElementById('cast-error-message') as HTMLElement;
    const castErrorHint = document.getElementById('cast-error-hint') as HTMLElement;
    const castErrorRaw = document.getElementById('cast-error-raw') as HTMLElement;
    const castErrorRetry = document.getElementById('cast-error-retry') as HTMLButtonElement;
    const successDetails = document.getElementById('success-details') as HTMLElement;
    const copyReceiptBtn = document.getElementById('copy-receipt-btn') as HTMLButtonElement;
    const copyReceiptLabel = document.getElementById('copy-receipt-label') as HTMLElement;
    const toggleRawJson = document.getElementById('toggle-raw-json') as HTMLButtonElement;
    const rawReceiptJson = document.getElementById('raw-receipt-json') as HTMLElement;
    const credentialSection = document.getElementById('credential') as HTMLElement;
    const challengeSection = document.getElementById('challenge') as HTMLElement;
    const encryptReviewSection = document.getElementById('encrypt-review') as HTMLElement;
    const castStepSection = document.getElementById('cast-step') as HTMLElement;
    const ballotSection = document.getElementById('ballot-section') as HTMLElement;
    const wizardControls = document.getElementById('wizard-controls') as HTMLElement;
    const wizardBack = document.getElementById('wizard-back') as HTMLButtonElement;
    const wizardNext = document.getElementById('wizard-next') as HTMLButtonElement;
    const wizardNextLabel = document.getElementById('wizard-next-label') as HTMLElement;
    const wizardRestart = document.getElementById('wizard-restart') as HTMLButtonElement;
    const wizardStatus = document.getElementById('wizard-status') as HTMLElement;

    const castSummaryBallotHash = document.getElementById(
      'cast-summary-ballot-hash',
    ) as HTMLElement;
    const castSummaryBallotId = document.getElementById('cast-summary-ballot-id') as HTMLElement;
    const castSummaryChallengeId = document.getElementById(
      'cast-summary-challenge-id',
    ) as HTMLElement;
    const castSummaryChallengeExp = document.getElementById(
      'cast-summary-challenge-exp',
    ) as HTMLElement;
    const castSummaryHint = document.getElementById('cast-summary-hint') as HTMLElement;

    // State
    let cachedState: any = null;
    let cachedChallenge: any = null;
    let selections: Record<string, string | null> = {};
    let spoilCount = 0;
    let currentEncryption: {
      encrypted_ballot: PocEncryptedBallot;
      iv: string;
      ballot_key: string;
      plaintext: PocBallotPlaintext;
    } | null = null;
    type WizardStep = 1 | 2 | 3 | 4;
    type EncryptionState = 'none' | 'encrypted' | 'spoiled';
    let wizardStep: WizardStep = 1;
    let encryptionState: EncryptionState = 'none';

    // Step indicator
    function updateStepIndicator(current: number) {
      const steps = document.querySelectorAll('#step-indicator [data-step]');
      const connectors = document.querySelectorAll('#step-indicator .step-connector');

      steps.forEach((step) => {
        const num = Number(step.getAttribute('data-step'));
        const circle = step.querySelector('.step-circle') as HTMLElement;
        if (num < current) {
          circle.className =
            'step-circle w-8 h-8 rounded-full flex items-center justify-center font-sans font-semibold text-sm bg-navy-800 text-gold-200 transition-all';
        } else if (num === current) {
          circle.className =
            'step-circle w-8 h-8 rounded-full flex items-center justify-center font-sans font-semibold text-sm bg-gold-500 text-navy-900 transition-all';
        } else {
          circle.className =
            'step-circle w-8 h-8 rounded-full flex items-center justify-center font-sans font-semibold text-sm bg-navy-200 text-navy-500 transition-all';
        }
      });

      connectors.forEach((conn, i) => {
        (conn as HTMLElement).className =
          i < current - 1
            ? 'step-connector flex-1 h-0.5 mx-2 bg-gold-500 transition-all'
            : 'step-connector flex-1 h-0.5 mx-2 bg-navy-200 transition-all';
      });
    }

    function setWizardStatus(message: string) {
      wizardStatus.textContent = message;
    }

    function challengeUsed(state: any, challenge_id: string | undefined): boolean {
      if (!challenge_id) return false;
      const rec = state?.challenges?.[challenge_id] ?? null;
      return !!rec?.used;
    }

    function challengeExpired(expires_at: string | undefined): boolean {
      if (!expires_at) return false;
      const exp = Date.parse(expires_at);
      if (!Number.isFinite(exp)) return false;
      return Date.now() > exp;
    }

    function isChallengeUsable(challenge: any): boolean {
      if (!challenge) return false;
      if (challengeExpired(String(challenge.expires_at ?? ''))) return false;
      if (challengeUsed(cachedState, String(challenge.challenge_id ?? ''))) return false;
      return true;
    }

    function toChallengeResponse(record: any) {
      if (!record) return null;
      return {
        challenge_id: String(record.challenge_id ?? ''),
        challenge: String(record.challenge ?? ''),
        expires_at: String(record.expires_at ?? ''),
        kid: String(record.kid ?? ''),
        server_sig: String(record.server_sig ?? ''),
      };
    }

    function pickChallengeForResume(state: any) {
      const records = Object.values(state?.challenges ?? {}) as any[];
      if (!records.length) return null;

      const usable = records.filter((r) => !r?.used && !challengeExpired(String(r?.expires_at ?? '')));
      const pool = usable.length ? usable : records;

      // Prefer the most recent expiry window.
      pool.sort((a, b) => String(b?.expires_at ?? '').localeCompare(String(a?.expires_at ?? '')));
      return toChallengeResponse(pool[0]);
    }

    function hideWizard() {
      credentialSection.classList.add('hidden');
      challengeSection.classList.add('hidden');
      encryptReviewSection.classList.add('hidden');
      castStepSection.classList.add('hidden');
      wizardControls.classList.add('hidden');
    }

    function renderCastSummary() {
      if (!currentEncryption) {
        castSummaryBallotHash.textContent = '-';
        castSummaryBallotId.textContent = '-';
        castSummaryChallengeId.textContent = '-';
        castSummaryChallengeExp.textContent = '-';
        castSummaryHint.textContent = 'No encrypted ballot is currently in memory. Go back and encrypt.';
        return;
      }

      castSummaryBallotHash.textContent = currentEncryption.encrypted_ballot.ballot_hash;
      castSummaryBallotId.textContent = currentEncryption.encrypted_ballot.ballot_id;
      castSummaryChallengeId.textContent = cachedChallenge?.challenge_id ?? '-';
      castSummaryChallengeExp.textContent = cachedChallenge?.expires_at ?? '-';

      if (encryptionState === 'spoiled') {
        castSummaryHint.textContent = 'This ballot was spoiled. Re-encrypt before casting.';
        return;
      }

      castSummaryHint.textContent = isChallengeUsable(cachedChallenge)
        ? 'Ready to cast. Your vote will be recorded on the distributed ledger and a receipt saved locally.'
        : 'Challenge missing/expired. Request a new challenge before casting.';
    }

    const wizardStepEls: Record<WizardStep, HTMLElement> = {
      1: credentialSection,
      2: challengeSection,
      3: encryptReviewSection,
      4: castStepSection,
    };

    function setWizardStep(step: WizardStep) {
      wizardStep = step;

      for (const [k, el] of Object.entries(wizardStepEls)) {
        const n = Number(k) as WizardStep;
        if (n === step) el.classList.remove('hidden');
        else el.classList.add('hidden');
      }

      // Wizard implies these are mutually exclusive views.
      castError.classList.add('hidden');
      castSuccess.classList.add('hidden');
      wizardControls.classList.remove('hidden');

      if (step === 4) renderCastSummary();

      updateStepIndicator(step);
      updateWizardControls();
    }

    function updateWizardControls() {
      wizardBack.disabled = wizardStep === 1;

      const hasCredential = !!cachedState?.credential;
      const challengeOk = isChallengeUsable(cachedChallenge);

      let nextLabel = 'Next';
      let nextDisabled = false;

      if (wizardStep === 1) {
        nextLabel = hasCredential ? 'Continue' : 'Generate Credential';
      } else if (wizardStep === 2) {
        if (!hasCredential) {
          nextLabel = 'Generate Credential';
          nextDisabled = false;
        } else {
          nextLabel = challengeOk ? 'Continue' : 'Request Challenge';
        }
      } else if (wizardStep === 3) {
        if (!challengeOk) {
          nextLabel = 'Request New Challenge';
          nextDisabled = false;
        } else if (encryptionState === 'none') {
          nextLabel = 'Encrypt Ballot';
          nextDisabled = !allContestsSelected();
        } else if (encryptionState === 'spoiled') {
          nextLabel = 'Re-Encrypt';
          nextDisabled = false;
        } else {
          nextLabel = 'Continue to Cast';
          nextDisabled = false;
        }
      } else if (wizardStep === 4) {
        if (!challengeOk) {
          nextLabel = 'Request New Challenge';
          nextDisabled = false;
        } else {
          nextLabel = 'Cast Ballot';
          nextDisabled = encryptionState !== 'encrypted' || !currentEncryption;
        }
      }

      wizardNextLabel.textContent = nextLabel;
      wizardNext.disabled = nextDisabled;
    }

    // Multi-contest ballot rendering
    function renderBallotOptions(state: any) {
      ballotOptionsEl.replaceChildren();
      selections = {};

      for (const contest of state.election.contests as PocContest[]) {
        selections[contest.contest_id] = null;

        const section = document.createElement('div');

        const title = document.createElement('p');
        title.className = 'font-serif text-lg font-bold text-navy-900 mb-1';
        title.textContent = contest.title;
        section.appendChild(title);

        const subtitle = document.createElement('p');
        subtitle.className = 'text-xs text-navy-500 font-mono mb-2';
        subtitle.textContent =
          contest.type === 'candidate' ? 'Choose one candidate:' : 'Vote yes or no:';
        section.appendChild(subtitle);

        const optionsWrap = document.createElement('div');
        optionsWrap.className = 'space-y-2';

        for (const opt of contest.options) {
          const row = document.createElement('label');
          row.className =
            'flex items-center gap-3 rounded-md border border-navy-200 bg-white p-3 hover:border-gold-500 transition-colors cursor-pointer';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `poc-${contest.contest_id}`;
          input.value = opt.id;
          input.className = 'h-4 w-4';
          input.addEventListener('change', () => {
            selections[contest.contest_id] = opt.id;
            setWizardStatus('');
            updateWizardControls();
          });
          const text = document.createElement('span');
          text.className = 'font-sans text-sm text-navy-800';
          text.textContent = opt.label;
          row.appendChild(input);
          row.appendChild(text);
          optionsWrap.appendChild(row);
        }

        section.appendChild(optionsWrap);
        ballotOptionsEl.appendChild(section);
      }
    }

    function allContestsSelected(): boolean {
      return Object.values(selections).every((v) => v !== null);
    }

    function getContestSelections(): Array<{ contest_id: string; selection: string }> {
      return Object.entries(selections)
        .filter(([, v]) => v !== null)
        .map(([k, v]) => ({ contest_id: k, selection: v! }));
    }

    // Show review panel with encrypted ballot details
    function showReviewPanel(
      encrypted: PocEncryptedBallot,
      plaintext: PocBallotPlaintext,
      contests: PocContest[],
    ) {
      reviewPanel.classList.remove('hidden');
      spoilResult.classList.add('hidden');
      ballotSection.classList.add('hidden');

      reviewBallotHash.textContent = encrypted.ballot_hash;
      reviewBallotId.textContent = encrypted.ballot_id;

      reviewSelections.replaceChildren();
      for (const entry of plaintext.contests) {
        const config = contests.find((c) => c.contest_id === entry.contest_id);
        const label = config?.options.find((o) => o.id === entry.selection)?.label ?? entry.selection;
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        const contestName = document.createElement('span');
        contestName.className = 'text-xs font-mono text-navy-500';
        contestName.textContent = config?.title ?? entry.contest_id;
        const arrow = document.createElement('span');
        arrow.className = 'text-navy-400';
        arrow.textContent = '\u2192';
        const selName = document.createElement('span');
        selName.className = 'text-xs font-semibold text-navy-800';
        selName.textContent = label;
        row.appendChild(contestName);
        row.appendChild(arrow);
        row.appendChild(selName);
        reviewSelections.appendChild(row);
      }

      encryptionState = 'encrypted';
      setWizardStatus('Ballot encrypted. Review it, optionally challenge (spoil), then continue to cast.');
      updateWizardControls();
    }

    // Reset to ballot selection (after spoil, for re-encryption)
    function resetToSelection() {
      reviewPanel.classList.add('hidden');
      spoilResult.classList.add('hidden');
      ballotSection.classList.remove('hidden');
      currentEncryption = null;
      encryptionState = 'none';
      spoilBtn.disabled = false;
      setWizardStatus('');
      updateWizardControls();
    }

    async function refreshManifest() {
      const manifest = await getManifest();
      manifestEl.textContent = formatJson(manifest);
    }

    async function refreshCredential() {
      const state = await getPocState();
      cachedState = state;
      const cred = state.credential ?? null;
      if (!cred || !cred.pk) {
        credDidEl.textContent = 'Not generated';
        credNullifierEl.textContent = 'Not generated';
        credBlindSigEl.textContent = 'Not generated';
        return;
      }
      credDidEl.textContent = cred.did;
      const nullifier = await computeNullifier(cred.pk, state.election.election_id);
      credNullifierEl.textContent = nullifier;

      if (cred.blind_sigs?.length > 0) {
        const parts = cred.blind_sigs.map((sig) =>
          `#${sig.issuer_index + 1}: R:${sig.R.slice(0, 8)}.. s:${sig.s.slice(0, 8)}..`
        );
        credBlindSigEl.textContent = parts.join(' | ');
      } else {
        credBlindSigEl.textContent = 'Not generated';
      }
    }

    async function ensureReady() {
      const state = await getPocState();
      cachedState = state;
      renderBallotOptions(state);
      await refreshManifest();
      await refreshCredential();

      // If a ballot was already cast with this credential, show the receipt
      if (await hasAlreadyVoted()) {
        const receiptJson = localStorage.getItem('votechain_poc_last_receipt');
        if (receiptJson) {
          try {
            const receipt = JSON.parse(receiptJson);
            updateStepIndicator(5);
            hideWizard();
            castSuccess.classList.remove('hidden');
            successDetails.replaceChildren();
            const items = [
              { label: 'Receipt ID', value: receipt.receipt_id },
              { label: 'Ballot Hash', value: receipt.ballot_hash },
              { label: 'BB Leaf', value: receipt.bb_leaf_hash },
              { label: 'VCL Anchor', value: receipt.votechain_anchor?.tx_id ?? 'N/A' },
            ];
            for (const item of items) {
              const row = document.createElement('div');
              row.className = 'flex justify-between gap-2';
              const label = document.createElement('span');
              label.className = 'text-xs font-mono text-navy-500 uppercase';
              label.textContent = item.label;
              const val = document.createElement('span');
              val.className = 'text-xs font-mono text-navy-800 truncate max-w-[200px]';
              val.textContent =
                item.value.length > 24
                  ? item.value.slice(0, 12) + '...' + item.value.slice(-8)
                  : item.value;
              val.title = item.value;
              row.appendChild(label);
              row.appendChild(val);
              successDetails.appendChild(row);
            }
            return;
          } catch { /* fall through to normal init */ }
        }
        // No receipt saved but nullifier used â€” show error
        hideWizard();
        castError.classList.remove('hidden');
        castErrorMessage.textContent = 'You have already cast a ballot in this election.';
        castErrorHint.textContent = 'To vote again as a new voter, reset the POC state from the POC Home page.';
        updateStepIndicator(5);
        return;
      }

      cachedChallenge = pickChallengeForResume(state);
      challengeEl.textContent = cachedChallenge ? formatJson(cachedChallenge) : 'No challenge yet.';

      const start: WizardStep = !cachedState?.credential
        ? 1
        : isChallengeUsable(cachedChallenge)
          ? 3
          : 2;

      setWizardStep(start);
      setWizardStatus('');
    }

    async function wizardEnsureCredential() {
      setWizardStatus('Generating credential and running blind Schnorr signing ceremony...');
      await ensureCredential();
      await refreshCredential();
      setWizardStatus('Credential issued with blind signature. Registration authority cannot link this to your vote.');
    }

    async function wizardEnsureChallenge() {
      setWizardStatus('Issuing one-time challenge...');
      cachedChallenge = await issueChallenge(randomB64u(32));
      cachedState = await getPocState();
      challengeEl.textContent = formatJson(cachedChallenge);
      setWizardStatus('Challenge issued.');
    }

    async function wizardEncryptBallot() {
      if (!allContestsSelected()) {
        setWizardStatus('Select an option for every contest before encrypting.');
        return;
      }

      // Challenge isn't strictly required for encryption, but the wizard enforces the EWP flow.
      if (!isChallengeUsable(cachedChallenge)) {
        await wizardEnsureChallenge();
      }

      setWizardStatus('Encrypting ballot locally (WebCrypto)...');
      const result = await encryptBallotForReview({ contests: getContestSelections() });
      if ('error' in result) {
        setWizardStatus(result.error);
        return;
      }

      currentEncryption = result;
      const state = cachedState ?? (await getPocState());
      showReviewPanel(result.encrypted_ballot, result.plaintext, state.election.contests);
    }

    async function restartWizard() {
      // Clear transient UI without wiping the underlying POC state.
      castError.classList.add('hidden');
      castSuccess.classList.add('hidden');

      castJsonPanel.classList.add('hidden');
      castReqEl.textContent = 'Waiting...';
      castResEl.textContent = 'Waiting...';

      rawReceiptJson.textContent = '';
      successDetails.replaceChildren();

      spoilCount = 0;
      spoilCountEl.textContent = 'Challenges used: 0';

      resetToSelection();

      const state = await getPocState();
      cachedState = state;
      renderBallotOptions(state);
      await refreshCredential();

      cachedChallenge = pickChallengeForResume(state);
      challengeEl.textContent = cachedChallenge ? formatJson(cachedChallenge) : 'No challenge yet.';

      // Always restart from Step 1 so the user can review each step.
      setWizardStep(1);
      setWizardStatus('');
    }

    wizardBack?.addEventListener('click', () => {
      setWizardStatus('');
      if (wizardStep === 2) setWizardStep(1);
      else if (wizardStep === 3) setWizardStep(2);
      else if (wizardStep === 4) setWizardStep(3);
    });

    wizardRestart?.addEventListener('click', async () => {
      wizardRestart.disabled = true;
      wizardNext.disabled = true;
      wizardBack.disabled = true;
      try {
        await restartWizard();
      } finally {
        wizardRestart.disabled = false;
        updateWizardControls();
      }
    });

    wizardNext?.addEventListener('click', async () => {
      wizardRestart.disabled = true;
      wizardNext.disabled = true;
      wizardBack.disabled = true;

      try {
        if (wizardStep === 1) {
          if (!cachedState?.credential) {
            await wizardEnsureCredential();
          }
          setWizardStep(2);
          return;
        }

        if (wizardStep === 2) {
          if (!cachedState?.credential) {
            await wizardEnsureCredential();
          }
          if (!isChallengeUsable(cachedChallenge)) {
            await wizardEnsureChallenge();
          }
          setWizardStep(3);
          return;
        }

        if (wizardStep === 3) {
          if (!isChallengeUsable(cachedChallenge)) {
            await wizardEnsureChallenge();
            updateWizardControls();
            return;
          }

          if (encryptionState === 'none') {
            await wizardEncryptBallot();
            return;
          }

          if (encryptionState === 'spoiled') {
            resetToSelection();
            setWizardStatus('Spoiled ballot discarded. Encrypt a fresh ballot before casting.');
            return;
          }

          setWizardStep(4);
          return;
        }

        if (wizardStep === 4) {
          if (!isChallengeUsable(cachedChallenge)) {
            await wizardEnsureChallenge();
            renderCastSummary();
          }
          await performCast();
          return;
        }
      } finally {
        wizardRestart.disabled = false;
        updateWizardControls();
      }
    });

    // Benaloh challenge (spoil)
    spoilBtn?.addEventListener('click', async () => {
      if (!currentEncryption || encryptionState === 'spoiled') return;
      spoilBtn.disabled = true;

      try {
        const result = await spoilBallot({
          encrypted_ballot: currentEncryption.encrypted_ballot,
          iv: currentEncryption.iv,
          ballot_key: currentEncryption.ballot_key,
          plaintext: currentEncryption.plaintext,
        });

        const verification = await verifySpoiledBallot({
          encrypted_ballot: currentEncryption.encrypted_ballot,
          iv: result.randomness_reveal.iv,
          ballot_key: result.randomness_reveal.ballot_key,
          plaintext: result.randomness_reveal.plaintext,
        });

        spoilCount++;
        spoilCountEl.textContent = `Challenges used: ${spoilCount}`;

        // Show result
        spoilResult.classList.remove('hidden');
        spoilIvEl.textContent = result.randomness_reveal.iv;
        spoilReceiptIdEl.textContent = result.spoil_receipt.receipt_id;

        if (verification.match) {
          spoilResultBox.className =
            'rounded-lg border-2 border-green-300 bg-green-50 p-4';
          spoilResultIcon.replaceChildren(
            createLucideSvg({
              size: 20,
              className: 'text-green-600',
              nodes: [
                { name: 'path', attrs: { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' } },
                { name: 'polyline', attrs: { points: '22 4 12 14.01 9 11.01' } },
              ],
            }),
          );
          spoilResultTitle.textContent = 'MATCH \u2014 Device Verified Honest';
          spoilResultTitle.className = 'font-sans font-semibold text-sm text-green-700';
          spoilResultDetail.textContent = verification.details;
          spoilResultDetail.className = 'text-xs mt-1 text-green-600';
        } else {
          spoilResultBox.className =
            'rounded-lg border-2 border-red-300 bg-red-50 p-4';
          spoilResultIcon.replaceChildren(
            createLucideSvg({
              size: 20,
              className: 'text-red-600',
              nodes: [
                { name: 'circle', attrs: { cx: '12', cy: '12', r: '10' } },
                { name: 'line', attrs: { x1: '15', y1: '9', x2: '9', y2: '15' } },
                { name: 'line', attrs: { x1: '9', y1: '9', x2: '15', y2: '15' } },
              ],
            }),
          );
          spoilResultTitle.textContent = 'MISMATCH \u2014 Potential Tampering';
          spoilResultTitle.className = 'font-sans font-semibold text-sm text-red-700';
          spoilResultDetail.textContent = verification.details;
          spoilResultDetail.className = 'text-xs mt-1 text-red-600';
        }

        encryptionState = 'spoiled';
        // Keep button disabled â€” this ballot is already spoiled
        setWizardStatus('Ballot spoiled. Review the verification result, then re-encrypt a fresh ballot.');
        updateWizardControls();
      } catch {
        // Re-enable only on failure so the user can retry
        spoilBtn.disabled = false;
      }
    });

    // Re-encrypt after spoil
    reEncryptBtn?.addEventListener('click', () => {
      resetToSelection();
      spoilCountEl.textContent = `Challenges used: ${spoilCount}`;
    });

    // EWP error code â†’ user-friendly message + hint
    const ewpErrorMessages: Record<string, { message: string; hint: string }> = {
      EWP_CHALLENGE_EXPIRED: {
        message: 'Your challenge has expired (they last 10 minutes).',
        hint: 'Click "Start Over" below, then request a new challenge and re-encrypt your ballot.',
      },
      EWP_NULLIFIER_USED: {
        message: 'You have already cast a ballot in this election.',
        hint: 'Each voter can only cast once. If you believe this is an error, check the Dashboard for fraud flags. To vote again as a new voter, reset the POC state from the POC Home page.',
      },
      EWP_PROOF_INVALID: {
        message: 'Your eligibility proof failed verification.',
        hint: 'This can happen if your challenge was already used or your credential doesn\'t match. Click "Start Over" and go through the full flow again.',
      },
      EWP_BALLOT_INVALID: {
        message: 'Your ballot failed validity checks.',
        hint: 'The encrypted ballot structure doesn\'t match what the election expects. Try encrypting again.',
      },
      EWP_BAD_MANIFEST: {
        message: 'The election manifest is invalid or has been tampered with.',
        hint: 'Reset the POC state from the POC Home page and try again.',
      },
      EWP_IDEMPOTENCY_MISMATCH: {
        message: 'This request conflicts with a previous submission.',
        hint: 'Click "Start Over" and go through the full flow again.',
      },
    };

    function showCastError(errorCode: string, rawError: unknown) {
      const info = ewpErrorMessages[errorCode] ?? {
        message: `Cast failed with error: ${errorCode}`,
        hint: 'Click "Start Over" and try the full flow again.',
      };

      hideWizard();
      castError.classList.remove('hidden');
      castErrorMessage.textContent = info.message;
      castErrorHint.textContent = info.hint;
      castErrorRaw.textContent = JSON.stringify(rawError, null, 2);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function performCast() {
      if (!currentEncryption) {
        showCastError('MISSING_BALLOT', { currentEncryption: !!currentEncryption });
        return;
      }

      if (!cachedChallenge) {
        showCastError('MISSING_CHALLENGE', { cachedChallenge: !!cachedChallenge });
        return;
      }

      if (!isChallengeUsable(cachedChallenge)) {
        showCastError('EWP_CHALLENGE_EXPIRED', { cachedChallenge });
        return;
      }

      renderCastSummary();

      setWizardStatus('Casting ballot...');
      castJsonPanel.classList.remove('hidden');
      castReqEl.textContent = 'Building request...';
      castResEl.textContent = 'Casting...';

      try {
        const built = await buildCastRequest({
          encrypted_ballot: currentEncryption.encrypted_ballot,
          challenge: cachedChallenge,
        });

        if ('error' in built) {
          showCastError('BUILD_ERROR', { error: built.error });
          return;
        }

        castReqEl.textContent = JSON.stringify(built.request, null, 2);

        const res = await castBallot({
          request: built.request,
          idempotencyKey: built.idempotencyKey,
        });

        castResEl.textContent = JSON.stringify(res, null, 2);

        if ('error' in res) {
          showCastError(res.error.code, res);
          return;
        }

        if ('status' in res && res.status === 'cast_recorded') {
          localStorage.setItem('votechain_poc_last_receipt', JSON.stringify(res.cast_receipt));
          updateStepIndicator(5); // all complete

          hideWizard();
          castSuccess.classList.remove('hidden');

          const receipt = res.cast_receipt;
          successDetails.replaceChildren();
          const items = [
            { label: 'Receipt ID', value: receipt.receipt_id },
            { label: 'Ballot Hash', value: receipt.ballot_hash },
            { label: 'BB Leaf', value: receipt.bb_leaf_hash },
            { label: 'VCL Anchor', value: receipt.votechain_anchor.tx_id },
          ];

          for (const item of items) {
            const row = document.createElement('div');
            row.className = 'flex justify-between gap-2';
            const label = document.createElement('span');
            label.className = 'text-xs font-mono text-navy-500 uppercase';
            label.textContent = item.label;
            const val = document.createElement('span');
            val.className = 'text-xs font-mono text-navy-800 truncate max-w-[200px]';
            val.textContent =
              item.value.length > 24
                ? item.value.slice(0, 12) + '...' + item.value.slice(-8)
                : item.value;
            val.title = item.value;
            row.appendChild(label);
            row.appendChild(val);
            successDetails.appendChild(row);
          }

          rawReceiptJson.textContent = JSON.stringify(receipt, null, 2);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      } catch (err) {
        castResEl.textContent = `Error: ${String(err)}`;
        showCastError('EXCEPTION', { message: String(err) });
      }
    }

    // Cast error "Start Over" restarts the flow
    castErrorRetry?.addEventListener('click', () => {
      window.location.reload();
    });

    // Copy receipt to clipboard
    copyReceiptBtn?.addEventListener('click', async () => {
      const receiptStr = localStorage.getItem('votechain_poc_last_receipt');
      if (!receiptStr) return;
      try {
        await navigator.clipboard.writeText(receiptStr);
        copyReceiptLabel.textContent = 'Copied!';
        copyReceiptBtn.disabled = true;
        setTimeout(() => {
          copyReceiptLabel.textContent = 'Copy Receipt';
          copyReceiptBtn.disabled = false;
        }, 2000);
      } catch {
        // Clipboard access isn't available. Reveal the raw receipt JSON and select a hidden textarea
        // so the user can press Ctrl/Cmd+C manually.
        rawReceiptJson.classList.remove('hidden');
        toggleRawJson.textContent = 'Hide raw receipt JSON';

        const ta = document.createElement('textarea');
        ta.value = receiptStr;
        ta.style.position = 'fixed';
        ta.style.left = '0';
        ta.style.top = '0';
        ta.style.width = '1px';
        ta.style.height = '1px';
        ta.style.opacity = '0';
        ta.setAttribute('readonly', 'true');
        document.body.appendChild(ta);
        ta.focus();
        ta.select();

        copyReceiptLabel.textContent = 'Press Ctrl/Cmd+C';
        copyReceiptBtn.disabled = true;
        setTimeout(() => {
          document.body.removeChild(ta);
          copyReceiptLabel.textContent = 'Copy Receipt';
          copyReceiptBtn.disabled = false;
        }, 2500);
      }
    });

    // Toggle raw JSON in success view
    toggleRawJson?.addEventListener('click', () => {
      rawReceiptJson.classList.toggle('hidden');
      toggleRawJson.textContent = rawReceiptJson.classList.contains('hidden')
        ? 'Show raw receipt JSON'
        : 'Hide raw receipt JSON';
    });

    // Initialize page
    ensureReady();
  </script>
</BaseLayout>
