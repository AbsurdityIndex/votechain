---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Icon from '../../../components/ui/Icon.astro';
---

<BaseLayout
  title="VoteChain POC"
  description="A proof-of-concept for the VoteChain Election Web Protocol (EWP): cast, verify, and monitor with distributed Cloudflare Workers ledger nodes."
  ogType="article"
  article={{
    publishedTime: '2026-02-08',
    author: 'Absurdity Index',
    section: 'Policy',
    tags: ['votechain', 'ewp', 'election security', 'verification'],
  }}
>

  <!-- ===== COMPLETION BANNER (hidden, revealed by JS) ===== -->
  <div id="poc-complete-banner" class="poc-banner hidden">
    <div class="max-w-3xl mx-auto px-4 py-4 flex items-center gap-4">
      <div class="poc-banner-icon">
        <Icon name="check-circle" class="text-white" size={24} />
      </div>
      <div class="flex-1 min-w-0">
        <p class="font-serif font-bold text-white text-base">Full cycle complete.</p>
        <p class="text-green-100 text-sm">You cast a ballot, verified your receipt, and watched the tally. You've seen the entire VoteChain flow.</p>
      </div>
      <a href="/votechain/faq" class="poc-banner-cta">Read the FAQ</a>
    </div>
  </div>

  <!-- ===== HERO ===== -->
  <div class="max-w-4xl mx-auto px-4 py-8 text-center">
    <p class="text-xs text-gold-600 font-mono uppercase tracking-widest mb-1 hero-fade" style="--delay: 0">
      Interactive Proof-of-Concept
    </p>
    <h1 class="font-serif text-2xl md:text-3xl text-navy-900 font-bold hero-fade" style="--delay: 1">
      Experience VoteChain
    </h1>
    <p class="text-navy-600 mt-3 text-base max-w-xl mx-auto leading-relaxed hero-fade" style="--delay: 2">
      Walk through an election from start to finish. Cast a ballot, verify your receipt,
      and watch the count &mdash; all with real cryptography running in your browser.
    </p>
    <p class="text-navy-400 text-sm mt-2 italic hero-fade" style="--delay: 3">Takes about 60 seconds. No sign-up required.</p>
  </div>

  <!-- ===== PROGRESS BAR ===== -->
  <div class="max-w-3xl mx-auto px-4 pt-4 pb-2 hero-fade" style="--delay: 4">
    <div id="poc-progress" class="poc-progress">
      <div class="poc-progress-track">
        <div id="poc-progress-fill" class="poc-progress-fill" style="width: 0%"></div>
      </div>
      <div class="poc-progress-steps">
        <button class="poc-progress-dot" data-progress-step="1" title="Cast Your Vote">
          <span class="poc-dot-inner" id="dot-1">1</span>
          <span class="poc-dot-label">Vote</span>
        </button>
        <button class="poc-progress-dot" data-progress-step="2" title="Verify Your Receipt">
          <span class="poc-dot-inner" id="dot-2">2</span>
          <span class="poc-dot-label">Verify</span>
        </button>
        <button class="poc-progress-dot" data-progress-step="3" title="Watch the Count">
          <span class="poc-dot-inner" id="dot-3">3</span>
          <span class="poc-dot-label">Tally</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ===== TURNSTILE GATE (hidden by default) ===== -->
  <div class="max-w-3xl mx-auto px-4">
    <div id="poc-gate" class="hidden poc-gate mb-4" data-locked="true">
      <div class="flex items-start gap-3">
        <div id="poc-gate-icon" class="poc-gate-icon">
          <Icon name="shield" class="poc-gate-icon--locked" />
          <Icon name="check-circle" class="poc-gate-icon--unlocked hidden" />
        </div>
        <div class="min-w-0 flex-1">
          <p id="poc-gate-heading" class="font-sans text-sm font-semibold">
            Complete a quick verification check to unlock the interactive modules.
          </p>
          <div class="mt-3">
            <div id="poc-turnstile"></div>
            <p id="poc-turnstile-status" class="font-sans text-xs mt-2"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== GUIDED JOURNEY ===== -->
  <div class="max-w-3xl mx-auto px-4 pb-6">

    <div class="journey-timeline" id="journey-timeline">

      <!-- ===== STEP 1: Cast Your Vote ===== -->
      <div class="journey-step js-step" data-step="1" id="step-1">
        <div class="journey-step-marker">
          <div class="journey-step-number" id="marker-1">1</div>
        </div>
        <div class="journey-step-content">
          <div class="journey-step-card" id="card-1">
            <div class="flex items-start justify-between gap-4 mb-2">
              <div class="min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="journey-badge" id="badge-1">Start Here</span>
                  <span class="journey-time">~30 sec</span>
                </div>
                <h3 class="font-serif text-xl font-bold text-navy-900">Cast Your Vote</h3>
              </div>
              <div class="journey-step-icon" id="icon-1">
                <Icon name="vote" class="text-white" size={20} />
              </div>
            </div>
            <p class="text-navy-700 text-sm leading-relaxed mb-3" id="desc-1">
              Get a digital credential, prove you're eligible, pick a candidate, and seal your
              ballot in an encrypted envelope. You'll get a signed receipt when you're done.
            </p>

            <!-- Status chip (shown after completion) -->
            <div id="status-1" class="journey-status hidden">
              <Icon name="check-circle" class="text-green-600" size={14} />
              <span>Ballot cast</span>
            </div>

            <details class="journey-learn-more mb-3">
              <summary class="text-xs font-semibold text-gold-700 uppercase tracking-wide cursor-pointer hover:text-gold-900 select-none">
                What happens behind the scenes?
              </summary>
              <div class="mt-2 pl-3 border-l-2 border-gold-200 text-navy-600 text-xs leading-relaxed space-y-2">
                <p><strong>1. Credential generation</strong> &mdash; Your browser generates a secp256k1 keypair. This is your digital identity for this election &mdash; it never leaves your device.</p>
                <p><strong>2. Blind issuance</strong> &mdash; A simulated registration authority issues a blind Schnorr signature. "Blind" means it certifies you <em>without learning which key is yours</em>. Think of it like getting a notarized stamp through a sealed envelope.</p>
                <p><strong>3. Zero-knowledge proof</strong> &mdash; When you cast, the system proves you hold a valid credential without revealing <em>which</em> credential. The server can verify "this voter is registered" without knowing "this voter is Alice."</p>
                <p><strong>4. Encryption</strong> &mdash; Your ballot choice is encrypted with the election public key (ECIES). Nobody can read your vote until the trustees collectively decrypt at tally time.</p>
                <p><strong>5. Optional challenge</strong> &mdash; Before committing, you can "challenge" the machine (Benaloh-style) &mdash; it must prove it sealed your real choice. This is auditable without breaking vote secrecy.</p>
              </div>
            </details>
            <div id="cta-1">
              <a
                href="/votechain/poc/vote"
                data-poc-module
                class="journey-cta-primary"
              >
                Begin Voting
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== STEP 2: Verify Your Receipt ===== -->
      <div class="journey-step js-step" data-step="2" id="step-2">
        <div class="journey-step-marker">
          <div class="journey-step-number" id="marker-2">2</div>
        </div>
        <div class="journey-step-content">
          <div class="journey-step-card" id="card-2">
            <div class="flex items-start justify-between gap-4 mb-2">
              <div class="min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="journey-badge journey-badge--muted" id="badge-2">After You Vote</span>
                  <span class="journey-time">~15 sec</span>
                </div>
                <h3 class="font-serif text-xl font-bold text-navy-900">Verify Your Receipt</h3>
              </div>
              <div class="journey-step-icon journey-step-icon--muted" id="icon-2">
                <Icon name="shield" class="text-gold-700" size={20} />
              </div>
            </div>
            <p class="text-navy-700 text-sm leading-relaxed mb-3">
              Take the receipt from Step 1 and independently check: Is the signature valid?
              Is your sealed ballot on the public board? Was it recorded on the ledger?
            </p>

            <div id="status-2" class="journey-status hidden">
              <Icon name="check-circle" class="text-green-600" size={14} />
              <span>Receipt verified</span>
            </div>

            <details class="journey-learn-more mb-3">
              <summary class="text-xs font-semibold text-gold-700 uppercase tracking-wide cursor-pointer hover:text-gold-900 select-none">
                Why does this matter?
              </summary>
              <div class="mt-2 pl-3 border-l-2 border-gold-200 text-navy-600 text-xs leading-relaxed space-y-2">
                <p><strong>Ed25519 signature check</strong> &mdash; Your receipt contains a digital signature from the gateway server. Verification confirms this signature was created with the server's private key, proving the receipt wasn't forged.</p>
                <p><strong>Merkle inclusion proof</strong> &mdash; The receipt includes a hash path proving your sealed ballot exists at a specific position in the bulletin board's Merkle tree. If anyone tampered with the board, the hashes wouldn't match.</p>
                <p><strong>Ledger anchor</strong> &mdash; Finally, the receipt references a VoteChain Ledger transaction ID. Checking this confirms the bulletin board state was committed to the distributed ledger &mdash; meaning 3 independent nodes agreed on it.</p>
              </div>
            </details>
            <div id="cta-2">
              <a
                href="/votechain/poc/verify"
                data-poc-module
                class="journey-cta-secondary"
              >
                Verify Receipt
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== STEP 3: Watch the Count ===== -->
      <div class="journey-step js-step" data-step="3" id="step-3">
        <div class="journey-step-marker">
          <div class="journey-step-number" id="marker-3">3</div>
        </div>
        <div class="journey-step-content">
          <div class="journey-step-card" id="card-3">
            <div class="flex items-start justify-between gap-4 mb-2">
              <div class="min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="journey-badge journey-badge--muted" id="badge-3">The Payoff</span>
                  <span class="journey-time">~15 sec</span>
                </div>
                <h3 class="font-serif text-xl font-bold text-navy-900">Watch the Count</h3>
              </div>
              <div class="journey-step-icon journey-step-icon--muted" id="icon-3">
                <Icon name="bar-chart" class="text-gold-700" size={20} />
              </div>
            </div>
            <p class="text-navy-700 text-sm leading-relaxed mb-3">
              Open the election monitor. See every ledger event, every bulletin board entry,
              any fraud flags &mdash; then trigger the threshold tally to decrypt and count all ballots.
            </p>

            <!-- Tally results (shown after completion) -->
            <div id="tally-results" class="hidden mb-3">
              <div class="rounded-md bg-cream-50 border border-gold-200 p-3">
                <p class="text-xs font-mono uppercase tracking-wide text-gold-600 mb-2">Tally Results</p>
                <div id="tally-bars" class="space-y-1.5"></div>
              </div>
            </div>

            <div id="status-3" class="journey-status hidden">
              <Icon name="check-circle" class="text-green-600" size={14} />
              <span>Tally published</span>
            </div>

            <details class="journey-learn-more mb-3">
              <summary class="text-xs font-semibold text-gold-700 uppercase tracking-wide cursor-pointer hover:text-gold-900 select-none">
                How does the tally work?
              </summary>
              <div class="mt-2 pl-3 border-l-2 border-gold-200 text-navy-600 text-xs leading-relaxed space-y-2">
                <p><strong>Threshold decryption</strong> &mdash; The election key was split into shares using Shamir's secret sharing. At tally time, a minimum number of trustees (t-of-n) must contribute their share to reconstruct the decryption key. No single trustee can decrypt alone.</p>
                <p><strong>Decryption proofs</strong> &mdash; Each trustee publishes proof that their contribution was computed correctly. Anyone can verify these proofs independently.</p>
                <p><strong>Anchored result</strong> &mdash; The final tally, all decryption proofs, and the closing Merkle root are anchored to the VoteChain Ledger &mdash; creating a permanent, tamper-evident record that all 3 nodes must agree on.</p>
              </div>
            </details>
            <div id="cta-3">
              <a
                href="/votechain/poc/dashboard"
                data-poc-module
                class="journey-cta-secondary"
              >
                Open Dashboard
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
              </a>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /timeline -->
  </div>

  <!-- ===== GO DEEPER ===== -->
  <div class="max-w-3xl mx-auto px-4 pb-8">
    <div class="flex items-center gap-2 mb-5 mt-2">
      <div class="h-px flex-1 bg-navy-200"></div>
      <span class="text-xs font-mono uppercase tracking-widest text-navy-400 whitespace-nowrap">Go Deeper</span>
      <div class="h-px flex-1 bg-navy-200"></div>
    </div>

    <p class="text-navy-500 text-sm text-center mb-5 max-w-lg mx-auto">
      Inspect the infrastructure from every angle.
    </p>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-8">
      <a
        href="/votechain/poc/trust"
        data-poc-module
        class="deeper-card group"
      >
        <div class="deeper-card-icon group-hover:bg-gold-100">
          <Icon name="key" class="text-gold-600" size={18} />
        </div>
        <h4 class="font-serif text-sm font-bold text-navy-900 mb-1">Trust Portal</h4>
        <p class="text-navy-500 text-xs leading-relaxed">
          Inspect every public key. Verify signatures independently.
        </p>
      </a>
      <a
        href="/votechain/poc/monitor"
        data-poc-module
        class="deeper-card group"
      >
        <div class="deeper-card-icon group-hover:bg-gold-100">
          <Icon name="activity" class="text-gold-600" size={18} />
        </div>
        <h4 class="font-serif text-sm font-bold text-navy-900 mb-1">Node Monitor</h4>
        <p class="text-navy-500 text-xs leading-relaxed">
          3 distributed ledger nodes. Real-time health &amp; consistency.
        </p>
      </a>
      <a
        href="/votechain/poc/lookup"
        data-poc-module
        class="deeper-card group"
      >
        <div class="deeper-card-icon group-hover:bg-gold-100">
          <Icon name="search" class="text-gold-600" size={18} />
        </div>
        <h4 class="font-serif text-sm font-bold text-navy-900 mb-1">Ballot Lookup</h4>
        <p class="text-navy-500 text-xs leading-relaxed">
          Search the bulletin board by nullifier or leaf hash.
        </p>
      </a>
    </div>

    <!-- How it works -->
    <details class="rounded-lg border border-gold-200 bg-cream-50 mb-6 group">
      <summary class="flex items-center gap-3 p-4 cursor-pointer select-none">
        <Icon name="help-circle" class="text-gold-600" size={18} />
        <span class="font-serif font-bold text-navy-900 text-sm">How is this different from real voting?</span>
        <svg class="w-4 h-4 text-navy-400 ml-auto transition-transform duration-200 group-open:rotate-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </summary>
      <div class="px-4 pb-4 text-sm text-navy-700 space-y-2 border-t border-gold-200 pt-3">
        <p>
          This POC uses <strong>real cryptography</strong> &mdash; actual Ed25519 signatures,
          ECIES/AES-256-GCM encryption, Schnorr zero-knowledge proofs, and a distributed ledger
          across 3 Cloudflare Workers nodes. But it runs entirely in your browser with simulated
          election data.
        </p>
        <p>
          Think of it as a <strong>flight simulator</strong>: the controls are real, the physics are real,
          but you're not actually 30,000 feet in the air. A production system would add HSMs,
          air gaps, multi-party key ceremonies, and formal audits.
        </p>
      </div>
    </details>

    <!-- Session controls -->
    <div class="flex flex-wrap justify-center gap-3">
      <button
        id="poc-new-voter"
        class="inline-flex items-center gap-2 rounded-md bg-navy-700 px-4 py-2 text-white font-sans text-sm font-semibold hover:bg-navy-800 transition-colors"
        type="button"
        title="Clear your credential and vote again — the election stays intact"
      >
        <Icon name="user-plus" class="text-white" size={18} />
        New Voter Session
      </button>
      <button
        id="poc-reset"
        class="inline-flex items-center gap-2 rounded-md border border-red-300 px-4 py-2 text-red-600 font-sans text-sm font-semibold hover:bg-red-50 transition-colors"
        type="button"
        title="Destroy the entire election and regenerate all keys"
      >
        <Icon name="x" class="text-red-500" size={18} />
        Reset Election
      </button>
    </div>

    <!-- Mini stats footer -->
    <div id="poc-stats" class="hidden mt-6 flex justify-center gap-6 text-xs text-navy-400 font-mono">
      <span id="stat-ballots"></span>
      <span id="stat-events"></span>
      <span id="stat-nodes">3 nodes</span>
    </div>
  </div>

  <style>
    /* ===== Turnstile Gate ===== */
    .poc-gate {
      border-radius: 0.75rem;
      border: 1px solid var(--color-gold-300, #d4a843);
      background: var(--color-cream-50, #fdf8f0);
      padding: 1.25rem;
      transition: border-color 0.4s ease, background 0.4s ease;
    }

    .poc-gate[data-locked="false"] {
      border-color: #86efac;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }

    .poc-gate-icon {
      flex-shrink: 0;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-cream-100, #fdf5e6);
      color: var(--color-gold-700, #92400e);
      transition: background 0.4s ease, color 0.4s ease;
    }

    .poc-gate[data-locked="false"] .poc-gate-icon {
      background: #dcfce7;
      color: #16a34a;
    }

    .poc-gate[data-locked="false"] .poc-gate-icon--locked { display: none; }
    .poc-gate[data-locked="false"] .poc-gate-icon--unlocked { display: block !important; }
    .poc-gate[data-locked="true"] .poc-gate-icon--unlocked { display: none; }

    .poc-gate[data-locked="true"] #poc-gate-heading {
      color: var(--color-navy-800, #0f2439);
    }
    .poc-gate[data-locked="false"] #poc-gate-heading {
      color: #166534;
    }

    .poc-gate[data-locked="true"] #poc-turnstile-status {
      color: var(--color-navy-500, #4a6f8f);
    }
    .poc-gate[data-locked="false"] #poc-turnstile-status {
      color: #15803d;
    }

    :global(html.dark) .poc-gate {
      background: #1a2f4a;
      border-color: #3a5a7c;
    }
    :global(html.dark) .poc-gate[data-locked="false"] {
      background: linear-gradient(135deg, #0f2818 0%, #132f1e 100%);
      border-color: #22c55e;
    }
    :global(html.dark) .poc-gate-icon {
      background: rgba(184, 134, 11, 0.15);
      color: var(--color-gold-400, #c9a030);
    }
    :global(html.dark) .poc-gate[data-locked="false"] .poc-gate-icon {
      background: rgba(22, 163, 74, 0.2);
      color: #4ade80;
    }
    :global(html.dark) .poc-gate[data-locked="false"] #poc-gate-heading {
      color: #86efac;
    }
    :global(html.dark) .poc-gate[data-locked="false"] #poc-turnstile-status {
      color: #4ade80;
    }

    /* ===== Entrance Animations ===== */
    .hero-fade {
      opacity: 0;
      transform: translateY(8px);
      animation: hero-enter 0.5s ease-out forwards;
      animation-delay: calc(var(--delay, 0) * 0.08s);
    }

    @keyframes hero-enter {
      to { opacity: 1; transform: translateY(0); }
    }

    .js-step {
      opacity: 0;
      transform: translateX(-12px);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }
    .js-step.visible {
      opacity: 1;
      transform: translateX(0);
    }

    /* ===== Progress Bar ===== */
    .poc-progress {
      position: relative;
      padding: 0;
    }

    .poc-progress-track {
      height: 4px;
      background: var(--color-navy-200, #c5d5e5);
      border-radius: 2px;
      overflow: hidden;
      /* Inset so the track starts/ends at dot centers */
      margin: 0 auto;
      position: relative;
    }

    .poc-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-gold-500, #c9a030), var(--color-gold-600, #b8860b));
      border-radius: 2px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .poc-progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      top: -12px;
      margin-bottom: -8px;
    }

    .poc-progress-dot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    .poc-dot-inner {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      font-family: var(--font-mono, monospace);
      color: var(--color-navy-400, #7b9ec2);
      background: white;
      border: 2px solid var(--color-navy-200, #c5d5e5);
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .poc-dot-inner.active {
      color: white;
      background: var(--color-gold-600, #b8860b);
      border-color: var(--color-gold-600, #b8860b);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--color-gold-400, #c9a030);
    }

    .poc-dot-inner.complete {
      color: white;
      background: #16a34a;
      border-color: #16a34a;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #22c55e;
    }

    .poc-dot-label {
      font-size: 0.6rem;
      font-family: var(--font-mono, monospace);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-navy-400, #7b9ec2);
      transition: color 0.3s ease;
    }

    .poc-dot-inner.active + .poc-dot-label,
    .poc-dot-inner.complete + .poc-dot-label {
      color: var(--color-navy-700, #1e3a5f);
    }

    /* ===== Completion Banner ===== */
    .poc-banner {
      background: linear-gradient(135deg, #15803d 0%, #166534 100%);
      overflow: hidden;
    }
    .poc-banner.hidden { display: none; }
    .poc-banner-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .poc-banner-cta {
      flex-shrink: 0;
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 0.375rem 0.875rem;
      border-radius: 0.375rem;
      background: rgba(255,255,255,0.2);
      color: white;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .poc-banner-cta:hover {
      background: rgba(255,255,255,0.3);
    }

    @keyframes banner-enter {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .poc-banner.show {
      display: block;
      animation: banner-enter 0.5s ease-out;
    }

    /* ===== Journey Timeline ===== */
    .journey-timeline {
      position: relative;
      padding-left: 2.25rem;
      isolation: isolate; /* creates stacking context so ::before/::after z-index works */
    }

    /* Vertical connector line — centered on dots, spans dot-1 center to dot-3 center */
    .journey-timeline::before {
      content: '';
      position: absolute;
      /* Center the 2px line on the dot center: dot is 1.875rem wide at left:0, center = 0.9375rem, offset by -1px */
      left: calc(0.9375rem - 1px);
      width: 2px;
      background: var(--color-navy-200, #c5d5e5);
      transition: background 0.5s;
      /* top/bottom set by JS via CSS custom properties */
      top: var(--timeline-top, 2.2rem);
      bottom: var(--timeline-bottom, 0.9375rem);
      z-index: -1;
    }

    /* Progress fill overlay — behind dots */
    .journey-timeline::after {
      content: '';
      position: absolute;
      left: calc(0.9375rem - 1px);
      top: var(--timeline-top, 2.2rem);
      width: 2px;
      height: 0;
      background: linear-gradient(to bottom, var(--color-gold-500, #c9a030), #16a34a);
      transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: -1;
    }
    .journey-timeline[data-progress="done"]::after {
      background: #16a34a;
    }
    .journey-timeline[data-progress="1"]::after { height: 0; }
    /* Heights for progress="2", "3", "done" are set via JS custom properties */
    .journey-timeline[data-progress="2"]::after { height: var(--progress-h2, 50%); }
    .journey-timeline[data-progress="3"]::after,
    .journey-timeline[data-progress="done"]::after { height: var(--progress-h3, 100%); }

    .journey-step {
      position: relative;
      padding-bottom: 1.25rem;
    }
    .journey-step:last-child { padding-bottom: 0; }

    .journey-step-marker {
      position: absolute;
      left: -2.25rem;
      top: 1.25rem;
      width: 1.875rem;
      height: 1.875rem;
      z-index: 1;
    }

    .journey-step-number {
      width: 1.875rem;
      height: 1.875rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      font-family: var(--font-mono, monospace);
      color: var(--color-navy-400, #7b9ec2);
      background: white;
      border: 2px solid var(--color-navy-200, #c5d5e5);
      transition: all 0.4s ease;
      position: relative;
      z-index: 2;
    }

    .journey-step-number.active {
      color: white;
      background: var(--color-gold-600, #b8860b);
      border-color: var(--color-gold-600, #b8860b);
      box-shadow: 0 0 0 3px white, 0 0 0 5px var(--color-gold-300, #d4a843);
    }

    .journey-step-number.complete {
      color: white;
      background: #16a34a;
      border-color: #16a34a;
      box-shadow: 0 0 0 3px white, 0 0 0 5px #22c55e;
      font-size: 0;
    }
    /* Checkmark for completed steps */
    .journey-step-number.complete::after {
      content: '';
      width: 10px;
      height: 6px;
      border-left: 2px solid white;
      border-bottom: 2px solid white;
      transform: rotate(-45deg) translateY(-1px);
      display: block;
    }

    .journey-step-content {
      padding-left: 0.75rem;
    }

    /* ===== Step Cards ===== */
    .journey-step-card {
      background: white;
      border: 1px solid var(--color-navy-200, #c5d5e5);
      border-radius: 0.75rem;
      padding: 1.25rem;
      transition: border-color 0.3s, box-shadow 0.3s, opacity 0.3s;
    }

    .journey-step-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    .journey-step-card.active-card {
      border-color: var(--color-gold-400, #c9a030);
      box-shadow: 0 4px 16px rgba(184, 134, 11, 0.12);
      background: linear-gradient(135deg, white 0%, var(--color-cream-50, #fdf8f0) 100%);
    }

    .journey-step-card.completed-card {
      border-color: #86efac;
      background: linear-gradient(135deg, white 0%, #f0fdf4 100%);
    }

    .journey-step-card.locked-card {
      opacity: 0.55;
    }

    /* Force readable text on completed cards (light bg even in dark mode) */
    .journey-step-card.completed-card h3,
    .journey-step-card.completed-card p {
      color: #0a1628 !important;
    }
    .journey-step-card.completed-card .journey-learn-more summary {
      color: #92400e !important;
    }
    .journey-step-card.completed-card .journey-learn-more div {
      color: #1e3a5f !important;
    }

    /* ===== Badges ===== */
    .journey-badge {
      display: inline-block;
      font-size: 0.625rem;
      font-family: var(--font-mono, monospace);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 8px;
      border-radius: 9999px;
      background: var(--color-gold-100, #fef3c7);
      color: var(--color-gold-700, #92400e);
    }

    .journey-badge--muted {
      background: var(--color-navy-100, #e8eef5);
      color: var(--color-navy-400, #7b9ec2);
    }

    .journey-badge--complete {
      background: #dcfce7;
      color: #166534;
    }

    .journey-badge--active {
      background: var(--color-gold-100, #fef3c7);
      color: var(--color-gold-700, #92400e);
    }

    .journey-time {
      font-size: 0.625rem;
      color: var(--color-navy-400, #7b9ec2);
      font-family: var(--font-mono, monospace);
    }

    /* ===== Status Chips ===== */
    .journey-status {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: #16a34a;
      margin-bottom: 0.75rem;
      padding: 0.375rem 0.625rem;
      background: #f0fdf4;
      border-radius: 0.375rem;
      border: 1px solid #bbf7d0;
      width: fit-content;
    }
    .journey-status.hidden { display: none; }

    /* ===== Step Icons ===== */
    .journey-step-icon {
      flex-shrink: 0;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-navy-700, #1e3a5f);
      transition: background 0.3s;
    }

    .journey-step-icon--muted {
      background: var(--color-cream-100, #fdf5e6);
    }

    .journey-step-icon.icon-complete {
      background: #16a34a;
    }

    /* ===== CTAs ===== */
    .journey-cta-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      border-radius: 0.5rem;
      background: var(--color-navy-700, #1e3a5f);
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
    }
    .journey-cta-primary:hover {
      background: var(--color-navy-800, #0f2439);
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }
    .journey-cta-primary:active { transform: scale(0.98); }

    .journey-cta-secondary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      border-radius: 0.5rem;
      border: 1px solid var(--color-navy-300, #7b9ec2);
      color: var(--color-navy-700, #1e3a5f);
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .journey-cta-secondary:hover {
      border-color: var(--color-gold-400, #c9a030);
      background: var(--color-cream-50, #fdf8f0);
      transform: translateX(2px);
    }

    .journey-cta-done {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      border-radius: 0.5rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .journey-cta-done:hover {
      background: #dcfce7;
      transform: translateX(2px);
    }

    /* ===== Learn More ===== */
    .journey-learn-more summary {
      list-style: none;
    }
    .journey-learn-more summary::-webkit-details-marker { display: none; }
    .journey-learn-more summary::before {
      content: '+ ';
      font-weight: 700;
    }
    .journey-learn-more[open] summary::before {
      content: '- ';
    }

    /* ===== Go Deeper Cards ===== */
    .deeper-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--color-navy-200, #c5d5e5);
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
    }
    .deeper-card:hover {
      border-color: var(--color-gold-400, #c9a030);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      transform: translateY(-2px);
    }
    .deeper-card-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-cream-100, #fdf5e6);
      margin-bottom: 0.5rem;
      transition: background 0.2s;
    }

    /* ===== Dark mode ===== */
    :global(html.dark) .journey-step-card {
      background: #1a2f4a;
      border-color: #3a5a7c;
    }
    :global(html.dark) .journey-step-card.active-card {
      background: linear-gradient(135deg, #1a2f4a 0%, #1e3a5f 100%);
      border-color: var(--color-gold-500, #c9a030);
    }
    :global(html.dark) .journey-step-card.completed-card {
      background: linear-gradient(135deg, #0f2818 0%, #132f1e 100%);
      border-color: #22c55e;
    }
    /* Dark-mode completed cards: force dark-bg-friendly text */
    :global(html.dark) .journey-step-card.completed-card h3 {
      color: #e8f5e9 !important;
    }
    :global(html.dark) .journey-step-card.completed-card p {
      color: #c8e6c9 !important;
    }
    :global(html.dark) .journey-step-card.completed-card .journey-learn-more summary {
      color: #f0c86a !important;
    }
    :global(html.dark) .journey-step-card.completed-card .journey-learn-more div {
      color: #c8e6c9 !important;
    }
    :global(html.dark) .journey-step-card.completed-card .journey-status {
      background: rgba(22, 163, 74, 0.15);
      border-color: rgba(34, 197, 94, 0.3);
    }
    :global(html.dark) .journey-step-card.completed-card .journey-cta-done {
      background: rgba(22, 163, 74, 0.15);
      border-color: rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }
    :global(html.dark) .journey-step-card.completed-card .journey-badge--complete {
      background: rgba(22, 163, 74, 0.2);
      color: #4ade80;
    }
    :global(html.dark) .journey-timeline::before {
      background: #3a5a7c;
    }
    :global(html.dark) .deeper-card {
      background: #1a2f4a;
      border-color: #3a5a7c;
    }
    :global(html.dark) .poc-progress-track {
      background: #3a5a7c;
    }
    :global(html.dark) .poc-dot-inner {
      background: #1a2f4a;
      border-color: #3a5a7c;
    }
    :global(html.dark) .poc-dot-inner.active {
      box-shadow: 0 0 0 2px #1a2f4a, 0 0 0 4px var(--color-gold-400, #c9a030);
    }
    :global(html.dark) .poc-dot-inner.complete {
      box-shadow: 0 0 0 2px #1a2f4a, 0 0 0 4px #22c55e;
    }
    :global(html.dark) .journey-step-number {
      background: #1a2f4a;
      border-color: #3a5a7c;
    }
    :global(html.dark) .journey-step-number.complete {
      box-shadow: 0 0 0 3px #1a2f4a, 0 0 0 5px #22c55e;
    }
    :global(html.dark) .journey-step-number.active {
      box-shadow: 0 0 0 3px #1a2f4a, 0 0 0 5px var(--color-gold-400, #c9a030);
    }

    /* ===== Pulse animation for active step ===== */
    @keyframes gentle-pulse {
      0%, 100% { box-shadow: 0 0 0 3px white, 0 0 0 5px var(--color-gold-300, #d4a843); }
      50% { box-shadow: 0 0 0 3px white, 0 0 0 7px var(--color-gold-300, #d4a843); }
    }
    .journey-step-number.active {
      animation: gentle-pulse 2.5s ease-in-out infinite;
    }

    /* Mobile refinements */
    @media (max-width: 640px) {
      .poc-banner .max-w-3xl {
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }
      .poc-banner-cta { align-self: center; }
    }
  </style>

  <script>
    import { resetPocState, invalidateCredential } from '../../../votechain-poc';

    // ===== Timeline Sizing =====
    // Measure actual dot positions to precisely clip the vertical line
    function sizeTimeline() {
      const timeline = document.getElementById('journey-timeline');
      const m1 = document.getElementById('marker-1');
      const m3 = document.getElementById('marker-3');
      if (!timeline || !m1 || !m3) return;

      const timelineRect = timeline.getBoundingClientRect();
      const m1Rect = m1.getBoundingClientRect();
      const m3Rect = m3.getBoundingClientRect();

      // Skip if elements aren't laid out yet
      if (m1Rect.height === 0 || m3Rect.height === 0) return;

      // Center of each dot relative to the timeline container
      const dotRadius = m1Rect.height / 2;
      const topPx = (m1Rect.top - timelineRect.top) + dotRadius;
      const bottomOffset = timelineRect.bottom - (m3Rect.top + dotRadius);

      // Also measure dot-2 for the halfway progress fill
      const m2 = document.getElementById('marker-2');
      const m2Rect = m2?.getBoundingClientRect();

      timeline.style.setProperty('--timeline-top', `${topPx}px`);
      timeline.style.setProperty('--timeline-bottom', `${bottomOffset}px`);

      // Total line length = distance from dot-1 center to dot-3 center
      const totalHeight = (m3Rect.top + dotRadius) - (m1Rect.top + dotRadius);
      if (m2Rect && m2Rect.height > 0) {
        const midHeight = (m2Rect.top + dotRadius) - (m1Rect.top + dotRadius);
        timeline.style.setProperty('--progress-h2', `${midHeight}px`);
      }
      timeline.style.setProperty('--progress-h3', `${totalHeight}px`);
    }

	    // ===== Horizontal Progress Bar Sizing =====
	    // Clip the track so it spans only from dot-1 center to dot-3 center
	    function sizeProgressBar() {
	      const track = document.querySelector<HTMLElement>('.poc-progress-track');
	      const d1 = document.getElementById('dot-1');
	      const d3 = document.getElementById('dot-3');
	      const container = document.querySelector<HTMLElement>('.poc-progress');
	      if (!track || !d1 || !d3 || !container) return;

      const cRect = container.getBoundingClientRect();
      const d1Rect = d1.getBoundingClientRect();
      const d3Rect = d3.getBoundingClientRect();
      if (d1Rect.width === 0 || d3Rect.width === 0) return;

      const d1Center = (d1Rect.left + d1Rect.width / 2) - cRect.left;
      const d3Center = (d3Rect.left + d3Rect.width / 2) - cRect.left;

      track.style.marginLeft = `${d1Center}px`;
      track.style.width = `${d3Center - d1Center}px`;
    }

    // ===== State Detection =====
    const STORAGE_KEY = 'votechain_poc_state_v2';
    const RECEIPT_KEY = 'votechain_poc_last_receipt';

    function readPocState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function getMilestones() {
      const state = readPocState();
      const hasCredential = !!state?.credential;
      const hasReceipt = !!localStorage.getItem(RECEIPT_KEY);
      // Gate on credential: a new voter (no credential) hasn't voted yet,
      // even if the election's bulletin board already has ballots.
      const hasVoted = hasCredential && (state?.bb?.leaves?.length ?? 0) > 0;
      // Only show tally as complete if this voter has been through the full flow
      const hasTally = hasVoted && hasReceipt && !!state?.tally;
      const ballotCount = state?.bb?.leaves?.length ?? 0;
      const eventCount = state?.vcl?.events?.length ?? 0;
      const tally = state?.tally ?? null;
      return { hasCredential, hasVoted, hasReceipt, hasTally, ballotCount, eventCount, tally };
    }

    // ===== UI Update =====
    function updateJourneyUI() {
      const m = getMilestones();
      const timeline = document.getElementById('journey-timeline');
      const progressFill = document.getElementById('poc-progress-fill');
      const banner = document.getElementById('poc-complete-banner');

      // Determine current step (0-indexed: 0 = haven't started, 1 = voted, 2 = verified, 3 = tallied)
      let completedSteps = 0;
      if (m.hasVoted) completedSteps = 1;
      if (m.hasVoted && m.hasReceipt) completedSteps = 2;  // receipt = verified
      if (m.hasTally) completedSteps = 3;

      // Active step is the next uncompleted one
      const activeStep = Math.min(completedSteps + 1, 3);
      const allDone = completedSteps >= 3;

      // Timeline vertical progress
      if (timeline) {
        if (allDone) timeline.setAttribute('data-progress', 'done');
        else if (completedSteps >= 2) timeline.setAttribute('data-progress', '3');
        else if (completedSteps >= 1) timeline.setAttribute('data-progress', '2');
        else timeline.setAttribute('data-progress', '1');
      }

      // Progress bar fill
      if (progressFill) {
        const pct = allDone ? 100 : (completedSteps / 3) * 100;
        progressFill.style.width = `${pct}%`;
      }

      // Progress dots
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot-${i}`);
        if (!dot) continue;
        dot.classList.remove('active', 'complete');
        if (i <= completedSteps) dot.classList.add('complete');
        else if (i === activeStep) dot.classList.add('active');
      }

      // Scroll to active step on click
      document.querySelectorAll('[data-progress-step]').forEach(btn => {
        btn.addEventListener('click', () => {
          const stepNum = btn.getAttribute('data-progress-step');
          const target = document.getElementById(`step-${stepNum}`);
          target?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
      });

      // Step cards
      for (let i = 1; i <= 3; i++) {
        const card = document.getElementById(`card-${i}`);
        const marker = document.getElementById(`marker-${i}`);
        const badge = document.getElementById(`badge-${i}`);
        const icon = document.getElementById(`icon-${i}`);
        const status = document.getElementById(`status-${i}`);
        const cta = document.getElementById(`cta-${i}`);

        if (!card) continue;

        card.classList.remove('active-card', 'completed-card', 'locked-card');
        marker?.classList.remove('active', 'complete');
        icon?.classList.remove('icon-complete');

        if (i <= completedSteps) {
          // Completed step
          card.classList.add('completed-card');
          marker?.classList.add('complete');
          icon?.classList.add('icon-complete');
          // Fix icon SVG color: gold-on-green is unreadable, switch to white
          const svg = icon?.querySelector('svg');
          if (svg) { svg.classList.remove('text-gold-700'); svg.classList.add('text-white'); }
          if (badge) {
            badge.textContent = i === 1 ? 'Done' : i === 2 ? 'Done' : 'Done';
            badge.className = 'journey-badge journey-badge--complete';
          }
          if (status) status.classList.remove('hidden');

          // Change CTA to "completed" style
	          if (cta) {
	            const link = cta.querySelector('a');
	            if (link) {
	              link.className = 'journey-cta-done';
	              const labels: Record<number, string> = { 1: 'View Again', 2: 'Verify Again', 3: 'View Results' };
	              link.innerHTML = `${labels[i]} <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`;
	            }
	          }
        } else if (i === activeStep) {
          // Current active step
          card.classList.add('active-card');
	          marker?.classList.add('active');
	          if (badge) {
	            const labels: Record<number, string> = { 1: 'Start Here', 2: 'You\'re Here', 3: 'You\'re Here' };
	            badge.textContent = labels[i];
	            badge.className = 'journey-badge journey-badge--active';
	          }
          icon?.classList.remove('journey-step-icon--muted');
          // Make icon SVG white on navy bg (matching step 1's default style)
          const svg = icon?.querySelector('svg');
          if (svg) { svg.classList.remove('text-gold-700'); svg.classList.add('text-white'); }
          if (i > 1) {
            // Promote secondary CTA to primary for active step
            const link = cta?.querySelector('a');
            if (link) link.className = 'journey-cta-primary';
          }
        } else {
          // Future locked step
          card.classList.add('locked-card');
          if (badge) {
            badge.className = 'journey-badge journey-badge--muted';
          }
        }
      }

      // Show tally results if available
	      // totals is { contest_id: { option_id: count } }
	      if (m.hasTally && m.tally?.totals) {
	        const tallyEl = document.getElementById('tally-results');
	        const barsEl = document.getElementById('tally-bars');
	        if (tallyEl && barsEl) {
	          const totals = m.tally.totals as Record<string, Record<string, number>>;
	          // Flatten all counts to find the global max
	          const allCounts = Object.values(totals).flatMap(opts => Object.values(opts));
	          const max = Math.max(...allCounts, 1);
	          barsEl.innerHTML = Object.entries(totals)
	            .map(([, options]) =>
	              Object.entries(options)
	                .sort(([, a], [, b]) => b - a)
	                .map(([name, count]) => {
	                  const pct = Math.round((count / max) * 100);
	                  return `<div class="flex items-center gap-2 text-xs">
                    <span class="w-24 text-navy-700 font-medium truncate" title="${name}">${name}</span>
                    <div class="flex-1 h-2 bg-navy-100 rounded-full overflow-hidden">
                      <div class="h-full rounded-full" style="width: ${pct}%; background: ${pct === 100 ? '#16a34a' : 'var(--color-gold-500, #c9a030)'}; transition: width 1s ease-out"></div>
                    </div>
                    <span class="w-6 text-right font-mono text-navy-500">${count}</span>
                  </div>`;
                })
                .join('')
            )
            .join('');
          tallyEl.classList.remove('hidden');
        }
      }

      // Completion banner
      if (allDone && banner) {
        banner.classList.remove('hidden');
        banner.classList.add('show');
      }

      // Stats footer
      const statsEl = document.getElementById('poc-stats');
      const state = readPocState();
      if (state && statsEl) {
        statsEl.classList.remove('hidden');
        const ballotsEl = document.getElementById('stat-ballots');
        const eventsEl = document.getElementById('stat-events');
        if (ballotsEl) ballotsEl.textContent = `${m.ballotCount} ballot${m.ballotCount !== 1 ? 's' : ''}`;
        if (eventsEl) eventsEl.textContent = `${m.eventCount} ledger event${m.eventCount !== 1 ? 's' : ''}`;
      }
    }

    // ===== Scroll-triggered step entrance =====
	    function initScrollAnimations() {
	      const steps = document.querySelectorAll('.js-step');

      // If no IntersectionObserver, just show immediately
      if (!('IntersectionObserver' in window)) {
        steps.forEach(s => s.classList.add('visible'));
        sizeTimeline();
        return;
      }

	      let revealed = 0;

	      const observer = new IntersectionObserver(
	        (entries) => {
	          entries.forEach((entry) => {
	            if (entry.isIntersecting) {
              // Stagger the entrance
              const el = entry.target;
              const step = Number(el.getAttribute('data-step') ?? 1);
              setTimeout(() => {
                el.classList.add('visible');
                revealed++;
                // Re-measure timeline after each step becomes visible
                // (especially after the last one so the line endpoints are correct)
                requestAnimationFrame(() => sizeTimeline());
              }, (step - 1) * 120);
              observer.unobserve(el);
            }
          });
        },
        { threshold: 0.15, rootMargin: '0px 0px -40px 0px' }
      );

      steps.forEach(s => observer.observe(s));
    }

    // ===== Session Controls =====
    const newVoterBtn = document.getElementById('poc-new-voter');
    newVoterBtn?.addEventListener('click', () => {
      invalidateCredential();
      window.location.reload();
    });

    const resetButton = document.getElementById('poc-reset');
    resetButton?.addEventListener('click', () => {
      resetPocState();
      window.location.reload();
    });

    // ===== Turnstile Gate =====
	    const gate = document.getElementById('poc-gate');
	    const status = document.getElementById('poc-turnstile-status');
	    const turnstileMount = document.getElementById('poc-turnstile');
	    const moduleLinks = Array.from(document.querySelectorAll('[data-poc-module]'));
	    let turnstileEnabled = false;
	    let turnstileWidgetId: string | null = null;

	    function isSafeNextPath(next: string | null): next is string {
	      if (!next) return false;
	      if (!next.startsWith('/votechain/poc/')) return false;
	      if (next.startsWith('//')) return false;
	      return true;
	    }

	    function setGateVisible(visible: boolean) {
	      if (!gate) return;
	      if (visible) gate.classList.remove('hidden');
	      else gate.classList.add('hidden');
	    }

    function formatExpiry(iso: string): string {
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString(undefined, {
          month: 'short', day: 'numeric',
          hour: 'numeric', minute: '2-digit',
        });
      } catch { return iso; }
    }

	    function setLocked(locked: boolean, message: string) {
	      if (status && typeof message === 'string') status.textContent = message;
	      const heading = document.getElementById('poc-gate-heading');
	      if (heading) {
	        heading.textContent = locked
	          ? 'Complete a quick verification check to unlock the interactive modules.'
	          : 'Verification complete — interactive modules unlocked.';
	      }
	      if (!turnstileEnabled) return;
	      for (const link of moduleLinks) {
	        if (!(link instanceof HTMLElement)) continue;
        if (locked) link.classList.add('pointer-events-none', 'opacity-60');
        else link.classList.remove('pointer-events-none', 'opacity-60');
      }
      if (!gate) return;
      gate.setAttribute('data-locked', locked ? 'true' : 'false');
    }

    async function refreshSession() {
      if (!turnstileEnabled) return;
      try {
        const r = await fetch('/api/votechain/poc/session', { cache: 'no-store' });
        if (!r.ok) return;
        const data = await r.json();
        if (data?.enabled && data?.unlocked) {
          setLocked(false, `Session active until ${formatExpiry(data.expires_at)}`);
          turnstileMount?.classList.add('hidden');
        } else {
          setLocked(true, 'Locked.');
        }
      } catch {}
	    }

	    function loadTurnstileScript() {
	      if (window.turnstile) return Promise.resolve(undefined);
	      return new Promise((resolve, reject) => {
	        const script = document.createElement('script');
	        script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
	        script.async = true;
	        script.defer = true;
	        script.onload = () => resolve(undefined);
	        script.onerror = () => reject(new Error('turnstile_load_failed'));
	        document.head.appendChild(script);
	      });
	    }

    async function initPocGate() {
      try {
        const r = await fetch('/api/votechain/poc/config', { cache: 'no-store' });
        if (!r.ok) return;
        const cfg = await r.json();
        if (!cfg?.enabled || typeof cfg.site_key !== 'string') return;
        turnstileEnabled = true;
        setGateVisible(true);
        setLocked(true, 'Locked.');
        await refreshSession();
        if (gate?.getAttribute('data-locked') === 'false') return;
        await loadTurnstileScript();
        if (!window.turnstile || typeof window.turnstile.render !== 'function') {
          setLocked(true, 'Turnstile failed to load.');
          return;
	        }
	        if (!turnstileMount) return;

	        function handleTurnstileToken(token: string) {
	          window.votechainPocTurnstileCallback?.(token);
	        }

	        turnstileWidgetId = window.turnstile.render(turnstileMount, {
	          sitekey: cfg.site_key,
	          callback: handleTurnstileToken,
	        });
	      } catch {}
	    }

	    window.votechainPocTurnstileCallback = async function(token: string) {
	      if (!turnstileEnabled) return;
	      setLocked(true, 'Verifying...');
	      try {
	        const r = await fetch('/api/votechain/poc/unlock', {
	          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ token }),
        });
        if (!r.ok) {
          setLocked(true, 'Verification failed.');
          if (window.turnstile && turnstileWidgetId !== null) window.turnstile.reset(turnstileWidgetId);
          return;
	        }
	        const data = await r.json();
	        setLocked(false, `Session active until ${formatExpiry(data.expires_at)}`);
	        turnstileMount?.classList.add('hidden');
	        const next = new URL(window.location.href).searchParams.get('next');
	        if (isSafeNextPath(next)) window.location.assign(next);
	      } catch {
	        setLocked(true, 'Verification failed.');
	        if (window.turnstile && turnstileWidgetId !== null) window.turnstile.reset(turnstileWidgetId);
	      }
	    };

    // ===== Init =====
    updateJourneyUI();
    initScrollAnimations();
    initPocGate();
    // Size elements after layout settles
    requestAnimationFrame(() => { sizeTimeline(); sizeProgressBar(); });
    window.addEventListener('resize', () => { sizeTimeline(); sizeProgressBar(); });
  </script>
</BaseLayout>
