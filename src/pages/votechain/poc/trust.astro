---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import OfficialSeal from '../../../components/ui/OfficialSeal.astro';
import Divider from '../../../components/ui/Divider.astro';
import Icon from '../../../components/ui/Icon.astro';
import PocToolNav from '../../../components/votechain/PocToolNav.astro';
---

<BaseLayout
  title="VoteChain Public Trust Portal"
  description="Independently verify every cryptographic signature, Merkle root, and ledger event in the VoteChain POC election."
  ogType="article"
  article={{
    publishedTime: '2026-02-08',
    author: 'Absurdity Index',
    section: 'Policy',
    tags: ['votechain', 'ewp', 'poc', 'trust', 'verification', 'cryptography'],
  }}
>
  <main class="bg-parchment min-h-screen">
    <section class="relative bg-navy-900 py-10 sm:py-14">
      <div class="max-w-5xl mx-auto px-4 text-center relative z-10">
        <div class="flex justify-center">
          <OfficialSeal size="90" />
        </div>
        <p class="text-sm text-gold-500 font-mono uppercase tracking-widest mt-5 mb-2">EWP POC</p>
        <h1 class="font-serif text-3xl sm:text-4xl text-gold-400 font-bold">
          Public Trust Portal
        </h1>
        <p class="mt-3 text-gold-300/80 font-sans text-base max-w-3xl mx-auto">
          Independently verify every cryptographic signature, Merkle root, and ledger event.
          This page runs all verification checks that an observer, journalist, or voter could
          run against the election data &mdash; proving the system is operating correctly.
        </p>
      </div>
    </section>
    <PocToolNav current="trust" />

    <div class="max-w-5xl mx-auto px-4 py-10 sm:py-12 space-y-8">
      <!-- Section 1: System Integrity Status -->
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="check-circle" class="text-gold-600" />
            System Integrity Status
          </h2>
        </div>

        <!-- Overall status banner -->
        <div id="overall-banner" class="mt-4 rounded-lg border p-4 hidden">
          <div class="flex items-center gap-3">
            <span id="overall-icon"></span>
            <div>
              <p id="overall-title" class="font-serif font-bold text-lg"></p>
              <p id="overall-subtitle" class="text-sm mt-0.5"></p>
            </div>
          </div>
        </div>

        <!-- Individual check rows -->
        <div id="checks-list" class="mt-4 space-y-2">
          <div class="animate-pulse space-y-2">
            <div class="h-10 bg-navy-100 rounded"></div>
            <div class="h-10 bg-navy-100 rounded"></div>
            <div class="h-10 bg-navy-100 rounded"></div>
            <div class="h-10 bg-navy-100 rounded"></div>
            <div class="h-10 bg-navy-100 rounded"></div>
            <div class="h-10 bg-navy-100 rounded"></div>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <button
            id="reverify-btn"
            class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-4 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
            type="button"
          >
            <Icon name="repeat" class="text-gold-300" size={18} />
            Re-verify All
          </button>
          <button
            id="export-btn"
            class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-4 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            type="button"
          >
            <Icon name="download" class="text-navy-700" size={18} />
            Export Audit Package
          </button>
        </div>

        <p id="verify-status" class="mt-3 text-sm text-navy-500"></p>
      </section>

      <!-- Section 2: Election Manifest -->
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="file-text" class="text-gold-600" />
          Election Manifest
        </h2>
        <p class="text-navy-600 text-sm mt-2">
          The election manifest is the authoritative configuration for the entire election: it
          defines the contests, cryptographic parameters, trustee keys, and the time window during
          which voting is allowed. The manifest is signed by the election authority and anchored
          on the VoteChain ledger before any ballots are accepted.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          If the manifest signature is valid, it proves the election parameters have not been
          tampered with since publication. Any change to any field &mdash; adding a candidate,
          altering the time window, swapping a trustee key &mdash; would invalidate the signature.
        </p>
        <div class="mt-4 flex items-center gap-3">
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">Verification Status</p>
          <span id="manifest-badge" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold bg-navy-100 text-navy-500">
            Checking...
          </span>
        </div>
        <pre
          class="mt-3 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono max-h-80"><code id="manifest-json">Loading...</code></pre>
      </section>

      <!-- Section 3: Bulletin Board Integrity -->
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="git-commit" class="text-gold-600" />
          Bulletin Board Integrity
        </h2>
        <p class="text-navy-600 text-sm mt-2">
          The bulletin board stores every encrypted ballot as a leaf in a Merkle tree. The tree
          root is a single hash that summarizes all ballots &mdash; if any ballot is added,
          removed, or modified, the root changes. By recomputing the root from all leaves and
          comparing it to the latest Signed Tree Head (STH), we can prove the bulletin board
          has not been tampered with.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          This is the same technique used by Certificate Transparency logs to detect rogue TLS
          certificates. It turns "trust the operator" into "trust the math."
        </p>

        <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4 text-center">
            <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-1">Total Leaves</p>
            <p class="font-serif text-2xl text-navy-900 font-bold" id="bb-total-leaves">-</p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4 text-center">
            <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-1">STH Count</p>
            <p class="font-serif text-2xl text-navy-900 font-bold" id="bb-sth-count">-</p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4 text-center col-span-2">
            <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-1">Root Match</p>
            <span id="bb-root-badge" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold bg-navy-100 text-navy-500">
              Checking...
            </span>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4">
            <p class="text-[10px] font-mono text-navy-400 mb-1">Computed Merkle Root</p>
            <p id="bb-computed-root" class="font-mono text-xs text-navy-900 break-all">-</p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4">
            <p class="text-[10px] font-mono text-navy-400 mb-1">Latest STH Root</p>
            <p id="bb-sth-root" class="font-mono text-xs text-navy-900 break-all">-</p>
          </div>
        </div>
      </section>

      <!-- Section 4: VoteChain Ledger -->
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="list" class="text-gold-600" />
          VoteChain Ledger
        </h2>
        <p class="text-navy-600 text-sm mt-2">
          The VoteChain ledger (VCL) is an append-only log of every significant election event:
          manifest publication, ballot casts, tree head snapshots, tally publication, and fraud
          flags. Each event is cryptographically signed, so any modification is detectable.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          In this POC, the VCL runs on 3 distributed Cloudflare Workers nodes. In a production
          election, VoteChain would span many more independent nodes &mdash; no single party
          could rewrite or suppress events.
        </p>

        <div class="mt-4 flex items-center gap-3">
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">Signature Status</p>
          <span id="vcl-badge" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold bg-navy-100 text-navy-500">
            Checking...
          </span>
        </div>

        <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4" id="vcl-breakdown">
        </div>
      </section>

      <!-- Section 5: Credential Issuance Integrity -->
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="shield" class="text-gold-600" />
          Credential Issuance Integrity
        </h2>
        <p class="text-navy-600 text-sm mt-2">
          Credentials require independent blind Schnorr signatures from multiple registration
          authorities (threshold issuance). No single authority can forge credentials. The voter
          roll commitment sets a public ceiling &mdash; monitors verify that total issuance never
          exceeds the eligible voter count.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          This defense mitigates rogue credential minting: even if one registration authority is
          compromised, they cannot produce valid credentials without cooperation from the threshold
          number of independent issuers.
        </p>

        <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4 text-center">
            <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-1">Issuers</p>
            <p class="font-serif text-2xl text-navy-900 font-bold" id="ci-issuer-count">-</p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4 text-center">
            <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-1">Threshold</p>
            <p class="font-serif text-2xl text-navy-900 font-bold" id="ci-threshold">-</p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4 text-center">
            <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-1">Issued</p>
            <p class="font-serif text-2xl text-navy-900 font-bold" id="ci-issued">-</p>
          </div>
          <div class="rounded-lg border border-navy-200 bg-cream-50 p-4 text-center">
            <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-1">Roll Ceiling</p>
            <p class="font-serif text-2xl text-navy-900 font-bold" id="ci-ceiling">-</p>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-3">
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">Integrity Check</p>
          <span id="ci-badge" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold bg-navy-100 text-navy-500">
            Checking...
          </span>
        </div>
      </section>

      <!-- Section 6: Public Keys -->
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="key" class="text-gold-600" />
          Public Keys
        </h2>
        <p class="text-navy-600 text-sm mt-2">
          These are the public keys used to sign election artifacts. Anyone can use these keys to
          independently verify every signature in the system &mdash; the manifest, STHs, VCL
          events, and cast receipts.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          In a real election, these keys would be published before the election and committed to
          in the manifest. Multiple parties would archive them so that no single authority could
          retroactively change which key was "official."
        </p>

        <div class="mt-4 space-y-4" id="keys-container">
          <p class="text-navy-500 text-sm">Loading keys...</p>
        </div>
      </section>

      <!-- Section 7: What This Proves -->
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="info" class="text-gold-600" />
          What This Proves
        </h2>
        <div class="mt-3 text-navy-700 text-sm space-y-3">
          <ul class="space-y-2">
            <li class="flex items-start gap-2">
              <span class="text-gold-600 mt-0.5 flex-shrink-0"><Icon name="check" size={16} /></span>
              <span><strong>Manifest integrity:</strong> The election configuration has not been altered since it was signed by the election authority.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-gold-600 mt-0.5 flex-shrink-0"><Icon name="check" size={16} /></span>
              <span><strong>Bulletin board consistency:</strong> All ballots are present and unmodified &mdash; the Merkle root computed from all leaves matches the latest signed tree head.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-gold-600 mt-0.5 flex-shrink-0"><Icon name="check" size={16} /></span>
              <span><strong>STH authenticity:</strong> Every signed tree head was produced by the bulletin board authority and has not been tampered with.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-gold-600 mt-0.5 flex-shrink-0"><Icon name="check" size={16} /></span>
              <span><strong>Ledger authenticity:</strong> Every VoteChain ledger event &mdash; manifest publication, ballot cast, tree head, tally, fraud flag &mdash; is cryptographically signed and verifiable.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-gold-600 mt-0.5 flex-shrink-0"><Icon name="check" size={16} /></span>
              <span><strong>Tally correctness:</strong> If a tally has been published, it is signed by the election gateway and anchored on the ledger.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-gold-600 mt-0.5 flex-shrink-0"><Icon name="check" size={16} /></span>
              <span><strong>Credential issuance integrity:</strong> Credentials require threshold signatures from independent registration authorities. Total issuance is bounded by the voter roll commitment and tracked on the ledger.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-gold-600 mt-0.5 flex-shrink-0"><Icon name="check" size={16} /></span>
              <span><strong>Key transparency:</strong> All public keys are available for anyone to download and use for independent verification.</span>
            </li>
          </ul>
        </div>

        <Divider withSeal={false} />

        <div class="rounded-lg border border-gold-300 bg-cream-100 p-4 mt-4">
          <div class="flex items-start gap-3">
            <Icon name="info" class="text-gold-700 mt-0.5" />
            <div>
              <p class="text-navy-800 font-sans text-sm font-semibold">POC Architecture</p>
              <p class="text-navy-700 font-sans text-sm mt-1">
                Cryptographic keys are stored in your browser. VCL audit events are recorded
                on 3 distributed Cloudflare Workers nodes (federal, state, oversight) with
                Durable Object append-only storage and ECDSA P-256 signing. In a real election:
              </p>
              <ul class="text-navy-700 font-sans text-sm mt-1 list-disc ml-5 space-y-1">
                <li>The VoteChain ledger would span more independent nodes across organizations.</li>
                <li>The bulletin board would be a public, replicable service monitored by multiple parties.</li>
                <li>Key pairs would be generated via ceremony, with private keys held in hardware security modules.</li>
                <li>ZK proofs would replace the POC's signature-based eligibility checks.</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    import {
      getDashboardSnapshot,
      verifyManifestSignature,
      verifyAllSthSignatures,
      verifyAllVclEventSignatures,
      verifyBulletinBoardIntegrity,
      getPublicKeys,
      verifyTally,
      verifyCredentialIssuanceIntegrity,
    } from '../../../votechain-poc';
    import type { DashboardSnapshot } from '../../../votechain-poc';

    const checksList = document.getElementById('checks-list') as HTMLElement;
    const overallBanner = document.getElementById('overall-banner') as HTMLElement;
    const overallIcon = document.getElementById('overall-icon') as HTMLElement;
    const overallTitle = document.getElementById('overall-title') as HTMLElement;
    const overallSubtitle = document.getElementById('overall-subtitle') as HTMLElement;
    const manifestBadge = document.getElementById('manifest-badge') as HTMLElement;
    const manifestJson = document.getElementById('manifest-json') as HTMLElement;
    const bbTotalLeaves = document.getElementById('bb-total-leaves') as HTMLElement;
    const bbSthCount = document.getElementById('bb-sth-count') as HTMLElement;
    const bbRootBadge = document.getElementById('bb-root-badge') as HTMLElement;
    const bbComputedRoot = document.getElementById('bb-computed-root') as HTMLElement;
    const bbSthRoot = document.getElementById('bb-sth-root') as HTMLElement;
    const vclBadge = document.getElementById('vcl-badge') as HTMLElement;
    const vclBreakdown = document.getElementById('vcl-breakdown') as HTMLElement;
    const keysContainer = document.getElementById('keys-container') as HTMLElement;
    const ciIssuerCount = document.getElementById('ci-issuer-count') as HTMLElement;
    const ciThreshold = document.getElementById('ci-threshold') as HTMLElement;
    const ciIssued = document.getElementById('ci-issued') as HTMLElement;
    const ciCeiling = document.getElementById('ci-ceiling') as HTMLElement;
    const ciBadge = document.getElementById('ci-badge') as HTMLElement;
    const reverifyBtn = document.getElementById('reverify-btn') as HTMLButtonElement;
    const exportBtn = document.getElementById('export-btn') as HTMLButtonElement;
    const verifyStatusEl = document.getElementById('verify-status') as HTMLElement;

    interface CheckResult {
      id: string;
      label: string;
      ok: boolean;
      detail: string;
    }

    const SVG_NS = 'http://www.w3.org/2000/svg';

    function createLucideSvg(params: {
      size?: number;
      className?: string;
      nodes: Array<{ name: string; attrs: Record<string, string> }>;
    }) {
      const size = params.size ?? 24;
      const svg = document.createElementNS(SVG_NS, 'svg');
      svg.setAttribute('xmlns', SVG_NS);
      svg.setAttribute('width', String(size));
      svg.setAttribute('height', String(size));
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');
      svg.setAttribute('stroke', 'currentColor');
      svg.setAttribute('stroke-width', '2');
      svg.setAttribute('stroke-linecap', 'round');
      svg.setAttribute('stroke-linejoin', 'round');
      if (params.className) svg.setAttribute('class', params.className);

      for (const node of params.nodes) {
        const el = document.createElementNS(SVG_NS, node.name);
        for (const [k, v] of Object.entries(node.attrs)) el.setAttribute(k, v);
        svg.appendChild(el);
      }

      return svg;
    }

    function setBadge(el: HTMLElement, ok: boolean) {
      if (ok) {
        el.className = 'inline-flex items-center rounded-full bg-green-600/15 px-2.5 py-1 text-xs font-semibold text-green-700';
        el.textContent = 'OK';
      } else {
        el.className = 'inline-flex items-center rounded-full bg-red-600/15 px-2.5 py-1 text-xs font-semibold text-red-700';
        el.textContent = 'FAIL';
      }
    }

    function renderChecks(results: CheckResult[]) {
      checksList.replaceChildren();
      for (const r of results) {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between gap-3 border-b border-navy-100 pb-2 pt-2';

        const left = document.createElement('div');
        const name = document.createElement('p');
        name.className = 'font-mono text-xs text-navy-800';
        name.textContent = r.label;
        left.appendChild(name);
        const detail = document.createElement('p');
        detail.className = 'text-xs text-navy-500 mt-0.5';
        detail.textContent = r.detail;
        left.appendChild(detail);

        row.appendChild(left);
        const badge = document.createElement('span');
        setBadge(badge, r.ok);
        row.appendChild(badge);
        checksList.appendChild(row);
      }
    }

    function renderOverall(allOk: boolean) {
      overallBanner.classList.remove('hidden');
      if (allOk) {
        overallBanner.className = 'mt-4 rounded-lg border border-green-300 bg-green-50 p-4';
        overallIcon.replaceChildren(
          createLucideSvg({
            size: 28,
            className: 'text-green-600',
            nodes: [
              { name: 'path', attrs: { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' } },
              { name: 'polyline', attrs: { points: '22 4 12 14.01 9 11.01' } },
            ],
          }),
        );
        overallTitle.textContent = 'All Checks Passed';
        overallTitle.className = 'font-serif font-bold text-lg text-green-800';
        overallSubtitle.textContent = 'Every cryptographic signature and data structure in the election verified successfully.';
        overallSubtitle.className = 'text-sm mt-0.5 text-green-700';
      } else {
        overallBanner.className = 'mt-4 rounded-lg border border-red-300 bg-red-50 p-4';
        overallIcon.replaceChildren(
          createLucideSvg({
            size: 28,
            className: 'text-red-600',
            nodes: [
              { name: 'circle', attrs: { cx: '12', cy: '12', r: '10' } },
              { name: 'line', attrs: { x1: '15', y1: '9', x2: '9', y2: '15' } },
              { name: 'line', attrs: { x1: '9', y1: '9', x2: '15', y2: '15' } },
            ],
          }),
        );
        overallTitle.textContent = 'Issues Detected';
        overallTitle.className = 'font-serif font-bold text-lg text-red-800';
        overallSubtitle.textContent = 'One or more verification checks failed. See details below.';
        overallSubtitle.className = 'text-sm mt-0.5 text-red-700';
      }
    }

    function renderVclBreakdown(events: DashboardSnapshot['events']) {
      const counts: Record<string, number> = {};
      for (const e of events) {
        counts[e.type] = (counts[e.type] || 0) + 1;
      }
      vclBreakdown.replaceChildren();
      for (const [type, count] of Object.entries(counts)) {
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-navy-200 bg-cream-50 p-4 text-center';
        const label = document.createElement('p');
        label.className = 'text-navy-500 font-mono text-[10px] uppercase tracking-wider mb-1';
        label.textContent = type.replace(/_/g, ' ');
        const value = document.createElement('p');
        value.className = 'font-serif text-2xl text-navy-900 font-bold';
        value.textContent = String(count);
        card.appendChild(label);
        card.appendChild(value);
        vclBreakdown.appendChild(card);
      }
    }

    function renderKeys(keys: Awaited<ReturnType<typeof getPublicKeys>>) {
      keysContainer.replaceChildren();

      // JWK-based keys (ECDSA P-256)
      const jwkEntries: Array<[string, { kid: string; alg: string; jwk: JsonWebKey }]> = [
        ['Manifest Signing Key', keys.manifest],
        ['Election Web Gateway (EWG)', keys.ewg],
        ['Bulletin Board (BB)', keys.bb],
        ['VoteChain Ledger (VCL)', keys.vcl],
      ];

      for (const [label, key] of jwkEntries) {
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-navy-200 bg-cream-50 p-4';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between flex-wrap gap-2';

        const title = document.createElement('p');
        title.className = 'text-xs font-mono text-navy-500 uppercase tracking-widest';
        title.textContent = label;

        const meta = document.createElement('p');
        meta.className = 'text-[10px] font-mono text-navy-400';
        meta.textContent = `kid: ${key.kid} | alg: ${key.alg}`;

        header.appendChild(title);

        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'inline-flex items-center gap-1.5 rounded-md border border-navy-200 bg-white px-2.5 py-1.5 text-navy-800 font-sans text-xs font-semibold hover:border-gold-500 hover:shadow-sm transition-all';
        const jwkText = JSON.stringify(key.jwk, null, 2);

        function setCopyIdle() {
          copyBtn.replaceChildren(
            createLucideSvg({
              size: 14,
              nodes: [
                { name: 'rect', attrs: { x: '9', y: '9', width: '13', height: '13', rx: '2', ry: '2' } },
                { name: 'path', attrs: { d: 'M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1' } },
              ],
            }),
            document.createTextNode('Copy JWK'),
          );
        }

        setCopyIdle();
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(jwkText);
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
              setCopyIdle();
            }, 1500);
          } catch {
            copyBtn.textContent = 'Failed';
          }
        });
        header.appendChild(copyBtn);

        card.appendChild(header);
        card.appendChild(meta);

        const pre = document.createElement('pre');
        pre.className = 'mt-2 rounded-lg bg-navy-800 text-cream-100 p-3 overflow-x-auto text-xs leading-relaxed font-mono';
        const code = document.createElement('code');
        code.textContent = jwkText;
        pre.appendChild(code);
        card.appendChild(pre);

        keysContainer.appendChild(card);
      }

      // Issuer keys (threshold registration authorities, secp256k1 compressed points)
      for (const issuer of keys.issuers) {
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-navy-200 bg-cream-50 p-4';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between flex-wrap gap-2';

        const title = document.createElement('p');
        title.className = 'text-xs font-mono text-navy-500 uppercase tracking-widest';
        title.textContent = `Registration Authority #${issuer.index + 1} (${keys.issuer_threshold.t}-of-${keys.issuer_threshold.n})`;

        const meta = document.createElement('p');
        meta.className = 'text-[10px] font-mono text-navy-400';
        meta.textContent = `alg: ${issuer.alg} | format: secp256k1 compressed point (base64url)`;

        header.appendChild(title);

        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'inline-flex items-center gap-1.5 rounded-md border border-navy-200 bg-white px-2.5 py-1.5 text-navy-800 font-sans text-xs font-semibold hover:border-gold-500 hover:shadow-sm transition-all';

        function makeSetIdle(btn: HTMLButtonElement) {
          return () => {
            btn.replaceChildren(
              createLucideSvg({
                size: 14,
                nodes: [
                  { name: 'rect', attrs: { x: '9', y: '9', width: '13', height: '13', rx: '2', ry: '2' } },
                  { name: 'path', attrs: { d: 'M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1' } },
                ],
              }),
              document.createTextNode('Copy'),
            );
          };
        }

        const setIdle = makeSetIdle(copyBtn);
        setIdle();
        const pkValue = issuer.pk;
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(pkValue);
            copyBtn.textContent = 'Copied!';
            setTimeout(setIdle, 1500);
          } catch {
            copyBtn.textContent = 'Failed';
          }
        });
        header.appendChild(copyBtn);

        card.appendChild(header);
        card.appendChild(meta);

        const desc = document.createElement('p');
        desc.className = 'text-xs text-navy-600 mt-2';
        desc.textContent = `Independent issuer for blind Schnorr credential issuance. ${keys.issuer_threshold.t} of ${keys.issuer_threshold.n} must sign for a valid credential.`;
        card.appendChild(desc);

        const pre = document.createElement('pre');
        pre.className = 'mt-2 rounded-lg bg-navy-800 text-cream-100 p-3 overflow-x-auto text-xs leading-relaxed font-mono';
        const code = document.createElement('code');
        code.textContent = pkValue;
        pre.appendChild(code);
        card.appendChild(pre);

        keysContainer.appendChild(card);
      }
    }

    async function runAllChecks() {
      verifyStatusEl.textContent = 'Running all verification checks...';
      reverifyBtn.disabled = true;

      try {
        const [
          snapshot,
          manifestResult,
          sthResult,
          vclResult,
          bbResult,
          keys,
          ciResult,
        ] = await Promise.all([
          getDashboardSnapshot(),
          verifyManifestSignature(),
          verifyAllSthSignatures(),
          verifyAllVclEventSignatures(),
          verifyBulletinBoardIntegrity(),
          getPublicKeys(),
          verifyCredentialIssuanceIntegrity(),
        ]);

        // Check manifest anchored on VCL
        const manifestAnchored = snapshot.events.some(
          (e) => e.type === 'election_manifest_published' && (e.payload as any).manifest_id === snapshot.manifest.manifest_id,
        );

        // Check tally verified (if published)
        let tallyVerified = false;
        let tallyExists = false;
        if (snapshot.tally) {
          tallyExists = true;
          const tallyResult = await verifyTally(snapshot.tally);
          tallyVerified = tallyResult.status === 'ok';
        }

        const checks: CheckResult[] = [
          {
            id: 'manifest_signature',
            label: 'Election manifest signature valid',
            ok: manifestResult.valid,
            detail: `manifest_id: ${manifestResult.manifest_id.slice(0, 16)}... | kid: ${manifestResult.kid}`,
          },
          {
            id: 'all_sth_signatures',
            label: 'All bulletin board tree heads signed',
            ok: sthResult.all_valid,
            detail: `${sthResult.total} STH(s) verified`,
          },
          {
            id: 'all_vcl_signatures',
            label: 'All VoteChain ledger events signed',
            ok: vclResult.all_valid,
            detail: `${vclResult.total} event(s) verified`,
          },
          {
            id: 'bb_merkle_integrity',
            label: 'Merkle root matches latest STH',
            ok: bbResult.valid,
            detail: `tree_size: ${bbResult.tree_size} | root: ${bbResult.computed_root.slice(0, 16)}...`,
          },
          {
            id: 'manifest_anchored',
            label: 'Manifest anchored on VoteChain ledger',
            ok: manifestAnchored,
            detail: manifestAnchored ? 'election_manifest_published event found' : 'No anchor event found',
          },
          {
            id: 'credential_issuance_integrity',
            label: 'Credential issuance within voter roll ceiling',
            ok: ciResult.valid,
            detail: `${ciResult.issuance_count} issued / ${ciResult.voter_roll_total} eligible | ${ciResult.issuer_threshold.t}-of-${ciResult.issuer_threshold.n} issuers required`,
          },
          {
            id: 'tally_verified',
            label: 'Tally verified',
            ok: tallyExists ? tallyVerified : true,
            detail: tallyExists
              ? (tallyVerified ? 'Tally signature and anchor verified' : 'Tally verification failed')
              : 'No tally published yet (OK for in-progress election)',
          },
        ];

        const allOk = checks.every((c) => c.ok);
        renderChecks(checks);
        renderOverall(allOk);

        // Manifest section
        setBadge(manifestBadge, manifestResult.valid);
        manifestJson.textContent = JSON.stringify(snapshot.manifest, null, 2);

        // BB section
        bbTotalLeaves.textContent = String(bbResult.tree_size);
        bbSthCount.textContent = String(sthResult.total);
        setBadge(bbRootBadge, bbResult.valid);
        bbComputedRoot.textContent = bbResult.computed_root || '(empty tree)';
        bbSthRoot.textContent = bbResult.latest_sth_root || '(no STH yet)';

        // VCL section
        setBadge(vclBadge, vclResult.all_valid);
        renderVclBreakdown(snapshot.events);

        // Credential issuance section
        ciIssuerCount.textContent = String(ciResult.issuer_count);
        ciThreshold.textContent = `${ciResult.issuer_threshold.t}/${ciResult.issuer_threshold.n}`;
        ciIssued.textContent = String(ciResult.issuance_count);
        ciCeiling.textContent = ciResult.voter_roll_total.toLocaleString();
        setBadge(ciBadge, ciResult.valid);

        // Keys section
        renderKeys(keys);

        verifyStatusEl.textContent = `Verified: ${new Date().toLocaleString()}`;
      } catch (err) {
        verifyStatusEl.textContent = `Error: ${String(err)}`;
      } finally {
        reverifyBtn.disabled = false;
      }
    }

    reverifyBtn?.addEventListener('click', () => runAllChecks());

    exportBtn?.addEventListener('click', async () => {
      const snapshot = await getDashboardSnapshot();
      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `votechain-audit-package-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Run all checks on page load
    runAllChecks();
  </script>
</BaseLayout>
